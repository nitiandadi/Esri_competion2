import{gn as qn,go as kn,gp as Zn,bY as y,gq as U,gr as lt,gs as N,fD as we,gt as Ye,gu as nt,gv as w,gw as je,gx as ct,r as g,t as v,gy as Un,c4 as dt,gz as K,gA as qe,gB as Kt,gC as ht,gD as Vt,gE as Wn,gF as Bn,gG as Yn,gH as Xn,gI as Jn,g8 as ke,gJ as pt,gK as _e,gL as Qn,m as J,fM as en,gl as Kn,gk as B,gM as It,o as W,gN as it,gO as ei,gP as Ne,gQ as j,gj as tn,gi as ce,e as u,y as f,a as te,aL as nn,bg as G,gR as ee,gS as ut,C as Ze,gT as ti,cR as ni,dP as ii,gU as Re,gV as sn,gW as st,fS as si,v as Xe,f as Je,B as ri,gX as Oe,gY as De,gZ as Le,d9 as Ce,fJ as V,g_ as Z,g$ as de,h0 as ai,h1 as oi,h2 as ft,h3 as gt,h4 as _t,h5 as he,h6 as li,h7 as rn,h8 as ci,c0 as yt,dO as di,aN as hi,bn as pi,h9 as ui,ha as an,hb as fi,l as gi,hc as Ft,hd as _i,c7 as yi,he as mi,hf as vi,dL as on,hg as ln,c1 as Ei,c5 as mt,cQ as cn,c3 as Si,a8 as dn}from"./MapView-d4248bee.js";import{g as wi,h as xi,E as x,Z as Gt}from"./elevationInfoUtils-be893fde.js";import{t as hn,S as Pi}from"./RightAngleQuadVisualElement-7f36d6f3.js";import{d as bi,S as Mt}from"./PointVisualElement-97fe269b.js";import{f as Ri,u as R}from"./viewUtils-653374a2.js";import{k as Ve}from"./index-9ba3f23e.js";import{D as Ht}from"./QueryEngineResult-000a2eb4.js";import{b as L,L as rt,m as $i}from"./EditGeometryOperations-7a18c435.js";import{i as Ti}from"./dehydratedFeatureComparison-0ac2f54e.js";import{U as Li}from"./AnalysisToolBase-c69e0046.js";function Ns(i){let e,t,n=[],s=!1;function r(...a){return s&&e===this&&Oi(a,n)||(t=i.apply(this,a),e=this,n=a,s=!0),t}return r}function Oi(i,e){if(i.length!==e.length)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}let Ci=class extends hn{constructor(e){super(e),this._ray=Zn(),this._isWorldDown=!1,this._start=y(),this._end=U(1,0,0),this._width=1,this._color=lt(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=lt(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=F.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=N.OccludeAndTransparent,this._fadedExtensions=qt,this._laserline=new bi({view:this.view}),this.applyProps(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:(t,n)=>this._recreateObject3DGeometry(t,n),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,we(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),Ye(this._end,e,this._end),nt(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,w(this._start,e)||(we(this._start,e),nt(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,w(this._end,e)||(we(this._end,e),nt(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){je(e,this._color)||(ct(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){je(e,this._innerColor)||(ct(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=g(e)!==g(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(v(e)||v(this._stippleOffColor)||!je(e,this._stippleOffColor))&&(this._stippleOffColor=g(e)?Un(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&g(this._laserlineStyle)&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,g(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===N.OccludeAndTransparentStencil?N.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=dt(e,qt),this.recreateGeometry()}_updateMaterial(){var t,n;const{materialParameters:e}=this;(t=K(this.object3dResources.resources))==null||t.material.setParameters(e),(n=K(this.drapedResources.resources))==null||n.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const t=new qe(this.materialParameters),n=new Array;return this._createObject3DGeometry(t,e,n),{material:t,geometries:n,forEach:s=>{s(t),n.forEach(s)}}}_destroyExternalResources(e){e.geometries=[],e.material.dispose()}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,n){const s=this._createGeometry(e);n.push(s),t.addGeometry(s),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new qe(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const t=this._createGeometry(e);this._updateVerticesDraped(t);const n=new Kt(t,{boundingInfo:t.boundingInfo});return n.computeBoundingSphere(n.transformation,n.boundingSphere),n}_createGeometry(e){const t=this.extensionType===F.FADED,n=t?[y(),y(),y(),y()]:[y(),y()];return ht(e,n,null,t?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=K(this.object3dResources.object);e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this._lineSegment;this._updateVertexAttributesObject3D(e,t),this._laserline.intersectsLine=t}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===F.FADED?this._updateLineSegmentFinite(jt):this._updateLineSegmentInfinite(this._extensionType,jt)}_updateLineSegmentFinite(e){return Vt(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const n=this.view.state.camera;switch(Wn(this._ray,Q),e){case F.LINE:Q.c0=-Number.MAX_VALUE;break;case F.RAY:case F.GROUND_RAY:{const a=this._ray.origin,l=dt(this.view.elevationProvider.getElevation(a[0],a[1],a[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),o=this.view.renderCoordsHelper.getAltitude(a);this._isWorldDown&&o<l&&Bn(Q.ray.direction,Q.ray.direction),this._extensionType===F.GROUND_RAY&&l!=null&&(Q.c1=Math.abs(o-l));break}}if(!Yn(n.frustum,Q))return this._updateLineSegmentFinite(t);const s=Xn(Q,ne),r=Jn(Q,Di);return Vt(s,r,t)}_updateVertexAttributesObject3D(e,t){var r;const n=(r=e.geometries[0].getMutableAttribute(ke.POSITION))==null?void 0:r.data;if(!n)return;let s=0;for(const a of this._lineVertices(t))n[s++]=a[0],n[s++]=a[1],n[s++]=a[2];e.geometryVertexAttrsUpdated(e.geometries[0])}_updateVertexAttributesDraped(e,t){var r;const n=(r=e.getMutableAttribute(ke.POSITION))==null?void 0:r.data;if(!n)return;let s=0;for(const a of this._lineVertices(t))n[s++]=a[0],n[s++]=a[1],n[s++]=pt;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===F.FADED?(yield _e(e,-this.fadedExtensions.start,ne),yield _e(e,0,ne),yield _e(e,1,ne),yield _e(e,1+this.fadedExtensions.end,ne)):(yield _e(e,0,ne),yield _e(e,1,ne))}};const Q=qn(),ne=y(),Di=y(),jt=kn();var F;(function(i){i[i.LINE=0]="LINE",i[i.RAY=1]="RAY",i[i.GROUND_RAY=2]="GROUND_RAY",i[i.FADED=3]="FADED"})(F||(F={}));const zt=1/3,qt={start:zt,end:zt};let Ai=class extends hn{constructor(e){super(e),this._location=y(),this._direction=U(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=lt(1,0,1,1),this._renderOccluded=N.OccludeAndTransparent,this.applyProps(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyObject3DResources(t),recreateGeometry:(t,n)=>this._recreateObject3DGeometry(t,n),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyDrapedResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}get location(){return this._location}set location(e){w(this._location,e)||(we(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){w(this._direction,e)||(we(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){Qn(this._direction,Ye(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){je(e,this._color)||(ct(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new qe(this.materialParameters),n=new Array;return this._createObject3DGeometry(t,e,n),{material:t,geometries:n,forEach:s=>{s(t),n.forEach(s)}}}_destroyObject3DResources(e){e.geometries.length=0,e.material.dispose()}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,n){const[s,r]=this._createGeometries(e);t.addGeometry(s),t.addGeometry(r),n.push(s),n.push(r),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new qe(this.materialParameters),t=J(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[],e.material.dispose()}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=this._createGeometries(e);this._updateVerticesDraped(t);const n=t.map(s=>new Kt(s,{boundingInfo:s.boundingInfo}));for(const s of n)s.computeBoundingSphere(s.transformation,s.boundingSphere);return n}_createGeometries(e){return[ht(e,[y(),y()]),ht(e,[y(),y()])]}_updateMaterial(){var t,n;const{materialParameters:e}=this;(t=K(this.object3dResources.resources))==null||t.material.setParameters(e),(n=K(this.drapedResources.resources))==null||n.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=K(this.object3dResources.object);e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,Fe),en(k,this.location,this.direction),t.projectToScreen(k,ye),Kn(ye,B(ye,ye,Fe)),this._updateVertexAttributesObject3D(t,e,0,Fe,ye,1),this._updateVertexAttributesObject3D(t,e,1,Fe,ye,-1)}_updateVertexAttributesObject3D(e,t,n,s,r,a){var h;const l=t.geometries[n],o=(h=l.getMutableAttribute(ke.POSITION))==null?void 0:h.data;if(!o)return;const{start:c,end:d}=this._computeStartEnd(r,s,a,this.offset,this.width,this.length);e.unprojectFromScreen(It(c),k),o[0]=k[0],o[1]=k[1],o[2]=k[2],e.unprojectFromScreen(It(d),k),o[3]=k[0],o[4]=k[1],o[5]=k[2],t.geometryVertexAttrsUpdated(l)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:n}}}=this,{location:s,width:r,length:a,offset:l}=this,o=Ni;o.spatialReference=W(t.renderer.spatialReference),o.x=s[0],o.y=s[1];const c=t.overlayPixelSizeInMapUnits(o)*n,d=r*c,h=a*c,p=l*c;this._updateVertexAttributesDraped(e[0],d,h,p,-1),this._updateVertexAttributesDraped(e[1],d,h,p,1)}_updateVertexAttributesDraped(e,t,n,s,r){var h;const a=(h=e.getMutableAttribute(ke.POSITION))==null?void 0:h.data;if(!a)return;const{location:l,direction:o}=this,{start:c,end:d}=this._computeStartEnd(o,l,r,s,t,n);a[0]=c[0],a[1]=c[1],a[2]=pt,a[3]=d[0],a[4]=d[1],a[5]=pt,e.invalidateBoundingInfo()}_computeStartEnd(e,t,n,s,r,a){const l=it(kt,ei(kt,e[1]*n,e[0]*-n),s+r/2),o=Ne(Ie,Ne(Ie,Ne(Ie,t,it(Ie,e,a/2)),l),l);return{start:o,end:Ne(Zt,o,it(Zt,e,-a))}}};const k=y(),kt=j(),Ie=j(),Zt=j(),Fe=tn(),ye=tn(),Ni=ce(0,0,void 0,null);let M=class extends nn{constructor(){super(...arguments),this.enabled=!0}};u([f({type:Boolean})],M.prototype,"enabled",void 0),M=u([te("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],M);let E=class extends nn{constructor(e){super(e),this.lineSnapper=new M,this.parallelLineSnapper=new M,this.rightAngleSnapper=new M,this.rightAngleTriangleSnapper=new M,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThreshold=.1,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new G([255,127,0]),this.orangeTransparent=new G([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};u([f({type:M,constructOnly:!0,nonNullable:!0,json:{write:!0}})],E.prototype,"lineSnapper",void 0),u([f({type:M,constructOnly:!0,nonNullable:!0,json:{write:!0}})],E.prototype,"parallelLineSnapper",void 0),u([f({type:M,constructOnly:!0,nonNullable:!0,json:{write:!0}})],E.prototype,"rightAngleSnapper",void 0),u([f({type:M,constructOnly:!0,nonNullable:!0,json:{write:!0}})],E.prototype,"rightAngleTriangleSnapper",void 0),u([f({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],E.prototype,"shortLineThreshold",void 0),u([f({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],E.prototype,"distance",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],E.prototype,"pointThreshold",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],E.prototype,"intersectionParallelLineThreshold",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],E.prototype,"parallelLineThreshold",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],E.prototype,"verticalLineThreshold",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],E.prototype,"touchSensitivityMultiplier",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],E.prototype,"pointOnLineThreshold",void 0),u([f({type:G,nonNullable:!0})],E.prototype,"orange",void 0),u([f({type:G,nonNullable:!0})],E.prototype,"orangeTransparent",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],E.prototype,"lineHintWidthReference",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],E.prototype,"lineHintWidthTarget",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],E.prototype,"lineHintFadedExtensions",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],E.prototype,"parallelLineHintWidth",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],E.prototype,"parallelLineHintLength",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],E.prototype,"parallelLineHintOffset",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],E.prototype,"rightAngleHintSize",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],E.prototype,"rightAngleHintOutlineSize",void 0),u([f({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],E.prototype,"satisfiesConstraintScreenThreshold",void 0),E=u([te("esri.views.interactive.snapping.Settings.Defaults")],E);const m=new E;var b;(function(i){i[i.FEATURE=1]="FEATURE",i[i.SELF=2]="SELF",i[i.ALL=3]="ALL"})(b||(b={}));function Ms(i){return i}function pn(i){return ee(i)}function Vi(i,e,t){return U(i,e,t)}function S(i,e,t){return v(i)?null:Te(t.coordinateHelper.vectorToDehydratedPoint(i,Ii),e,t)}function Te(i,e,t){if(v(i))return null;if(v(e))return U(i.x,i.y,i.z??0);if(e.type==="2d")return U(i.x,i.y,0);const{elevationInfo:n}=t,s=wi(e,i,n,x)??0;return U(i.x,i.y,s)}function Ut(i,e,{z:t,m:n,spatialReference:s,elevationInfo:r}){if(t==null&&n==null){const o=ce(i[0],i[1],void 0,s);return n!=null&&(o.m=n,o.hasM=!0),o}if(v(e)||e.type==="2d"){const o=ce(i[0],i[1],t,s);return n!=null&&(o.m=n,o.hasM=!0),o}const a=xi(e,i,s,x,r)??0,l=ce(i[0],i[1],a,s);return n!=null&&(l.m=n,l.hasM=!0),l}function Wt(i,e){return ce(i[0],i[1],i[2],e)}const Ii=ce(0,0,0,null),Hs={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},Bt={toggle:"Control"};function pe(i,e){const t=i.x-e.x,n=i.y-e.y;return t*t+n*n}function Fi(i,e){return Math.sqrt(pe(i,e))}function Pt(i,e){e.sort((t,n)=>ut(t.targetPoint,i)-ut(n.targetPoint,i))}var O;function js({point:i,distance:e,types:t,coordinateHelper:{spatialReference:n}},s,r){return{point:ce(i[0],i[1],i[2],n.toJSON()),mode:s,distance:e,types:t,query:g(r)?r.toJSON():{where:"1=1"}}}function Ue(i,e,t){return{left:S(i.leftVertex.pos,e,t),right:S(i.rightVertex.pos,e,t)}}function zs(i){return i.createQuery()}function qs(i,e=()=>{}){const t=J(()=>({view:i.view,snappingOptions:i.snappingOptions}),({view:n,snappingOptions:s})=>{const r="snapping-toggle",a=ti.TOOL;if(i.removeHandles(r),n&&g(s)){const l=[n.on("key-down",o=>{o.key!==Bt.toggle||o.repeat||(s.enabledToggled=!0,e())},a),n.on("key-up",o=>{o.key===Bt.toggle&&(s.enabledToggled=!1,e())},a),n.on("pointer-move",o=>{const c=o.native.ctrlKey;s.enabledToggled!==c&&(s.enabledToggled=c,e())},a)];i.addHandles(l,r)}},Ze);i.addHandles(t)}(function(i){i[i.TARGET=0]="TARGET",i[i.REFERENCE=1]="REFERENCE",i[i.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(O||(O={}));let Ae=class{constructor(e,t){this.isDraped=e,this.domain=t}},un=class fn extends Ae{constructor(e,t,n=b.ALL){super(t,n),this.intersectionPoint=e}equals(e){return e instanceof fn&&w(this.intersectionPoint,e.intersectionPoint)}},D=class gn extends Ae{constructor(e,t,n,s,r=b.ALL,a=!0,l=!0){super(s,r),this.type=e,this.lineStart=t,this.lineEnd=n,this.fadeLeft=a,this.fadeRight=l}equals(e){return e instanceof gn&&this.type===e.type&&w(this.lineStart,e.lineStart)&&w(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return ni(this.lineStart,this.lineEnd)}},_n=class yn extends Ae{constructor(e,t,n,s=b.ALL){super(n,s),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof yn&&w(this.lineStart,e.lineStart)&&w(this.lineEnd,e.lineEnd)}},Gi=class mn extends Ae{constructor(e,t,n){super(t,n),this.point=e}equals(e){return e instanceof mn&&w(this.point,e.point)}},bt=class vn extends Ae{constructor(e,t,n,s,r=b.ALL){super(s,r),this.previousVertex=e,this.centerVertex=t,this.nextVertex=n}equals(e){return e instanceof vn&&w(this.previousVertex,e.previousVertex)&&w(this.centerVertex,e.centerVertex)&&w(this.nextVertex,e.nextVertex)}},Mi=class{draw(e,t){const n=this._getUniqueHints(e),s=this.sortUniqueHints(n),r=[];for(const a of s)a instanceof un&&r.push(this.visualizeIntersectionPoint(a,t)),a instanceof D&&r.push(this.visualizeLine(a,t)),a instanceof _n&&r.push(this.visualizeParallelSign(a,t)),a instanceof bt&&r.push(this.visualizeRightAngleQuad(a,t)),a instanceof Gi&&r.push(this.visualizePoint(a,t));return ii(r)}sortUniqueHints(e){return e}_getUniqueHints(e){const t=[];for(const n of e){let s=!0;for(const r of t)if(n.equals(r)){s=!1;break}s&&t.push(n)}return t}},Us=class extends Mi{sortUniqueHints(e){return e.sort((t,n)=>(n instanceof D?n.length:0)-(t instanceof D?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:n,view:s}=t;return Re(new Mt({view:s,primitive:"circle",geometry:Wt(e.intersectionPoint,n),elevationInfo:e.isDraped?Gt:x,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:G.toUnitRGBA(m.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,t){const{view:n,spatialReference:s}=t,r=this._alignPoint(e.point,e.domain,t);return Re(new Mt({view:n,primitive:"circle",geometry:Wt(r,s),elevationInfo:this._hintElevationInfo(e,t),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:G.toUnitRGBA(m.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,t){const{view:n,spatialReference:s}=t,r=this._alignPoint(e.lineStart,e.domain,t),a=this._alignPoint(e.lineEnd,e.domain,t);return Re(this._createLineSegmentHint(e.type,r,a,s,this._hintElevationInfo(e,t),n,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:n,spatialReference:s}=t,{isDraped:r}=e,a=this._hintElevationInfo(e,t),l=this._alignPoint(e.lineStart,e.domain,t),o=this._alignPoint(e.lineEnd,e.domain,t),c=ie(l,s,a,n,r),d=ie(o,s,a,n,r),h=sn(d,c,d,.5),p=new Ai({view:n,attached:!1,offset:m.parallelLineHintOffset,length:m.parallelLineHintLength,width:m.parallelLineHintWidth,color:G.toUnitRGBA(m.orange),location:h,renderOccluded:r?N.OccludeAndTransparent:N.Opaque,isDraped:r,renderGroup:st.SnappingHint});return p.setDirectionFromPoints(c,h),p.attached=!0,Re(p)}visualizeRightAngleQuad(e,t){const{view:n,spatialReference:s}=t,r=this._hintElevationInfo(e,t),{isDraped:a}=e,l=this._alignPoint(e.previousVertex,e.domain,t),o=this._alignPoint(e.centerVertex,e.domain,t),c=this._alignPoint(e.nextVertex,e.domain,t),d=ie(l,s,r,n,a),h=ie(o,s,r,n,a),p=ie(c,s,r,n,a);return Re(new Pi({view:n,attached:!0,color:a?G.toUnitRGBA(m.orangeTransparent):G.toUnitRGBA(m.orange),renderOccluded:a?N.OccludeAndTransparent:N.Transparent,outlineRenderOccluded:a?N.OccludeAndTransparent:N.Opaque,outlineColor:G.toUnitRGBA(m.orange),outlineSize:m.rightAngleHintOutlineSize,size:m.rightAngleHintSize,isDraped:a,geometry:{previous:d,center:h,next:p},renderGroup:st.SnappingHint}))}_createLineSegmentHint(e,t,n,s,r,a,l=!1,o=!0,c=!0){const d=ie(t,s,r,a,l),h=ie(n,s,r,a,l),p=new Ci({view:a,extensionType:F.FADED,start:d,end:h,isDraped:l,color:G.toUnitRGBA(m.orange),renderOccluded:l?N.OccludeAndTransparent:N.Opaque,renderGroup:st.SnappingHint});switch(e){case O.TARGET:p.width=m.lineHintWidthTarget,p.fadedExtensions={start:0,end:m.lineHintFadedExtensions};break;case O.REFERENCE_EXTENSION:p.width=m.lineHintWidthReference,p.fadedExtensions={start:0,end:0};break;case O.REFERENCE:p.width=m.lineHintWidthReference,p.fadedExtensions={start:o?m.lineHintFadedExtensions:0,end:c?m.lineHintFadedExtensions:0}}return p.attached=!0,p}_alignPoint(e,t,n){const s=this._getSelfSnappingZ(t,n);return v(s)?e:Vi(e[0],e[1],s)}_hintElevationInfo(e,t){return g(this._getSelfSnappingZ(e.domain,t))?W(t.selfSnappingZ).elevationInfo:e.isDraped?Gt:x}_getSelfSnappingZ(e,{selfSnappingZ:t}){return e===b.SELF&&g(t)?t.value:null}};function ie(i,e,t,n,s,r=y()){if(s){const a=n.basemapTerrain.overlayManager.renderer.spatialReference;si(i,e,r,a)}else Ri(i,e,t,n,r);return r}let re=class extends Xe{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};u([f({constructOnly:!0})],re.prototype,"layer",void 0),u([f()],re.prototype,"enabled",void 0),u([f()],re.prototype,"updating",void 0),u([f()],re.prototype,"availability",void 0),re=u([te("esri.views.interactive.snapping.FeatureSnappingLayerSource")],re);const En=re;let C=class extends Xe{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new Je,this.distance=m.distance,this.touchSensitivityMultiplier=m.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};u([f()],C.prototype,"enabled",void 0),u([f()],C.prototype,"enabledToggled",void 0),u([f()],C.prototype,"selfEnabled",void 0),u([f()],C.prototype,"featureEnabled",void 0),u([f({type:Je.ofType(En)})],C.prototype,"featureSources",void 0),u([f()],C.prototype,"distance",void 0),u([f()],C.prototype,"touchSensitivityMultiplier",void 0),u([f({readOnly:!0})],C.prototype,"effectiveEnabled",null),u([f({readOnly:!0})],C.prototype,"effectiveSelfEnabled",null),u([f({readOnly:!0})],C.prototype,"effectiveFeatureEnabled",null),C=u([te("esri.views.interactive.snapping.SnappingOptions")],C);const Sn=C;function Hi(i,e){const t=new Sn({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:(e==null?void 0:e.distance)??m.distance,touchSensitivityMultiplier:(e==null?void 0:e.touchSensitivityMultiplier)??m.touchSensitivityMultiplier});return{...J(()=>{var n,s;return((s=(n=i.map)==null?void 0:n.allLayers)==null?void 0:s.toArray())??[]},n=>{t.featureSources=new Je(n.map(s=>new En({layer:s,enabled:!0})))},ri),options:t}}function vt({start:i,end:e,type:t},n,s){const r=[],a=B(ue,e,i),l=B(Pe,i,n),o=Oe(a),c=2*De(a,l),d=c*c-4*o*(Oe(l)-s*s);if(d===0){const h=-c/(2*o);(t===z.PLANE||h>=0)&&r.push(Le(j(),i,a,h))}else if(d>0){const h=Math.sqrt(d),p=(-c+h)/(2*o);(t===z.PLANE||p>=0)&&r.push(Le(j(),i,a,p));const _=(-c-h)/(2*o);(t===z.PLANE||_>=0)&&r.push(Le(j(),i,a,_))}return r}function Et(i,e){const t=i.start,n=i.end,s=B(ue,n,t),r=Ce(Pe,-s[1],s[0],0),a=e.start,l=e.end,o=V($t,l,a),c=Z(o,r),d=Ce(bn,t[0],t[1],0),h=V(Rn,d,a),p=Z(h,r);if(Math.abs(c)<H)return[];const _=de($n,a,o,p/c);if(e.type===L.RAY){const $=V(Be,_,a);if(Z($,o)<-H)return[]}if(i.type===z.HALF_PLANE){const $=ai(Be,_,t);if(De($,s)<-H)return[]}return[ee(_)]}function St(i,e){return wt(We(Tt,e[2],i),e)}function wn(i,e){const n=Pn(We(Tt,0,i),We(qi,0,e)),s=[];for(const r of n)s.push(oi(r));return s}function xn(i,e){return Rt(i,We(Tt,i[2],e))}function ji(i,e,t){const n=B(ue,i,e),s=t/li(n),r=Le(y(),e,n,s);return r[2]=i[2],r}function Rt(i,{start:e,end:t,type:n}){const s=V(ue,i,e),r=V(Pe,t,e),a=Z(s,r)/Z(r,r);return de(y(),e,r,n===L.RAY?Math.max(a,0):a)}function Yt({start:i,end:e,type:t},n,s){const r=[],a=Ye(ue,e,i),l=B(Pe,i,n),o=Oe(a),c=2*De(a,l),d=c*c-4*o*(Oe(l)-s*s);if(d===0){const h=-c/(2*o);(t===L.LINE||h>=0)&&r.push(de(y(),i,a,h))}else if(d>0){const h=Math.sqrt(d),p=(-c+h)/(2*o);(t===L.LINE||p>=0)&&r.push(de(y(),i,a,p));const _=(-c-h)/(2*o);(t===L.LINE||_>=0)&&r.push(de(y(),i,a,_))}return r}function Pn(i,e){const t=i.start,n=i.end,s=e.start,r=e.end,a=V(ue,n,t),l=V(Pe,r,s),o=V($t,s,t),c=ft(bn,a,l),d=Z(o,c);if(!gt(d,0,H))return[];const h=_t(c);if(gt(h,0,H))return[];const p=ft(Rn,o,l),_=Z(p,c)/h,$=de($n,t,a,_);if(i.type===L.RAY){const P=V(Be,$,t);if(Z(a,P)<-H)return[]}if(e.type===L.RAY){const P=V(Be,$,s);if(Z(l,P)<-H)return[]}return[ee($)]}function wt({start:i,end:e,type:t},n){const s=V(ue,n,i),r=V(Pe,e,i),a=ft($t,r,s);if(_t(a)/_t(r)<H)switch(t){case L.LINE:return[ee(n)];case L.RAY:return Z(r,s)<-H?[]:[ee(n)]}return[]}function Xt(i,e,t){return gt(he(t,i),e*e,H)?[ee(t)]:[]}function We(i,e,{start:t,end:n,type:s}){return Ce(i.start,t[0],t[1],e),Ce(i.end,n[0],n[1],e),i.type=zi[s],i}var z;(function(i){i[i.PLANE=0]="PLANE",i[i.HALF_PLANE=1]="HALF_PLANE"})(z||(z={}));const zi={[z.PLANE]:L.LINE,[z.HALF_PLANE]:L.RAY},H=1e-6,ue=y(),Pe=y(),$t=y(),bn=y(),Rn=y(),$n=y(),Be=y(),Tt={start:y(),end:y(),type:L.LINE},qi={start:y(),end:y(),type:L.LINE};let fe=class{intersect(e){return Wi(this,e)}},ki=class extends fe{constructor(e){super(),this.point=e}equals(e){return Ee(e)&&w(this.point,e.point)}closestTo(){return pn(this.point)}},Tn=class extends fe{constructor(e,t,n){super(),this.start=e,this.end=t,this.type=n,this.lineLike={start:this.start,end:this.end,type:this.type}}equals(e){return ae(e)&&this.type===e.type&&w(this.start,e.start)&&w(this.end,e.end)}closestTo(e){const t=Rt(e,this.lineLike);return t}},Zi=class extends Tn{constructor(e,t){super(e,t,L.LINE)}};class Qe extends fe{constructor(e,t,n){super(),this.intersection=e,this.first=t,this.second=n}equals(e){return e instanceof Qe&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(){return pn(this.intersection)}}let at=class Ln extends fe{constructor(e,t,n){super(),this.basePoint=e,this.first=t,this.second=n}equals(e){return e instanceof Ln&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(e){const t=this.basePoint;return U(t[0],t[1],e[2])}},On=class extends fe{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return Se(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const t=ji(e,this.center,this.radius);return t}},Lt=class extends fe{constructor(e,t,n){super(),this.start=e,this.end=t,this.type=n,this.planeLike={start:e,end:t,type:n}}equals(e){return oe(e)&&this.type===e.type&&w(this.start,e.start)&&w(this.end,e.end)}closestTo(e){return xn(e,this.planeLike)}closestEndTo(e){const{start:t,end:n}=this;return Math.sign(De(B(Yi,n,t),B(Xi,e,t)))>0?n:t}};class Cn extends Lt{constructor(e,t){super(e,t,z.HALF_PLANE)}}let Dn=class extends Lt{constructor(e,t){super(e,t,z.PLANE)}},An=class extends fe{constructor(e,t,n){super(),this.start=e,this.end=t,this.getZ=n,this.planeLike={start:e,end:t,type:z.HALF_PLANE}}equals(e){return le(e)&&w(this.start,e.start)&&w(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return Ui(this,e)}addIfOnTheGround(e,t){for(const n of t){const s=dt(this.getZ(n[0],n[1],n[2]),0);Math.abs(n[2]-s)<H&&(n[2]=s,e.push(n))}}};function Ui(i,e){const t=xn(e,i.planeLike);return t[2]=K(i.getZ(e[0],e[1],e[2]))??Nn,t}function Wi(i,e){let t=[];if(Ee(i)){const{point:n}=i;ae(e)?t=wt(e.lineLike,n):Se(e)?t=Xt(e.center,e.radius,n):oe(e)?t=St(e.planeLike,n):le(e)&&(t=$e(e,i))}else if(ae(i)){const{lineLike:n}=i;Ee(e)?t=wt(n,e.point):ae(e)?t=Pn(n,e.lineLike):Se(e)?t=Yt(n,e.center,e.radius):oe(e)?t=Et(e.planeLike,n):le(e)&&(t=$e(e,i))}else if(Se(i)){const{center:n,radius:s}=i;if(ae(e))t=Yt(e.lineLike,n,s);else if(Ee(e))t=Xt(n,s,e.point);else{if(oe(e))return vt(e.planeLike,n,s).map(r=>new at(r,i,e));le(e)&&(t=$e(e,i))}}else if(oe(i)){const{planeLike:n}=i;if(oe(e))return wn(n,e.planeLike).map(s=>new at(s,i,e));if(Ee(e))t=St(n,e.point);else if(ae(e))t=Et(n,e.lineLike);else{if(Se(e))return vt(n,e.center,e.radius).map(s=>new at(s,i,e));le(e)&&(t=$e(e,i))}}else le(i)&&(t=$e(i,e));return Bi(t,i,e)}function $e(i,e){const{planeLike:t,getZ:n}=i,s=[];if(Ee(e))i.addIfOnTheGround(s,St(t,e.point));else if(ae(e))i.addIfOnTheGround(s,Et(t,e.lineLike));else if(Se(e))for(const[r,a]of vt(t,e.center,e.radius)){const l=n(r,a,0);g(l)&&s.push(U(r,a,l))}else if(oe(e)||le(e))for(const[r,a]of wn(t,e.planeLike)){const l=K(n(r,a,0))??Nn;s.push(U(r,a,l))}return s}function Bi(i,e,t){return i.map(n=>new Qe(n,e,t))}function Ee(i){return i instanceof ki}function ae(i){return i instanceof Tn}function Se(i){return i instanceof On}function oe(i){return i instanceof Lt}function le(i){return i instanceof An}const Yi=j(),Xi=j(),Nn=0;class be{constructor(e,t,n,s){this.targetPoint=e,this.constraint=t,this.isDraped=n,this.domain=s}}let Ot=class extends be{constructor({targetPoint:e,objectId:t,constraint:n,isDraped:s}){super(e,n,s,b.FEATURE),this.objectId=t}},Ji=class extends Ot{constructor(e){super({...e,isDraped:!0,constraint:new An(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new D(O.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},Qi=class extends Ot{constructor(e){super({...e,constraint:new Zi(e.edgeStart,e.edgeEnd)})}get hints(){return[new D(O.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}};class Vn extends be{constructor({targetPoint:e,constraint:t,previousVertex:n,otherVertex:s,otherVertexType:r,objectId:a,isDraped:l}){super(e,t,l,b.SELF),this.previousVertex=n,this.otherVertex=s,this.otherVertexType=r,this.objectId=a}get hints(){const e=this.previousVertex,t=this.otherVertexType===xe.CENTER?this.otherVertex:this.targetPoint,n=this.otherVertexType===xe.CENTER?this.targetPoint:this.otherVertex;return[new D(O.TARGET,t,n,this.isDraped,this.domain),new D(O.REFERENCE,e,t,this.isDraped,this.domain),new bt(this.previousVertex,t,n,this.isDraped,this.domain)]}}var xe;(function(i){i[i.NEXT=0]="NEXT",i[i.CENTER=1]="CENTER"})(xe||(xe={}));let Y=class extends rn{get updating(){return ci(this.snappingSources,({snappingSource:e})=>e.updating)||this.updatingHandles.updating}get snappingSources(){const e=this._get("snappingSources")||new Map,t=new Map;if(g(this.options)&&g(this.options.featureSources))for(const n of this.options.featureSources.items){const s=n.layer.uid,r=e.get(s);if(r){e.delete(s),t.set(s,r);continue}if(!n.layer.loaded){this.updatingHandles.addPromise(n.layer.load());continue}const a=this._createSourceInfo(n);g(a)&&t.set(s,a)}for(const[,n]of e)n.destroy();return t}constructor(e){super(e),this.options=null,this._domain=b.FEATURE,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),yt),g(this.view)&&this.handles.add([this.view.on("layerview-create",e=>this._updateLayerView(e.layer,e.layerView)),this.view.on("layerview-destroy",e=>this._updateLayerView(e.layer,null))])}_updateLayerView(e,t){for(const[,n]of this.snappingSources)n.snappingSource.layerSource.layer===e&&(n.layerView=t)}destroy(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()}async fetchCandidates(e,t,n,s){var c;if(!(t&this._domain)||v(this.options)||!this.options.effectiveFeatureEnabled)return[];const r=[],a=this._computeScreenSizeDistanceParameters(e,n),l={distance:a,mode:((c=W(this.view))==null?void 0:c.type)??"2d",point:e,coordinateHelper:n.coordinateHelper,types:this._types};for(const[,{snappingSource:d,layerView:h}]of this.snappingSources)!d.layerSource.enabled||g(h)&&h.suspended||r.push(d.fetchCandidates(l,s).then(p=>p.filter(_=>!this._candidateIsExcluded(d,_,n.excludeFeature))));const o=(await di(r)).flat();return this._addRightAngleCandidates(o,e,a,n),hi(s),Pt(e,o),o}_addRightAngleCandidates(e,t,n,s){var h,p,_,$,P,T,A,ge;const r=g(s.vertexHandle)?(p=(h=s.vertexHandle.rightEdge)==null?void 0:h.rightVertex)==null?void 0:p.pos:g(s.editGeometryOperations)&&s.editGeometryOperations.data.type==="polygon"?($=W((_=s.editGeometryOperations.data.components[0])==null?void 0:_.getFirstVertex()))==null?void 0:$.pos:null,a=g(s.vertexHandle)?(T=(P=s.vertexHandle.leftEdge)==null?void 0:P.leftVertex)==null?void 0:T.pos:g(s.editGeometryOperations)?(ge=W((A=s.editGeometryOperations.data.components[0])==null?void 0:A.getLastVertex()))==null?void 0:ge.pos:null,{view:l}=this,o=S(r,l,s),c=S(a,l,s),d=e.length;for(let q=0;q<d;q++)this._addRightAngleCandidate(e[q],c,t,n,e),this._addRightAngleCandidate(e[q],o,t,n,e)}_addRightAngleCandidate(e,t,n,s,r){if(v(t)||!es(e))return;const a=e.constraint.closestTo(t),l=(a[0]-n[0])/s.x,o=(a[1]-n[1])/s.y,{start:c,end:d}=e.constraint;if(l*l+o*o<=1){const h=new Vn({targetPoint:a,otherVertex:t,otherVertexType:xe.NEXT,previousVertex:he(a,c)>he(a,d)?c:d,constraint:new Cn(t,a),objectId:e.objectId,isDraped:e.isDraped});r.push(h)}}_computeScreenSizeDistanceParameters(e,t){let n=g(this.options)?this.options.distance*(t.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return v(this.view)?{x:n,y:n,z:n,distance:n}:this.view.type==="2d"?(n*=this.view.resolution,{x:n,y:n,z:n,distance:n}):this._computeScreenSizeDistanceParameters3D(e,n,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,n,s){const{spatialReference:r}=s;n.renderCoordsHelper.toRenderCoords(e,r,Jt);const a=n.state.camera.computeScreenPixelSizeAt(Jt),l=a*n.renderCoordsHelper.unitInMeters/n.mapCoordsHelper.unitInMeters,o=t*l,c=R(e,r,x,n),d=c?ot(c,e,l,0,0,n,s):0,h=c?ot(c,e,0,l,0,n,s):0,p=c?ot(c,e,0,0,l,n,s):0;return{x:d===0?0:o/d,y:h===0?0:o/h,z:p===0?0:o/p,distance:a*t}}get _types(){return Ht.EDGE|Ht.VERTEX}_candidateIsExcluded(e,t,n){if(v(n))return!1;const s=this._getCandidateObjectId(t);if(v(s))return!1;const r=e.layerSource.layer;return r.type==="graphics"?n.uid===s:n.sourceLayer===r&&!(!n.attributes||!("objectIdField"in r))&&n.attributes[r.objectIdField]===s}_getCandidateObjectId(e){return e instanceof Ot?e.objectId:null}_createSourceInfo(e){const t=this._createFeatureSnappingSourceType(e);if(v(t))return null;if("loading"in t)return this.updatingHandles.addPromise(t.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const n=g(this.view)?this.view.allLayerViews.find(s=>s.layer===e.layer):null;return new Ki(t.source,n)}_createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}_createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;if(v(t)||t.type!=="3d")return null;const n=this._getSourceModule("scene");return g(n.module)?{source:new n.module.SceneLayerSnappingSource({layerSource:e,view:t})}:{loading:n.loader}}_createFeatureSnappingSourceFeatureLayer(e){var t;switch((t=e.layer.source)==null?void 0:t.type){case"feature-layer":case"oriented-imagery":{const n=this._getSourceModule("featureService");return g(n.module)?{source:new n.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:n.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(e.layer.geometryType==="mesh")return null;const n=this._getSourceModule("featureCollection");return g(n.module)?{source:new n.module.FeatureCollectionSnappingSource({layerSource:e,view:this.view})}:{loading:n.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(e){const t=this._getSourceModule("graphics");return g(t.module)?{source:new t.module.GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}_createFeatureSnappingSourceMapNotesLayer(e){const t=this._getSourceModule("notes");return g(t.module)?{source:new t.module.GraphicsSnappingSource({getGraphicsLayers:()=>g(e.layer.sublayers)?e.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}_getSourceModule(e){const t=this._sourceModules[e];if(v(t.loader)){const n=this._loadSourceModule(e).then(s=>{t.module=s});return t.loader=n,{module:t.module,loader:n}}return{module:t.module,loader:t.loader}}_loadSourceModule(e){const t=this.updatingHandles;switch(e){case"featureService":return t.addPromise(Ve(()=>import("./FeatureServiceSnappingSource-e3565068.js"),["assets/FeatureServiceSnappingSource-e3565068.js","assets/MapView-d4248bee.js","assets/index-9ba3f23e.js","assets/index-fecf00a2.css","assets/elevationInfoUtils-be893fde.js","assets/queryEngineUtils-d12f7e09.js","assets/VertexSnappingCandidate-c90144a6.js","assets/TileTreeDebugger-254da205.js","assets/RightAngleQuadVisualElement-7f36d6f3.js","assets/VisualElement-62e5dd07.js","assets/VisualElementResources-d63a6ee6.js","assets/PointVisualElement-97fe269b.js","assets/viewUtils-653374a2.js","assets/QueryEngineResult-000a2eb4.js","assets/WhereClause-34fcc82f.js","assets/executionError-fb3f283a.js","assets/utils-5fb83578.js","assets/ClassBreaksDefinition-6b9f5256.js","assets/projectionSupport-96272605.js","assets/json-48e3ea08.js","assets/utils-f77fba44.js","assets/EditGeometryOperations-7a18c435.js","assets/dehydratedFeatureComparison-0ac2f54e.js","assets/AnalysisToolBase-c69e0046.js","assets/ImageMaterial-b196cc20.js"]));case"featureCollection":return t.addPromise(Ve(()=>import("./FeatureCollectionSnappingSource-361deca3.js"),["assets/FeatureCollectionSnappingSource-361deca3.js","assets/MapView-d4248bee.js","assets/index-9ba3f23e.js","assets/index-fecf00a2.css","assets/elevationInfoUtils-be893fde.js","assets/queryEngineUtils-d12f7e09.js","assets/VertexSnappingCandidate-c90144a6.js","assets/symbologySnappingCandidates-26c3e23b.js","assets/RightAngleQuadVisualElement-7f36d6f3.js","assets/VisualElement-62e5dd07.js","assets/VisualElementResources-d63a6ee6.js","assets/PointVisualElement-97fe269b.js","assets/viewUtils-653374a2.js","assets/QueryEngineResult-000a2eb4.js","assets/WhereClause-34fcc82f.js","assets/executionError-fb3f283a.js","assets/utils-5fb83578.js","assets/ClassBreaksDefinition-6b9f5256.js","assets/projectionSupport-96272605.js","assets/json-48e3ea08.js","assets/utils-f77fba44.js","assets/EditGeometryOperations-7a18c435.js","assets/dehydratedFeatureComparison-0ac2f54e.js","assets/AnalysisToolBase-c69e0046.js","assets/ImageMaterial-b196cc20.js"]));case"graphics":case"notes":return t.addPromise(Ve(()=>import("./GraphicsSnappingSource-dc9b6e60.js"),["assets/GraphicsSnappingSource-dc9b6e60.js","assets/MapView-d4248bee.js","assets/index-9ba3f23e.js","assets/index-fecf00a2.css","assets/normalizeUtilsSync-b85f6a03.js","assets/FeatureStore-15f08eb6.js","assets/BoundsStore-eb68ff23.js","assets/PooledRBush-848b4499.js","assets/optimizedFeatureQueryEngineAdapter-fa5b86b1.js","assets/centroid-589c262e.js","assets/utils-f77fba44.js","assets/projectionSupport-96272605.js","assets/json-48e3ea08.js","assets/QueryEngine-0e5abd53.js","assets/QueryEngineResult-000a2eb4.js","assets/WhereClause-34fcc82f.js","assets/executionError-fb3f283a.js","assets/utils-5fb83578.js","assets/ClassBreaksDefinition-6b9f5256.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-ae1793ee.js","assets/elevationInfoUtils-be893fde.js","assets/queryEngineUtils-d12f7e09.js","assets/VertexSnappingCandidate-c90144a6.js","assets/symbologySnappingCandidates-26c3e23b.js","assets/RightAngleQuadVisualElement-7f36d6f3.js","assets/VisualElement-62e5dd07.js","assets/VisualElementResources-d63a6ee6.js","assets/PointVisualElement-97fe269b.js","assets/viewUtils-653374a2.js","assets/EditGeometryOperations-7a18c435.js","assets/dehydratedFeatureComparison-0ac2f54e.js","assets/AnalysisToolBase-c69e0046.js","assets/ImageMaterial-b196cc20.js"]));case"scene":return t.addPromise(Ve(()=>import("./SceneLayerSnappingSource-1052d1ce.js"),["assets/SceneLayerSnappingSource-1052d1ce.js","assets/MapView-d4248bee.js","assets/index-9ba3f23e.js","assets/index-fecf00a2.css","assets/VertexSnappingCandidate-c90144a6.js","assets/elevationInfoUtils-be893fde.js","assets/RightAngleQuadVisualElement-7f36d6f3.js","assets/VisualElement-62e5dd07.js","assets/VisualElementResources-d63a6ee6.js","assets/PointVisualElement-97fe269b.js","assets/viewUtils-653374a2.js","assets/QueryEngineResult-000a2eb4.js","assets/WhereClause-34fcc82f.js","assets/executionError-fb3f283a.js","assets/utils-5fb83578.js","assets/ClassBreaksDefinition-6b9f5256.js","assets/projectionSupport-96272605.js","assets/json-48e3ea08.js","assets/utils-f77fba44.js","assets/EditGeometryOperations-7a18c435.js","assets/dehydratedFeatureComparison-0ac2f54e.js","assets/AnalysisToolBase-c69e0046.js","assets/ImageMaterial-b196cc20.js"]))}}};u([f({constructOnly:!0})],Y.prototype,"spatialReference",void 0),u([f({constructOnly:!0})],Y.prototype,"view",void 0),u([f()],Y.prototype,"options",void 0),u([f({readOnly:!0})],Y.prototype,"updating",null),u([f({readOnly:!0})],Y.prototype,"snappingSources",null),Y=u([te("esri.views.interactive.snapping.FeatureSnappingEngine")],Y);let Ki=class{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new pi;const n=this.snappingSource.layerSource.layer;if("refresh"in n){const s=n;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([J(()=>e.updating,s=>e.layerSource.updating=s,Ze),J(()=>e.availability,s=>e.layerSource.availability=s,Ze)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}};function es(i){return(i instanceof Qi||i instanceof Ji)&&!ts(i)}function ts({constraint:{start:i,end:e}}){const t=ut(i,e),n=he(i,e);return t<ui()||n/t<is}function ot(i,e,t,n,s,r,{spatialReference:a}){const l=we(ns,e);l[0]+=t,l[1]+=n,l[2]+=s;const o=R(l,a,x,r);return o?Fi(o,i):1/0}const Jt=y(),ns=y(),is=1e-4;class Ke{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=m.shortLineThreshold*m.shortLineThreshold}snap(e,t){return g(t.vertexHandle)?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(S(e.leftVertex.pos,this.view,t),S(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:n}){return this.squaredShortLineThreshold===0||pe(R(t,n,x,this.view),R(e,n,x,this.view))>this.squaredShortLineThreshold}isVertical(e,t){return he(e,t)<m.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}}let ss=class extends be{constructor({lineStart:e,lineEnd:t,targetPoint:n,isDraped:s}){super(n,new Dn(e,t),s,b.SELF),this._referenceLineHint=new D(O.REFERENCE_EXTENSION,e,t,s,this.domain)}get hints(){return[this._referenceLineHint,new D(O.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}};class rs extends Ke{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.edges.length,r=[];if(s<1)return r;const{spatialReference:a}=t,l=R(e,a,x,this.view),{view:o}=this,c=n.edges[s-1];let d=c;do{if(this.edgeExceedsShortLineThreshold(d,t)){const h=Ue(d,o,t);this._processCandidateProposal(h.left,h.right,e,l,t,r)}d=d.leftVertex.leftEdge}while(d&&d!==c);return r}snapExistingVertex(e,t){const n=[],s=W(t.vertexHandle),r=s.component;if(r.edges.length<2)return n;const{view:a}=this,{spatialReference:l}=t,o=R(e,l,x,a),c=s.leftEdge,d=s.rightEdge;c&&d&&this.edgeExceedsShortLineThreshold(c,t)&&this.edgeExceedsShortLineThreshold(d,t)&&this._processCandidateProposal(S(c.leftVertex.pos,a,t),S(d.rightVertex.pos,a,t),e,o,t,n);const h=r.edges[0];let p=h;do{if(p!==s.leftEdge&&p!==s.rightEdge&&this.edgeExceedsShortLineThreshold(p,t)){const _=Ue(p,a,t);this._processCandidateProposal(_.left,_.right,e,o,t,n)}p=p.rightVertex.rightEdge}while(p&&p!==h);return n}_processCandidateProposal(e,t,n,s,r,a){var d;const{spatialReference:l,pointer:o}=r,c=Rt(n,{start:e,end:t,type:L.LINE});pe(s,R(c,l,x,this.view))<this.squaredProximityThreshold(o)&&a.push(new ss({lineStart:e,lineEnd:t,targetPoint:c,isDraped:((d=r.elevationInfo)==null?void 0:d.mode)==="on-the-ground"}))}}let as=class extends be{constructor({referenceLine:e,lineStart:t,targetPoint:n,isDraped:s}){const r=ee(t),{left:a,right:l}=e;Ye(r,en(r,r,l),a),super(n,new Dn(t,r),s,b.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new D(O.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new _n(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new D(O.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(n=>{w(e.right,n.edge.left)&&(n.fadeLeft=!1,t.fadeRight=!1),w(e.right,n.edge.right)&&(n.fadeRight=!1,t.fadeRight=!1),w(e.left,n.edge.right)&&(n.fadeRight=!1,t.fadeLeft=!1),w(e.left,n.edge.left)&&(n.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}},os=class extends Ke{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.edges.length,r=n.vertices.length,a=[];if(s<2)return a;const{view:l}=this,o=R(e,t.spatialReference,x,l),c=S(n.vertices[r-1].pos,l,t),d=S(n.vertices[0].pos,l,t),h=n.edges[s-1];let p=h;do{if(this.edgeExceedsShortLineThreshold(p,t)){const _=Ue(p,l,t);this._checkEdgeForParallelLines(_,c,e,o,t,a),this._checkEdgeForParallelLines(_,d,e,o,t,a)}p=p.leftVertex.leftEdge}while(p&&p!==h);return a}snapExistingVertex(e,t){const n=[],s=W(t.vertexHandle),r=s.component;if(r.edges.length<3)return n;const{view:a}=this,l=R(e,t.spatialReference,x,a),o=s.leftEdge,c=s.rightEdge,d=r.vertices[0],h=S(d.pos,a,t),p=r.vertices.length,_=r.vertices[p-1],$=S(_.pos,a,t),P=r.edges[0];let T=P;do{if(T!==o&&T!==c&&this.edgeExceedsShortLineThreshold(T,t)){const A=Ue(T,a,t);o&&this._checkEdgeForParallelLines(A,S(o.leftVertex.pos,a,t),e,l,t,n),c&&this._checkEdgeForParallelLines(A,S(c.rightVertex.pos,a,t),e,l,t,n),s===d?this._checkEdgeForParallelLines(A,$,e,l,t,n):s===_&&this._checkEdgeForParallelLines(A,h,e,l,t,n)}T=T.rightVertex.rightEdge}while(T&&T!==P);return n}_checkEdgeForParallelLines(e,t,n,s,r,a){var p;const l=e.left,o=e.right;if(rt(se,t,l,o),he(se,t)<m.parallelLineThreshold)return;rt(se,n,l,o,t);const{spatialReference:c,pointer:d}=r,h=U(se[0],se[1],n[2]);if(pe(s,R(h,c,x,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(h,t)||this.isVertical(l,o)||this._parallelToPreviousCandidate(e,a))return;a.push(new as({referenceLine:e,lineStart:t,targetPoint:h,isDraped:((p=r.elevationInfo)==null?void 0:p.mode)==="on-the-ground"}))}}_parallelToPreviousCandidate(e,t){const n=e.left,s=e.right;for(const r of t)if(rt(se,s,r.constraint.start,r.constraint.end,n),he(se,s)<m.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}};const se=j();class ls extends Ke{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.vertices.length,r=[];if(s<2)return r;const{view:a}=this,l=R(e,t.spatialReference,x,a),o=n.vertices[s-1];if(this.edgeExceedsShortLineThreshold(o.leftEdge,t)){const d=S(o.pos,a,t),h=S(o.leftEdge.leftVertex.pos,a,t);this._checkForSnappingCandidate(r,h,d,e,l,t)}const c=n.vertices[0];if(this.edgeExceedsShortLineThreshold(c.rightEdge,t)){const d=S(c.pos,a,t),h=S(c.rightEdge.rightVertex.pos,a,t);this._checkForSnappingCandidate(r,h,d,e,l,t)}return r}snapExistingVertex(e,t){const n=[],s=W(t.vertexHandle);if(s.component.vertices.length<3)return n;const{view:r}=this,a=R(e,t.spatialReference,x,r),l=s.leftEdge,o=s.rightEdge;if(l&&l.leftVertex.leftEdge){const c=l.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(c,t)){const d=S(c.rightVertex.pos,r,t),h=S(c.leftVertex.pos,r,t);this._checkForSnappingCandidate(n,h,d,e,a,t)}}if(o&&o.rightVertex.rightEdge){const c=o.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(c,t)){const d=S(c.leftVertex.pos,r,t),h=S(c.rightVertex.pos,r,t);this._checkForSnappingCandidate(n,h,d,e,a,t)}}return n}_checkForSnappingCandidate(e,t,n,s,r,a){var p;const{spatialReference:l,pointer:o}=a;B(Ge,n,t);const c=Ce(cs,Ge[1],-Ge[0],0),d=De(c,B(Ge,s,n))/Oe(c),h=Le(ee(s),n,c,d);if(pe(r,R(h,l,x,this.view))<this.squaredProximityThreshold(o)){if(this.isVertical(h,n)||this.isVertical(n,t))return;const _=de(y(),n,c,Math.sign(d));e.push(new Vn({targetPoint:h,constraint:new Cn(n,_),previousVertex:t,otherVertex:n,otherVertexType:xe.CENTER,isDraped:((p=a.elevationInfo)==null?void 0:p.mode)==="on-the-ground"}))}}}const Ge=j(),cs=y();let ds=class extends be{constructor({targetPoint:e,point1:t,point2:n,isDraped:s}){super(e,new On(sn(y(),t,n,.5),.5*an(t,n)),s,b.SELF),this._p1=t,this._p2=n}get hints(){return[new D(O.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new D(O.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new bt(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}},hs=class extends Ke{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=[],r=n.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:a}=this,l=n.vertices[0],o=n.vertices[r-1],c=S(l.pos,a,t),d=S(o.pos,a,t);return this._processCandidateProposal(c,d,e,t,s),s}snapExistingVertex(e,t){const n=[],s=W(t.vertexHandle),r=s.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return n;const{view:a}=this,l=S(s.leftEdge.leftVertex.pos,a,t),o=S(s.rightEdge.rightVertex.pos,a,t);return this._processCandidateProposal(l,o,e,t,n),n}_processCandidateProposal(e,t,n,s,r){var _;if(!this.exceedsShortLineThreshold(e,t,s))return;const a=fi(ps,e,t,.5),l=.5*an(e,t),o=y();$i(o,n,a,l),o[2]=n[2];const c=o,{spatialReference:d,pointer:h}=s,p=R(n,d,x,this.view);if(pe(p,R(c,d,x,this.view))<this.squaredProximityThreshold(h)){if(this.isVertical(e,c)||this.isVertical(c,t))return;r.push(new ds({targetPoint:c,point1:e,point2:t,isDraped:((_=s.elevationInfo)==null?void 0:_.mode)==="on-the-ground"}))}}};const ps=j();let ve=class extends Xe{constructor(i){super(i),this.updating=!1,this._snappers=new Je,this._domain=b.SELF}initialize(){this._snappers.push(new os(this.view,this.options),new rs(this.view,this.options),new ls(this.view,this.options),new hs(this.view,this.options))}set options(i){this._set("options",i);for(const e of this._snappers)e.options=i}async fetchCandidates(i,e,t){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const n=[];for(const s of this._snappers.items)for(const r of s.snap(i,t))n.push(r);return Pt(i,n),n}};u([f({readOnly:!0})],ve.prototype,"updating",void 0),u([f({constructOnly:!0})],ve.prototype,"view",void 0),u([f()],ve.prototype,"options",null),ve=u([te("esri.views.interactive.snapping.SelfSnappingEngine")],ve);function us(i,e){return[new ve({view:i,options:e}),new Y({view:i,options:e,spatialReference:i.spatialReference})]}class Me extends be{constructor(e,t,n,s){super(e,new Qe(e,t.constraint,n.constraint),s,b.ALL),this.first=t,this.second=n}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new un(this.targetPoint,this.isDraped,this.domain)]}}let I=class extends gi.EventedMixin(rn){constructor(i){super(i),this.options=new Sn,this.snappingEnginesFactory=us,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=X.MAIN}initialize(){this.handles.add([J(()=>{const{effectiveFeatureEnabled:i,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:n}=this.options;return{effectiveFeatureEnabled:i,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:n}},()=>{this.doneSnapping(),this.emit("changed")},yt),J(()=>this.options,i=>{for(const e of this._engines)e.options=i},yt),J(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:i,snappingEnginesFactory:e})=>this._recreateEngines(i,e),Ze)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(i=>i.updating)}_recreateEngines(i,e){if(this._destroyEngines(),!i)return;const{view:t,options:n}=this;this._engines=e(t,n)}_destroyEngines(){for(const i of this._engines)i.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:i,touchSensitivityMultiplier:e}=this.options,t=i*e;return t*t}get _squaredSatisfiesConstraintThreshold(){return m.satisfiesConstraintScreenThreshold*m.satisfiesConstraintScreenThreshold}async snap(i){return fs(i)?this._snapMultiPoint(i):this._snapSinglePoint(i)}update(i){const{point:e,context:t}=i;this._removeVisualization();const n=this._currentMainCandidate;if(v(n))return e;const s=this._selectUpdateInput(i);if(v(s))return e;const{spatialReference:r}=t,a=Ft(s,r);if(v(a))return e;const{view:l}=this,{elevationInfo:o,visualizer:c}=t,d=[],h=Te(a,l,t),p=n.constraint.closestTo(h);if(!this._arePointsWithinScreenThreshold(h,p,t))return this._resetSnappingState(),e;n.targetPoint=p,d.push(...n.hints);for(const _ of this._currentOtherActiveCandidates)_.targetPoint=p,d.push(..._.hints);return g(c)&&this.handles.add(c.draw(d,{spatialReference:r,elevationInfo:gs(t),view:l,selfSnappingZ:t.selfSnappingZ}),He),Ut(p,l,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:o})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:i,scenePoint:e}){switch(this._currentSnappedType){case X.MAIN:return i;case X.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=X.MAIN}_removeVisualization(){this.handles.remove(He)}async _snapSinglePoint({point:i,context:e,signal:t}){const{view:n}=this,s=Te(i,n,e),r=await this._fetchCandidates(s,b.ALL,e,t);return this._createSnapResult(s,X.MAIN,r,n,e,{z:i.z,m:i.m,spatialReference:i.spatialReference,elevationInfo:e.elevationInfo},t)}async _snapMultiPoint({point:i,scenePoint:e,context:t,signal:n}){const{view:s}=this,{coordinateHelper:r,spatialReference:a}=t;await _i(e.spatialReference,a);const l=Ft(e,a),o=Te(l,s,t),c=await this._fetchCandidates(o,b.FEATURE,t,n);if(c.length>0){const p=await this._fetchCandidates(o,b.SELF,t,n);return this._createSnapResult(o,X.SCENE,[...c,...p],s,t,{z:l.z,m:l.m,spatialReference:l.spatialReference,elevationInfo:t.elevationInfo},n)}const d=Te(i,s,t),h=await this._fetchCandidates(d,b.SELF,t,n);return this._createSnapResult(d,X.MAIN,h,s,t,{z:r.hasZ()&&i.hasZ?i.z??0:void 0,m:r.hasM()&&i.hasM?i.m??0:void 0,spatialReference:i.spatialReference,elevationInfo:t.elevationInfo},n)}async _fetchCandidates(i,e,t,n){return(await Promise.all(this._engines.map(s=>s.fetchCandidates(i,e,t,n)))).flat()}_createSnapResult(i,e,t,n,s,r,a){return{get valid(){return!yi(a)},apply:()=>{const{spatialReference:l}=s,{snappedPoint:o,hints:c}=this._processCandidates(i,e,t,s);return this._removeVisualization(),g(s.visualizer)&&this.handles.add(s.visualizer.draw(c,{spatialReference:l,elevationInfo:x,view:n,selfSnappingZ:s.selfSnappingZ}),He),Ut(o,n,r)}}}_processCandidates(i,e,t,n){if(t.length<1)return this.doneSnapping(),{snappedPoint:i,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),Pt(i,t);const s=this._currentMainCandidate;if(g(s)){const r=this._findOldConstraintInNewCandidates(s,t);if(r>=0){if(!(t[r]instanceof Me))return this._intersectWithOtherCandidates(r,t,i,e,n);if(this._arePointsWithinScreenThreshold(i,s.targetPoint,n))return this._updateSnappingCandidate(s,e,t,n)}}return this._intersectWithOtherCandidates(0,t,i,e,n)}_findOldConstraintInNewCandidates(i,e){return i instanceof Me?this._findOldCandidateIndex(e,i.first)>=0&&this._findOldCandidateIndex(e,i.second)>=0?0:-1:this._findOldCandidateIndex(e,i)}_intersectWithOtherCandidates(i,e,t,n,s){const{coordinateHelper:r}=s,a=e[i],l=[];for(let o=0;o<e.length;++o){if(o===i)continue;const c=e[o];for(const d of a.constraint.intersect(c.constraint)){const h=d.closestTo(a.targetPoint);l.push([new Me(h,a,c,c.isDraped),this._squaredScreenDistance(t,h,r)])}}return l.length>0&&(l.sort((o,c)=>o[1]-c[1]),l[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(l[0][0],n,e,s):this._updateSnappingCandidate(a,n,e,s)}_updateSnappingCandidate(i,e,t,n){this.doneSnapping(),this._currentMainCandidate=i,this._currentSnappedType=e;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...i.hints);for(const a of t){if(i instanceof Me){if(a.constraint.equals(i.first.constraint)||a.constraint.equals(i.second.constraint))continue}else if(a.constraint.equals(i.constraint))continue;const l=a.constraint.closestTo(s);this._squaredScreenDistance(l,s,n.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(a.targetPoint=s,this._currentOtherActiveCandidates.push(a),r.push(...a.hints))}return{snappedPoint:s,hints:r}}_squaredPointProximityThreshold(i){return i==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(i,e,t){return this._squaredScreenDistance(i,e,t.coordinateHelper)<this._squaredPointProximityThreshold(t.pointer)}_squaredScreenDistance(i,e,t){return pe(this._toScreen(i,t),this._toScreen(e,t))}_toScreen(i,e){return R(i,e.spatialReference,x,this.view)}_findOldCandidateIndex(i,e){let t=-1;for(let n=0;n<i.length;++n)if(e.constraint.equals(i[n].constraint)){t=n;break}return t}get test(){return{visualizationsActive:this.handles.has(He),engines:this._engines}}};var X;u([f({constructOnly:!0})],I.prototype,"view",void 0),u([f()],I.prototype,"options",void 0),u([f({readOnly:!0})],I.prototype,"updating",null),u([f()],I.prototype,"snappingEnginesFactory",void 0),u([f()],I.prototype,"_engines",void 0),u([f()],I.prototype,"_squaredMouseProximityTreshold",null),u([f()],I.prototype,"_squaredTouchProximityThreshold",null),u([f()],I.prototype,"_squaredSatisfiesConstraintThreshold",null),I=u([te("esri.views.interactive.snapping.SnappingManager")],I),function(i){i[i.MAIN=0]="MAIN",i[i.SCENE=1]="SCENE"}(X||(X={}));const He="visualization-handle";function fs(i){return g(i.scenePoint)}function gs({coordinateHelper:i,elevationInfo:e}){return i.hasZ()?x:e}const ze=new Map;function fr(i){if(!ze.has(i)){const n=Hi(i,{distance:10}),s=ys(i,n.options);ze.set(i,{referenceCount:0,snappingManager:s,remove:()=>{n.remove(),s.destroy()}})}const e=ze.get(i);e.referenceCount++;const t=mi(()=>_s(i,e));return{snappingManager:e.snappingManager,...t}}function _s(i,e){e.referenceCount--,e.referenceCount>0||vi(()=>{e.referenceCount===0&&(e.remove(),ze.delete(i))})}function ys(i,e){return new I({view:i,options:e,snappingEnginesFactory:(t,n)=>[new Y({view:i,spatialReference:i.spatialReference,options:n})]})}class ms{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.visualizer=e.visualizer,this.selfSnappingZ=e.selfSnappingZ}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}get spatialReference(){return this.coordinateHelper.spatialReference}}function gr({predicate:i=()=>!0,snappingManager:e,snappingContext:t,updatingHandles:n,useZ:s=!0}){const r=new Li;if(v(e))return{snappingStep:[Qt,r],cancelSnapping:Qt};let a,l=null,o=null,c=null;const d=()=>{l=mt(l),e.doneSnapping(),g(o)&&o.frameTask.remove(),o=null,a=cn(a),c=null},h=vs(e,s,r);let p=null,_=null,$=null;return{snappingStep:[P=>{if(!i(P))return P;const{action:T}=P;if(T==="start"){const{info:A}=P,ge=Es(e.view);if(o=Ss(t,P,ge),o.context.selfSnappingZ=null,!s&&g(A)){const q=xs(t.coordinateHelper,A.handle.component);g(q)&&(o.context.selfSnappingZ={value:q,elevationInfo:t.elevationInfo})}}if(g(o)){const{context:A,originalScenePos:ge,originalPos:q}=o,{mapEnd:Ct,mapStart:Dt,scenePoints:Gn}=P,et=In(q,xt(Ct,Dt)),At=xt(Dt,q),Mn={...P,action:"update"},Hn=o.context,tt=ws(ge,Gn),Nt=e.update({point:et,scenePoint:tt,context:A});if($=Nt,Fn(Ct,Nt,At,s),p=et,_=tt,T!=="end"){const{frameTask:jn}=o;v(l)&&(l=new AbortController),c=zn=>{n.addPromise(Si(h({frameTask:jn,event:Mn,context:Hn,point:et,scenePoint:tt,delta:At,getLastState:()=>({point:p,scenePoint:_,updatePoint:zn.forceUpdate?null:$})},W(l).signal)))},c({forceUpdate:!1}),v(a)&&(a=J(()=>e.options.effectiveEnabled,()=>c==null?void 0:c({forceUpdate:!0})))}}return T==="end"&&d(),P},r],cancelSnapping:P=>(d(),P)}}function vs(i,e,t){return dn(async({frameTask:n,point:s,scenePoint:r,context:a,event:l,delta:o,getLastState:c},d)=>{const h=await n.schedule(()=>i.snap({point:s,scenePoint:r,context:a,signal:d}),d);if(h.valid){let p=await n.schedule(()=>h.apply(),d);const _=c();g(_.point)&&s!==_.point&&(p=i.update({point:_.point,scenePoint:_.scenePoint,context:a})),!v(_.updatePoint)&&Ti(p,_.updatePoint)||(Fn(l.mapEnd,p,o,e),t.execute(l))}})}function Es(i){return i.type==="3d"?i.resourceController.scheduler.registerTask(on.SNAPPING):ln}function Ss(i,e,t){return{context:new ms({editGeometryOperations:i.editGeometryOperations,elevationInfo:i.elevationInfo,pointer:i.pointer,vertexHandle:g(e.info)?e.info.handle:null,excludeFeature:i.excludeFeature,visualizer:i.visualizer}),originalPos:g(e.snapOrigin)?i.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:g(e.scenePoints)?e.scenePoints.sceneStart:null,frameTask:t}}function In(i,[e,t,n]){const s=Ei(i);return s.x+=e,s.y+=t,s.hasZ&&(s.z+=n),s}function ws(i,e){return v(i)||v(e)?null:In(i,xt(e.sceneEnd,e.sceneStart))}function xt(i,e){const t=i.hasZ&&e.hasZ?i.z-e.z:0;return[i.x-e.x,i.y-e.y,t]}function Fn(i,e,[t,n,s],r){i.x=e.x+t,i.y=e.y+n,r&&i.hasZ&&e.hasZ&&(i.z=e.z+s)}function xs(i,e){if(!i.hasZ())return null;const t=e.vertices;let n=null;for(const s of t){const r=i.getZ(s.pos);if(g(n)&&g(r)&&Math.abs(r-n)>1e-6)return null;v(n)&&(n=r)}return n}function Qt(i){return i}let me=class extends Xe{constructor(i){super(i),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=dn(async(e,t,n,s)=>{const r=this._frameTask;if(v(r))return;const a=await r.schedule(()=>t.snap({...e,context:n,signal:s}),s);a.valid&&await r.schedule(()=>{this.stagedPoint=a.apply(),e!==this._snapPoints&&g(this._snapPoints)&&(this.stagedPoint=t.update({...this._snapPoints,context:n}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(i){this._stagedPoint=this.constrainResult(i)}initialize(){var e,t;const i=this.view.type==="3d"?(t=(e=this.view)==null?void 0:e.resourceController)==null?void 0:t.scheduler:null;this._frameTask=g(i)?i.registerTask(on.SNAPPING):ln}destroy(){this._abortController=mt(this._abortController),this._frameTask=cn(this._frameTask)}update(i,e,t){this._snapPoints=i;const{point:n,scenePoint:s}=i,r=e.update({point:n,scenePoint:s,context:t});return this.stagedPoint=r,r}async snap(i,e,t){const{point:n,scenePoint:s}=i;return this.stagedPoint=e.update({point:n,scenePoint:s,context:t}),this._snapPoints=i,v(this._abortController)&&(this._abortController=new AbortController),this._snap(i,e,t,this._abortController.signal)}async resnap(i,e){v(this._snapPoints)||await this.snap(this._snapPoints,i,e)}abort(){this._abortController=mt(this._abortController),this._snapPoints=null}};u([f({constructOnly:!0})],me.prototype,"view",void 0),u([f()],me.prototype,"stagedPoint",null),u([f()],me.prototype,"constrainResult",void 0),u([f()],me.prototype,"_stagedPoint",void 0),me=u([te("esri.views.interactive.snapping.SnappingOperation")],me);export{F as W,ki as Z,fr as a,gr as b,Hs as c,Gi as d,ms as e,zs as f,js as g,me as h,Pt as i,Ms as l,qs as m,Ot as n,Qi as r,Ji as s,Ns as t,Us as x};
