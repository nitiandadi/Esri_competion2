import{gr as oe,d8 as le,r as V,dg as W,lq as K,cG as C,d4 as O,cW as ce,d6 as fe,d0 as ue,t as F,di as z,lr as de,nq as Z,m6 as pe}from"./MapView-d4248bee.js";import{Z as A,_ as ie,$ as J}from"./definitions-19bfb61c.js";import{T as k}from"./enums-b1d611e3.js";import{M as j}from"./number-b10bd8f5.js";import{r as B,l as N,n as ee}from"./StyleDefinition-7d58136b.js";import{c as te}from"./GeometryUtils-dd03fc25.js";class Q{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(r,e){}draw(r,e,t){}drawMany(r,e,t){for(const l of e)l.visible&&this.draw(r,l,t)}}class he extends Q{constructor(){super(...arguments),this._color=oe(1,0,0,1),this._patternMatrix=le(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(r,e){const{context:t,painter:l,styleLayerUID:o,requestRender:a,allowDelayedRender:U}=r;this._loadWGLResources(r);const y=r.displayLevel,c=r.styleLayer,P=c.backgroundMaterial,_=l.vectorTilesMaterialManager,v=c.getPaintValue("background-color",y),m=c.getPaintValue("background-opacity",y),S=c.getPaintValue("background-pattern",y),D=S!==void 0,E=v[3]*m,x=1|window.devicePixelRatio,h=r.spriteMosaic;let I,T;const f=x>ie?2:1,d=r.drawPhase===k.HITTEST,p=this._programOptions;p.id=d,p.pattern=D;const n=_.getMaterialProgram(t,P,p);if(U&&V(a)&&!n.compiled)a();else{if(t.bindVAO(this._vao),t.useProgram(n),D){const s=h.getMosaicItemPosition(S,!0);if(V(s)){const{tl:u,br:i,page:M}=s;I=i[0]-u[0],T=i[1]-u[1];const g=h.getPageSize(M);V(g)&&(h.bind(t,W.LINEAR,M,A),n.setUniform4f("u_tlbr",u[0],u[1],i[0],i[1]),n.setUniform2fv("u_mosaicSize",g),n.setUniform1i("u_texture",A))}n.setUniform1f("u_opacity",m)}else this._color[0]=E*v[0],this._color[1]=E*v[1],this._color[2]=E*v[2],this._color[3]=E,n.setUniform4fv("u_color",this._color);if(n.setUniform1f("u_depth",c.z||0),d){const s=j(o+1);n.setUniform4fv("u_id",s)}for(const s of e){if(n.setUniform1f("u_coord_range",s.rangeX),n.setUniformMatrix3fv("u_dvsMat3",s.transforms.dvs),D){const u=Math.max(2**(Math.round(y)-s.key.level),1),i=f*s.width*u,M=i/K(I),g=i/K(T);this._patternMatrix[0]=M,this._patternMatrix[4]=g,n.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}t.setStencilFunction(C.EQUAL,0,255),t.drawArrays(O.TRIANGLE_STRIP,0,4)}}}_loadWGLResources(r){if(this._vao)return;const{context:e,styleLayer:t}=r,l=t.backgroundMaterial,o=new Int8Array([0,0,1,0,0,1,1,1]),a=ce.createVertex(e,fe.STATIC_DRAW,o),U=new ue(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:a});this._vao=U}}let Pe=class extends Q{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(r,e){const{context:t,displayLevel:l,requiredLevel:o,state:a,drawPhase:U,painter:y,spriteMosaic:c,styleLayerUID:P,requestRender:_,allowDelayedRender:v}=r;if(!e.some(p=>{var n;return((n=p.layerData.get(P))==null?void 0:n.circleIndexCount)??!1}))return;const m=r.styleLayer,S=m.circleMaterial,D=y.vectorTilesMaterialManager,E=1.2,x=m.getPaintValue("circle-translate",l),h=m.getPaintValue("circle-translate-anchor",l),I=U===k.HITTEST,T=this._programOptions;T.id=I;const f=D.getMaterialProgram(t,S,T);if(v&&V(_)&&!f.compiled)return void _();t.useProgram(f),f.setUniformMatrix3fv("u_displayMat3",h===B.VIEWPORT?a.displayMat3:a.displayViewMat3),f.setUniform2fv("u_circleTranslation",x),f.setUniform1f("u_depth",m.z),f.setUniform1f("u_antialiasingWidth",E);let d=-1;if(I){const p=j(P+1);f.setUniform4fv("u_id",p)}for(const p of e){if(!p.layerData.has(P))continue;p.key.level!==d&&(d=p.key.level,S.setDataUniforms(f,l,m,d,c));const n=p.layerData.get(P);if(!n.circleIndexCount)continue;n.prepareForRendering(t);const s=n.circleVertexArrayObject;F(s)||(t.bindVAO(s),f.setUniformMatrix3fv("u_dvsMat3",p.transforms.dvs),o!==p.key.level?t.setStencilFunction(C.EQUAL,p.stencilRef,255):t.setStencilFunction(C.GREATER,255,255),t.drawElements(O.TRIANGLES,n.circleIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*n.circleIndexStart),p.triangleCount+=n.circleIndexCount/3)}}};const ae=1/65536;class Te extends Q{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(r,e){const{displayLevel:t,drawPhase:l,renderPass:o,spriteMosaic:a,styleLayerUID:U}=r;let y=!1;for(const f of e)if(f.layerData.has(U)){const d=f.layerData.get(U);if(d.fillIndexCount>0||d.outlineIndexCount>0){y=!0;break}}if(!y)return;const c=r.styleLayer,P=c.getPaintProperty("fill-pattern"),_=P!==void 0,v=_&&P.isDataDriven;let m;if(_&&!v){const f=P.getValue(t);m=a.getMosaicItemPosition(f,!0)}const S=!_&&c.getPaintValue("fill-antialias",t);let D=!0,E=1;if(!_){const f=c.getPaintProperty("fill-color"),d=c.getPaintProperty("fill-opacity");if(!(f!=null&&f.isDataDriven)&&!(d!=null&&d.isDataDriven)){const p=c.getPaintValue("fill-color",t);E=c.getPaintValue("fill-opacity",t)*p[3],E>=1&&(D=!1)}}if(D&&o==="opaque")return;let x;l===k.HITTEST&&(x=j(U+1));const h=c.getPaintValue("fill-translate",t),I=c.getPaintValue("fill-translate-anchor",t);(D||o!=="translucent")&&this._drawFill(r,U,c,e,h,I,_,m,v,x);const T=!c.hasDataDrivenOutlineColor&&c.outlineUsesFillColor&&E<1;S&&o!=="opaque"&&!T&&this._drawOutline(r,U,c,e,h,I,x)}_drawFill(r,e,t,l,o,a,U,y,c,P){if(U&&!c&&F(y))return;const{context:_,displayLevel:v,state:m,drawPhase:S,painter:D,pixelRatio:E,spriteMosaic:x,requestRender:h,allowDelayedRender:I}=r,T=t.fillMaterial,f=D.vectorTilesMaterialManager,d=E>ie?2:1,p=S===k.HITTEST,n=this._fillProgramOptions;n.id=p,n.pattern=U;const s=f.getMaterialProgram(_,T,n);if(I&&V(h)&&!s.compiled)return void h();if(_.useProgram(s),V(y)){const{page:i}=y,M=x.getPageSize(i);V(M)&&(x.bind(_,W.LINEAR,i,A),s.setUniform2fv("u_mosaicSize",M),s.setUniform1i("u_texture",A))}s.setUniformMatrix3fv("u_displayMat3",a===B.VIEWPORT?m.displayMat3:m.displayViewMat3),s.setUniform2fv("u_fillTranslation",o),s.setUniform1f("u_depth",t.z+ae),p&&s.setUniform4fv("u_id",P);let u=-1;for(const i of l){if(!i.layerData.has(e))continue;i.key.level!==u&&(u=i.key.level,T.setDataUniforms(s,v,t,u,x));const M=i.layerData.get(e);if(!M.fillIndexCount)continue;M.prepareForRendering(_);const g=M.fillVertexArrayObject;if(!F(g)){if(_.bindVAO(g),s.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),_.setStencilFunction(C.EQUAL,i.stencilRef,255),U){const w=Math.max(2**(Math.round(v)-i.key.level),1),L=i.rangeX/(d*i.width*w);s.setUniform1f("u_patternFactor",L)}if(c){const w=M.patternMap;if(!w)continue;for(const[L,G]of w){const $=x.getPageSize(L);V($)&&(x.bind(_,W.LINEAR,L,A),s.setUniform2fv("u_mosaicSize",$),s.setUniform1i("u_texture",A),_.drawElements(O.TRIANGLES,G[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*G[0]))}}else _.drawElements(O.TRIANGLES,M.fillIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*M.fillIndexStart);i.triangleCount+=M.fillIndexCount/3}}}_drawOutline(r,e,t,l,o,a,U){const{context:y,displayLevel:c,state:P,drawPhase:_,painter:v,pixelRatio:m,spriteMosaic:S,requestRender:D,allowDelayedRender:E}=r,x=t.outlineMaterial,h=v.vectorTilesMaterialManager,I=.75/m,T=_===k.HITTEST,f=this._outlineProgramOptions;f.id=T;const d=h.getMaterialProgram(y,x,f);if(E&&V(D)&&!d.compiled)return void D();y.useProgram(d),d.setUniformMatrix3fv("u_displayMat3",a===B.VIEWPORT?P.displayMat3:P.displayViewMat3),d.setUniform2fv("u_fillTranslation",o),d.setUniform1f("u_depth",t.z+ae),d.setUniform1f("u_outline_width",I),T&&d.setUniform4fv("u_id",U);let p=-1;for(const n of l){if(!n.layerData.has(e))continue;n.key.level!==p&&(p=n.key.level,x.setDataUniforms(d,c,t,p,S));const s=n.layerData.get(e);if(s.prepareForRendering(y),!s.outlineIndexCount)continue;const u=s.outlineVertexArrayObject;F(u)||(y.bindVAO(u),d.setUniformMatrix3fv("u_dvsMat3",n.transforms.dvs),y.setStencilFunction(C.EQUAL,n.stencilRef,255),y.drawElements(O.TRIANGLES,s.outlineIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*s.outlineIndexStart),n.triangleCount+=s.outlineIndexCount/3)}}}class xe extends Q{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(r,e){const{context:t,displayLevel:l,state:o,drawPhase:a,painter:U,pixelRatio:y,spriteMosaic:c,styleLayerUID:P,requestRender:_,allowDelayedRender:v}=r;if(!e.some(g=>{var w;return((w=g.layerData.get(P))==null?void 0:w.lineIndexCount)??!1}))return;const m=r.styleLayer,S=m.lineMaterial,D=U.vectorTilesMaterialManager,E=m.getPaintValue("line-translate",l),x=m.getPaintValue("line-translate-anchor",l),h=m.getPaintProperty("line-pattern"),I=h!==void 0,T=I&&h.isDataDriven;let f,d;if(I&&!T){const g=h.getValue(l);f=c.getMosaicItemPosition(g)}let p=!1;if(!I){const g=m.getPaintProperty("line-dasharray");if(d=g!==void 0,p=d&&g.isDataDriven,d&&!p){const w=g.getValue(l),L=m.getDashKey(w,m.getLayoutValue("line-cap",l));f=c.getMosaicItemPosition(L)}}const n=1/y,s=a===k.HITTEST,u=this._programOptions;u.id=s,u.pattern=I,u.sdf=d;const i=D.getMaterialProgram(t,S,u);if(v&&V(_)&&!i.compiled)return void _();if(t.useProgram(i),i.setUniformMatrix3fv("u_displayViewMat3",o.displayViewMat3),i.setUniformMatrix3fv("u_displayMat3",x===B.VIEWPORT?o.displayMat3:o.displayViewMat3),i.setUniform2fv("u_lineTranslation",E),i.setUniform1f("u_depth",m.z),i.setUniform1f("u_antialiasing",n),s){const g=j(P+1);i.setUniform4fv("u_id",g)}if(f&&V(f)){const{page:g}=f,w=c.getPageSize(g);V(w)&&(c.bind(t,W.LINEAR,g,A),i.setUniform2fv("u_mosaicSize",w),i.setUniform1i("u_texture",A))}let M=-1;for(const g of e){if(!g.layerData.has(P))continue;g.key.level!==M&&(M=g.key.level,S.setDataUniforms(i,l,m,M,c));const w=2**(l-M)/y;i.setUniform1f("u_zoomFactor",w);const L=g.layerData.get(P);if(!L.lineIndexCount)continue;L.prepareForRendering(t);const G=L.lineVertexArrayObject;if(!F(G)){if(t.bindVAO(G),i.setUniformMatrix3fv("u_dvsMat3",g.transforms.dvs),t.setStencilFunction(C.EQUAL,g.stencilRef,255),T||p){const $=L.patternMap;if(!$)continue;for(const[Y,R]of $){const q=c.getPageSize(Y);V(q)&&(c.bind(t,W.LINEAR,Y,A),i.setUniform2fv("u_mosaicSize",q),i.setUniform1i("u_texture",A),t.drawElements(O.TRIANGLES,R[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*R[0]))}}else t.drawElements(O.TRIANGLES,L.lineIndexCount,z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*L.lineIndexStart);g.triangleCount+=L.lineIndexCount/3}}}}const me=1/65536;class Ie extends Q{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=de()}dispose(){}drawMany(r,e){const{drawPhase:t,styleLayerUID:l}=r,o=r.styleLayer;let a;t===k.HITTEST&&(a=j(l+1)),this._drawIcons(r,o,e,a),this._drawText(r,o,e,a)}_drawIcons(r,e,t,l){const{context:o,displayLevel:a,drawPhase:U,painter:y,spriteMosaic:c,state:P,styleLayerUID:_,requestRender:v,allowDelayedRender:m}=r,S=e.iconMaterial,D=y.vectorTilesMaterialManager;let E,x=!1;for(const M of t)if(M.layerData.has(_)&&(E=M.layerData.get(_),E.iconPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const h=e.getPaintValue("icon-translate",a),I=e.getPaintValue("icon-translate-anchor",a);let T=e.getLayoutValue("icon-rotation-alignment",a);T===N.AUTO&&(T=e.getLayoutValue("symbol-placement",a)===ee.POINT?N.VIEWPORT:N.MAP);const f=T===N.MAP,d=e.getLayoutValue("icon-keep-upright",a)&&f,p=E.isIconSDF,n=U===k.HITTEST,s=this._iconProgramOptions;s.id=n,s.sdf=p;const u=D.getMaterialProgram(o,S,s);if(m&&V(v)&&!u.compiled)return void v();o.useProgram(u),u.setUniformMatrix3fv("u_displayViewMat3",T===N.MAP?P.displayViewMat3:P.displayMat3),u.setUniformMatrix3fv("u_displayMat3",I===B.VIEWPORT?P.displayMat3:P.displayViewMat3),u.setUniform2fv("u_iconTranslation",h),u.setUniform1f("u_depth",e.z),u.setUniform1f("u_mapRotation",te(P.rotation)),u.setUniform1f("u_keepUpright",d?1:0),u.setUniform1f("u_level",10*a),u.setUniform1i("u_texture",A),u.setUniform1f("u_fadeDuration",Z/1e3),n&&u.setUniform4fv("u_id",l);let i=-1;for(const M of t){if(!M.layerData.has(_)||(M.key.level!==i&&(i=M.key.level,S.setDataUniforms(u,a,e,i,c)),E=M.layerData.get(_),E.iconPerPageElementsMap.size===0))continue;E.prepareForRendering(o),E.updateOpacityInfo();const g=E.iconVertexArrayObject;if(!F(g)){o.bindVAO(g),u.setUniformMatrix3fv("u_dvsMat3",M.transforms.dvs),u.setUniform1f("u_time",(performance.now()-E.lastOpacityUpdate)/1e3);for(const[w,L]of E.iconPerPageElementsMap)this._renderIconRange(r,u,L,w,M)}}}_renderIconRange(r,e,t,l,o){const{context:a,spriteMosaic:U}=r;this._spritesTextureSize[0]=U.getWidth(l)/4,this._spritesTextureSize[1]=U.getHeight(l)/4,e.setUniform2fv("u_mosaicSize",this._spritesTextureSize),U.bind(a,W.LINEAR,l,A),a.setStencilTestEnabled(!0),a.setStencilFunction(C.GREATER,255,255),a.setStencilWriteMask(0),a.drawElements(O.TRIANGLES,t[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),o.triangleCount+=t[1]/3}_drawText(r,e,t,l){const{context:o,displayLevel:a,drawPhase:U,glyphMosaic:y,painter:c,pixelRatio:P,spriteMosaic:_,state:v,styleLayerUID:m,requestRender:S,allowDelayedRender:D}=r,E=e.textMaterial,x=c.vectorTilesMaterialManager;let h,I=!1;for(const b of t)if(b.layerData.has(m)&&(h=b.layerData.get(m),h.glyphPerPageElementsMap.size>0)){I=!0;break}if(!I)return;const T=e.getPaintProperty("text-opacity");if(T&&!T.isDataDriven&&T.getValue(a)===0)return;const f=e.getPaintProperty("text-color"),d=!f||f.isDataDriven||f.getValue(a)[3]>0,p=e.getPaintProperty("text-halo-width"),n=e.getPaintProperty("text-halo-color"),s=(!p||p.isDataDriven||p.getValue(a)>0)&&(!n||n.isDataDriven||n.getValue(a)[3]>0);if(!d&&!s)return;const u=24/8;let i=e.getLayoutValue("text-rotation-alignment",a);i===N.AUTO&&(i=e.getLayoutValue("symbol-placement",a)===ee.POINT?N.VIEWPORT:N.MAP);const M=i===N.MAP,g=e.getLayoutValue("text-keep-upright",a)&&M,w=U===k.HITTEST,L=.8*u/P;this._glyphTextureSize||(this._glyphTextureSize=pe(y.width/4,y.height/4));const G=e.getPaintValue("text-translate",a),$=e.getPaintValue("text-translate-anchor",a),Y=this._sdfProgramOptions;Y.id=w;const R=x.getMaterialProgram(o,E,Y);if(D&&V(S)&&!R.compiled)return void S();o.useProgram(R),R.setUniformMatrix3fv("u_displayViewMat3",i===N.MAP?v.displayViewMat3:v.displayMat3),R.setUniformMatrix3fv("u_displayMat3",$===B.VIEWPORT?v.displayMat3:v.displayViewMat3),R.setUniform2fv("u_textTranslation",G),R.setUniform1f("u_depth",e.z+me),R.setUniform2fv("u_mosaicSize",this._glyphTextureSize),R.setUniform1f("u_mapRotation",te(v.rotation)),R.setUniform1f("u_keepUpright",g?1:0),R.setUniform1f("u_level",10*a),R.setUniform1i("u_texture",J),R.setUniform1f("u_antialiasingWidth",L),R.setUniform1f("u_fadeDuration",Z/1e3),w&&R.setUniform4fv("u_id",l);let q=-1;for(const b of t){if(!b.layerData.has(m)||(b.key.level!==q&&(q=b.key.level,E.setDataUniforms(R,a,e,q,_)),h=b.layerData.get(m),h.glyphPerPageElementsMap.size===0))continue;h.prepareForRendering(o),h.updateOpacityInfo();const X=h.textVertexArrayObject;if(F(X))continue;o.bindVAO(X),R.setUniformMatrix3fv("u_dvsMat3",b.transforms.dvs),o.setStencilTestEnabled(!0),o.setStencilFunction(C.GREATER,255,255),o.setStencilWriteMask(0);const re=(performance.now()-h.lastOpacityUpdate)/1e3;R.setUniform1f("u_time",re),h.glyphPerPageElementsMap.forEach((ne,se)=>{this._renderGlyphRange(o,ne,se,y,R,s,d,b)})}}_renderGlyphRange(r,e,t,l,o,a,U,y){l.bind(r,W.LINEAR,t,J),a&&(o.setUniform1f("u_halo",1),r.drawElements(O.TRIANGLES,e[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),y.triangleCount+=e[1]/3),U&&(o.setUniform1f("u_halo",0),r.drawElements(O.TRIANGLES,e[1],z.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),y.triangleCount+=e[1]/3)}}export{Ie as M,Pe as a,xe as c,he as d,Te as m,Q as t};
