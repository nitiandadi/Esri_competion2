import{mZ as se,mK as k,r_ as X,t as x,r as v,l as ie,qi as re,qh as ae,so as le,nq as oe,ng as ne,d8 as z,o as he,aa as de,cI as E,cG as q,d3 as I,fr as B,dh as ce,di as ee,dz as ue,d4 as _e,d2 as ye,n7 as pe,dd as fe,db as me,cW as V,d6 as Q,d0 as ge,a4 as ve,m as Te,B as Ce,sp as f,ke as be,sq as Se,au as P,jt as we,z as G,s as Y,rU as j,a1 as Re,qj as De,e as H,y as O,a as Ee}from"./MapView-d4248bee.js";import{r as Ie,i as Le,l as Pe,t as He,n as Ae}from"./TileInfoViewPOT-9189c119.js";import{i as F,a as m}from"./StyleDefinition-7d58136b.js";import{T as w}from"./enums-b1d611e3.js";import{i as Me}from"./TileContainer-fbbf5053.js";import{l as W}from"./StyleRepository-db0053aa.js";import{f as Oe}from"./LayerView2D-ec9a0ebb.js";import{u as ke}from"./LayerView-374f7208.js";import"./index-9ba3f23e.js";import"./Rect-ea14f53a.js";import"./rasterizingUtils-5a0afdfb.js";import"./enums-4b2a86a0.js";import"./WGLContainer-81305545.js";import"./definitions-19bfb61c.js";import"./WGLBrushVTLSymbol-be6a1f21.js";import"./number-b10bd8f5.js";import"./GeometryUtils-dd03fc25.js";import"./color-f53c4b22.js";import"./ShaderCompiler-77d0dcb6.js";import"./ProgramTemplate-a409eccf.js";import"./MaterialKey-c4205548.js";import"./alignmentUtils-ae955d28.js";import"./utils-88fa6bd3.js";import"./heatmapTextureUtils-d3b5e305.js";import"./Container-3552b7d8.js";import"./EffectView-a19236b0.js";import"./GeometryUtils-53652037.js";const K=512,Ue=1e-6,xe=(r,e)=>r+1/(1<<2*e);class $e{constructor(e,t){this._tiles=new Map,this._tileCache=new se(40,s=>s.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this._container=t}destroy(){for(const[e,t]of this._tiles)t.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);const t=this.tileInfoView,s=t.getTileCoverage(e.state,0,"smallest"),{spans:i,lodInfo:a}=s,{level:o}=a,l=this._tiles,h=new Set,d=new Set;for(const{row:n,colFrom:c,colTo:y}of i)for(let g=c;g<=y;g++){const C=k.getId(o,n,a.normalizeCol(g),a.getWorldForColumn(g)),p=this._getOrAcquireTile(C);h.add(C),p.processed()?this._addToContainer(p):d.add(new k(C))}for(const[n,c]of l)c.isCoverage=h.has(n);for(const n of d)this._findPlaceholdersForMissingTiles(n,h);let u=!1;for(const[n,c]of l)c.neededForCoverage=h.has(n),c.neededForCoverage||c.isHoldingForFade&&t.intersects(s,c.key)&&h.add(n),c.isFading&&(u=!0);for(const[n,c]of this._tiles)h.has(n)||this._releaseTile(n);return X.pool.release(s),!u}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(e,t){const s=[];for(const[a,o]of this._tiles)this._addPlaceholderChild(s,o,e,t);const i=s.reduce(xe,0);Math.abs(1-i)<Ue||this._addPlaceholderParent(e.id,t)}_addPlaceholderChild(e,t,s,i){t.key.level<=s.level||!t.hasData()||Be(s,t.key)&&(this._addToContainer(t),i.add(t.id),e.push(t.key.level-s.level))}_addPlaceholderParent(e,t){const s=this._tiles;let i=e;for(;;){if(i=ze(i),!i||t.has(i))return;const a=s.get(i);if(a&&a.hasData())return this._addToContainer(a),void t.add(a.id)}}_getOrAcquireTile(e){let t=this._tiles.get(e);return t||(t=this._tileCache.pop(e),t||(t=this.acquireTile(new k(e))),this._tiles.set(e,t),t)}_releaseTile(e){const t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}_addToContainer(e){let t;const s=[],i=this._container;if(i.contains(e))return;const a=this._visibleTiles;for(const[o,l]of a)this._canConnectDirectly(e,l)&&s.push(l),x(t)&&this._canConnectDirectly(l,e)&&(t=l);if(v(t)){for(const o of s)t.childrenTiles.delete(o),e.childrenTiles.add(o),o.parentTile=e;t.childrenTiles.add(e),e.parentTile=t}else for(const o of s)e.childrenTiles.add(o),o.parentTile=e;a.set(e.id,e),i.addChild(e)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),v(e.parentTile)){e.parentTile.childrenTiles.delete(e);for(const t of e.childrenTiles)v(e.parentTile)&&e.parentTile.childrenTiles.add(t)}for(const t of e.childrenTiles)t.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,t){const s=e.key;let{level:i,row:a,col:o,world:l}=t.key;const h=this._visibleTiles;for(;i>0;){if(i--,a>>=1,o>>=1,s.level===i&&s.row===a&&s.col===o&&s.world===l)return!0;if(h.has(`${i}/${a}/${o}/${l}`))return!1}return!1}_updateCacheSize(e){const t=e.state.size;if(t[0]===this._viewSize[0]&&t[1]===this._viewSize[1])return;const s=Math.ceil(t[0]/K)+1,i=Math.ceil(t[1]/K)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*s*i}}function ze(r){const[e,t,s,i]=r.split("/"),a=parseInt(e,10);return a===0?null:`${a-1}/${parseInt(t,10)>>1}/${parseInt(s,10)>>1}/${parseInt(i,10)}`}function Be(r,e){const t=e.level-r.level;return r.row===e.row>>t&&r.col===e.col>>t&&r.world===e.world}const Fe=.5,Z=1e-6;class Ne extends ie{constructor(e,t){super(),this.styleRepository=e,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._completed=!1,this._symbolRepository=new Ie(4096,t,()=>new re),this._symbolDeclutterer=new Le(t,this._symbolRepository,(s,i,a)=>new Pe(s,i,a,this.styleRepository,this._zoom,this._viewState.rotation),(s,i)=>{s.allSymbolsFadingOut=!0,s.lastOpacityUpdate=i,ae(s,i,!0),s.decluttered=!0,s.requestRender()},(s,i)=>this.styleRepository.getStyleLayerByUID(s.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(i.styleLayerUID).z,s=>{const i=this.styleRepository.getStyleLayerByUID(s);if(this._zoom+Z<i.minzoom||this._zoom-Z>=i.maxzoom)return!1;const a=i.getLayoutProperty("visibility");return!a||a.getValue()!==F.NONE})}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",()=>{this._symbolRepository.add(e),this.restartDeclutter()})),this._symbolRepository.add(e),this.restartDeclutter()}removeTile(e){const t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}update(e,t){return this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]},this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(e=>e.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(le),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){v(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this.emit("fade-complete")},(1+Fe)*oe)}_notifyUnstable(){v(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}class qe extends ne{_createTransforms(){return{dvs:z(),tileMat3:z()}}}const U=1e-6;function J(r,e){if(r){const t=r.getLayoutProperty("visibility");if(!t||t.getValue()!==F.NONE&&(r.minzoom===void 0||r.minzoom<e+U)&&(r.maxzoom===void 0||r.maxzoom>=e-U))return!0}return!1}class Ve extends Me{constructor(e){super(e),this._backgroundTiles=[],this._pointToCallbacks=new Map}destroy(){var e,t;this.removeAllChildren(),(e=this._spriteMosaic)==null||e.dispose(),this._spriteMosaic=null,(t=this._glyphMosaic)==null||t.dispose(),this._glyphMosaic=null,v(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}setStyleResources(e,t,s){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=s,x(this._symbolFader)){const i=new Ne(this._styleRepository,this.children);i.on("fade-start",()=>{this.emit("fade-start"),this.requestRender()}),i.on("fade-complete",()=>{this.emit("fade-complete"),this.requestRender()}),this._symbolFader=i}he(this._symbolFader).styleRepository=s}setSpriteMosaic(e){var t;(t=this._spriteMosaic)==null||t.dispose(),this._spriteMosaic=e}deleteStyleLayers(e){v(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)}async hitTest(e){const t=de();return this._pointToCallbacks.set(e,t),this.requestRender(),t.promise}enterTileInvalidation(){for(const e of this.children)e.invalidating=!0}createRenderParams(e){return{...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){!this.visible||e.drawPhase!==w.MAP&&e.drawPhase!==w.DEBUG||this._spriteMosaic===void 0||super.doRender(e)}addChild(e){return super.addChild(e),v(this._symbolFader)?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return v(this._symbolFader)&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){const{drawPhase:t}=e;if(t!==w.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){e.drawPhase=w.HITTEST;const s=e.painter.effects.hittestVTL;s.bind(e),this._doRender(e),s.draw(e,this._pointToCallbacks),s.unbind(e),e.drawPhase=t}}else super.renderChildren(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];v(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(e=>e.neededForCoverage&&e.hasData())}restartDeclutter(){v(this._symbolFader)&&this._symbolFader.restartDeclutter()}_doRender(e){const{context:t}=e,s=this._styleRepository;if(!s)return;const i=s.layers;let a=!0;e.drawPhase===w.HITTEST&&(a=!1),s.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,s.backgroundBucketIds)),super.renderChildren(e),e.drawPhase===w.MAP&&this._fade(e.displayLevel,e.state);const o=this.children.filter(l=>l.visible&&l.hasData());if(!o||o.length===0)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(const l of o)l.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(E.KEEP,E.KEEP,E.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(q.LEQUAL),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let l=i.length-1;l>=0;l--)this._renderStyleLayer(i[l],e,o);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(a),t.setBlendFunctionSeparate(I.ONE,I.ONE_MINUS_SRC_ALPHA,I.ONE,I.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let l=0;l<i.length;l++)this._renderStyleLayer(i[l],e,o);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0)}_fade(e,t){v(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,s){const{painter:i,renderPass:a}=t;if(e===void 0)return;const o=e.getLayoutProperty("visibility");if(o&&o.getValue()===F.NONE)return;let l;switch(e.type){case m.BACKGROUND:return;case m.FILL:if(a!=="opaque"&&t.renderPass!=="translucent")return;l="vtlFill";break;case m.LINE:if(a!=="translucent")return;l="vtlLine";break;case m.CIRCLE:if(a!=="translucent")return;l="vtlCircle";break;case m.SYMBOL:if(a!=="translucent")return;l="vtlSymbol"}if(s=e.type===m.SYMBOL?s.filter(d=>d.decluttered):s.filter(d=>d.neededForCoverage),l!=="vtlSymbol"){const d=t.displayLevel;if(s.length===0||e.minzoom!==void 0&&e.minzoom>=d+U||e.maxzoom!==void 0&&e.maxzoom<d-U)return}const h=e.uid;t.styleLayerUID=h,t.styleLayer=e;for(const d of s)if(d.layerData.has(h)){i.renderObjects(t,s,l);break}}_renderBackgroundLayers(e,t){const{context:s,displayLevel:i,painter:a,state:o}=e,l=this._styleRepository;let h=!1;for(const T of t)if(l.getLayerById(T).type===m.BACKGROUND&&J(l.getLayerById(T),i)){h=!0;break}if(!h)return;const d=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),{spans:u,lodInfo:n}=d,{level:c}=n,y=B(),g=[];if(this._renderPasses){const T=this._renderPasses[0];v(this._clippingInfos)&&(T.brushes[0].prepareState(e),T.brushes[0].drawMany(e,this._clippingInfos))}const C=this._backgroundTiles;let p,L=0;for(const{row:T,colFrom:b,colTo:D}of u)for(let S=b;S<=D;S++){if(L<C.length)p=C[L],p.key.set(c,T,n.normalizeCol(S),n.getWorldForColumn(S)),this._tileInfoView.getTileBounds(y,p.key,!1),p.x=y[0],p.y=y[3],p.resolution=this._tileInfoView.getTileResolution(c);else{const M=new k(c,T,n.normalizeCol(S),n.getWorldForColumn(S)),_=this._tileInfoView.getTileBounds(B(),M),te=this._tileInfoView.getTileResolution(c);p=new qe(M,te,_[0],_[3],512,512,4096,4096),C.push(p)}p.setTransform(o),g.push(p),L++}s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(E.KEEP,E.KEEP,E.REPLACE),s.setStencilFunction(q.EQUAL,0,255);let A=!0;e.drawPhase===w.HITTEST&&(A=!1),s.setStencilTestEnabled(A);for(const T of t){const b=l.getLayerById(T);b.type===m.BACKGROUND&&J(b,i)&&(e.styleLayerUID=b.uid,e.styleLayer=b,a.renderObjects(e,g,"vtlBackground"))}X.pool.release(d)}}const Qe={geometry:[new ce("a_PositionAndFlags",3,ee.SHORT,0,6)]},N=new Map;N.set("a_PositionAndFlags",0);const Ge={vsPath:"debug/overlay",fsPath:"debug/overlay",attributes:N};class $ extends ue{constructor(e){super(),this._conf=e}static makeFlags(e,t){return e|t<<2}_createTransforms(){return{dvs:z()}}doRender(e){this._updateTransforms(e),this._ensureResources(e);const{context:t}=e;t.useProgram(this._program),this._program.setUniformMatrix3fv("u_dvsMat3",this.transforms.dvs),this._program.setUniform4fv("u_colors",this._conf.getColors(e)),this._program.setUniform1fv("u_opacities",this._conf.getOpacities(e));const{vertexData:s,indexData:i}=this._conf.getMesh(e);this._vertexBuffer.setData(s),this._indexBuffer.setData(i),t.bindVAO(this._vertexArray),t.setBlendingEnabled(!0),t.setBlendFunction(I.ONE,I.ONE_MINUS_SRC_ALPHA),t.setDepthTestEnabled(!1),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawElements(_e.TRIANGLES,i.length,ee.UNSIGNED_INT,0)}onDetach(){this._vertexArray=ye(this._vertexArray)}_updateTransforms(e){pe(this.transforms.dvs),fe(this.transforms.dvs,this.transforms.dvs,[-1,1]),me(this.transforms.dvs,this.transforms.dvs,[2/e.state.size[0],-2/e.state.size[1],1])}_ensureResources(e){const{context:t}=e;this._program||(this._program=e.painter.materialManager.getProgram(Ge)),this._vertexBuffer||(this._vertexBuffer=V.createVertex(t,Q.STREAM_DRAW)),this._indexBuffer||(this._indexBuffer=V.createIndex(t,Q.STREAM_DRAW)),this._vertexArray||(this._vertexArray=new ge(t,N,Qe,{geometry:this._vertexBuffer},this._indexBuffer))}}let R=class extends Oe(ke){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._collisionOverlay=null,this.fading=!1,this._getCollidersMesh=r=>{const{pixelRatio:e}=r.state;let t=0;const s=[],i=[];for(const a of this._vectorTileContainer.children)if(a.symbols)for(const[o,l]of a.symbols)for(const h of l)for(const d of h.colliders){const u=(d.xScreen+d.dxScreen)*e,n=(d.yScreen+d.dyScreen)*e,c=d.width*e,y=d.height*e,g=h.unique.parts[d.partIndex].targetOpacity>.5;if(!g&&this.layer.showCollisionBoxes!=="all")continue;const C=3,p=1,L=3,A=0,T=g?2:0,b=g?3:0,D=$.makeFlags(T,b);s.push(u,n,D,u+c,n,D,u,n+y,D,u+c,n+y,D),i.push(t+0,t+1,t+2,t+1,t+3,t+2),t+=4;const S=g?C:p,M=g?L:A,_=$.makeFlags(S,M);s.push(u,n,_,u+c,n,_,u,n+1,_,u+c,n+1,_),i.push(t+0,t+1,t+2,t+1,t+3,t+2),t+=4,s.push(u,n+y-1,_,u+c,n+y-1,_,u,n+y,_,u+c,n+y,_),i.push(t+0,t+1,t+2,t+1,t+3,t+2),t+=4,s.push(u,n,_,u+1,n,_,u,n+y,_,u+1,n+y,_),i.push(t+0,t+1,t+2,t+1,t+3,t+2),t+=4,s.push(u+c-1,n,_,u+c,n,_,u+c-1,n+y,_,u+c,n+y,_),i.push(t+0,t+1,t+2,t+1,t+3,t+2),t+=4}return{vertexData:new Int16Array(s),indexData:new Uint32Array(i)}},this._getCollidersColors=()=>[1,.5,0,1,1,0,0,1,0,1,.5,1,0,.5,0,1],this._getCollidersOpacities=()=>[.05,.01,.15,.2]}async hitTest(r,e){if(!this._tileHandlerPromise)return null;await this._tileHandlerPromise;const t=await this._vectorTileContainer.hitTest(e);if(!t||t.length===0)return null;const s=t[0]-1,i=this._styleRepository,a=i.getStyleLayerByUID(s);if(!a)return null;const o=i.getStyleLayerIndex(a.id);return[{type:"graphic",mapPoint:r,layer:this.layer,graphic:new ve({attributes:{layerId:o,layerName:a.id,layerUID:s},layer:this.layer,sourceLayer:this.layer})}]}update(r){if(this._tileHandlerPromise&&this._isTileHandlerReady)return r.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=r.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=r.state,this._parseQueue.state=r.state,this._tileManager.update(r)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:r}=this.layer.currentStyleInfo;this._styleRepository=new W(r),this._tileInfoView=new He(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Ve(this._tileInfoView),this._tileHandler=new Ae(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this._vectorTileContainer.on("fade-start",()=>{this.fading=!0,this.notifyChange("updating"),this.requestUpdate()}),this._vectorTileContainer.on("fade-complete",()=>{var e;(e=this._collisionOverlay)==null||e.requestRender(),this.fading=!1,this.notifyChange("updating"),this.requestUpdate()}),Te(()=>this.layer.showCollisionBoxes,e=>{e!=="none"?this._collisionOverlay||(this._collisionOverlay=new $({getMesh:this._getCollidersMesh,getColors:this._getCollidersColors,getOpacities:this._getCollidersOpacities}),this.container.addChild(this._collisionOverlay)):this._collisionOverlay&&(this.container.removeChild(this._collisionOverlay),this._collisionOverlay=null),this.container.requestRender()},Ce),this.layer.on("paint-change",e=>{if(e.isDataDriven)this._styleChanges.push({type:f.PAINTER_CHANGED,data:e}),this.notifyChange("updating"),this.requestUpdate();else{const t=this._styleRepository,s=t.getLayerById(e.layer);if(!s)return;const i=s.type===m.SYMBOL;t.setPaintProperties(e.layer,e.paint),i&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender()}}),this.layer.on("layout-change",e=>{const t=this._styleRepository,s=t.getLayerById(e.layer);if(!s)return;const i=be(s.layout,e.layout);if(!x(i)){if(Se(i,"visibility")&&Ye(i)===1)return t.setLayoutProperties(e.layer,e.layout),s.type===m.SYMBOL&&this._vectorTileContainer.restartDeclutter(),void this._vectorTileContainer.requestRender();this._styleChanges.push({type:f.LAYOUT_CHANGED,data:e}),this.notifyChange("updating"),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",e=>{const t=this._styleRepository,s=t.getLayerById(e.layer);s&&(t.setStyleLayerVisibility(e.layer,e.visibility),s.type===m.SYMBOL&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender())}),this.layer.on("style-layer-change",e=>{this._styleChanges.push({type:f.LAYER_CHANGED,data:e}),this.notifyChange("updating"),this.requestUpdate()}),this.layer.on("delete-style-layer",e=>{this._styleChanges.push({type:f.LAYER_REMOVED,data:e}),this.notifyChange("updating"),this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",e=>{this._newSpriteSource=e.spriteSource,this._styleChanges.push({type:f.SPRITES_CHANGED,data:null});const t=this._styleRepository.layers;for(const s of t)switch(s.type){case m.SYMBOL:s.getLayoutProperty("icon-image")&&this._styleChanges.push({type:f.LAYOUT_CHANGED,data:{layer:s.id,layout:s.layout}});break;case m.LINE:s.getPaintProperty("line-pattern")&&this._styleChanges.push({type:f.PAINTER_CHANGED,data:{layer:s.id,paint:s.paint,isDataDriven:s.isPainterDataDriven()}});break;case m.FILL:s.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:f.PAINTER_CHANGED,data:{layer:s.id,paint:s.paint,isDataDriven:s.isPainterDataDriven()}})}this.notifyChange("updating"),this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=P(this._vectorTileContainer),this._tileHandler=P(this._tileHandler)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this._collisionOverlay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate()}supportsSpatialReference(r){var e;return we((e=this.layer.tileInfo)==null?void 0:e.spatialReference,r)}canResume(){let r=super.canResume();const{currentStyleInfo:e}=this.layer;if(r&&(e!=null&&e.layerDefinition)){const t=this.view.scale,{minScale:s,maxScale:i}=e.layerDefinition;e&&e.layerDefinition&&(s&&s<t&&(r=!1),i&&i>t&&(r=!1))}return r}isUpdating(){const r=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||r.length>0&&r.some(e=>e.invalidating)||this.fading}acquireTile(r){var t;const e=this._createVectorTile(r);return(t=this._tileHandlerPromise)==null||t.then(()=>{this._fetchQueue.push(e.key).then(s=>this._parseQueue.push({key:e.key,data:s})).then(s=>{e.once("attach",()=>this.requestUpdate()),e.setData(s),this.requestUpdate(),this.notifyChange("updating")}).catch(s=>{this.notifyChange("updating"),G(s)||Y.getLogger(this.declaredClass).error(s)})}),e}releaseTile(r){const e=r.key.id;this._fetchQueue.abort(e),this._parseQueue.abort(e),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new $e({acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const r=new AbortController,e=this._tileHandler.start({signal:r.signal}).then(()=>{this._fetchQueue=new j({tileInfoView:this._tileInfoView,process:(t,s)=>this._getTileData(t,s),concurrency:15}),this._parseQueue=new j({tileInfoView:this._tileInfoView,process:(t,s)=>this._parseTileData(t,s),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(t=>{this._vectorTileContainer.setStyleResources(t,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate()}),this._tileHandlerAbortController=r,this._tileHandlerPromise=e}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const r=this._tileHandlerAbortController;r&&r.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=P(this._fetchQueue),this._parseQueue=P(this._parseQueue),this._tileManager=P(this._tileManager),this._vectorTileContainer.removeAllChildren()}async _getTileData(r,e){const t=await this._tileHandler.fetchTileData(r,e);return this.notifyChange("updating"),t}async _parseTileData(r,e){return this._tileHandler.parseTileData(r,e)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache();const r=this._styleChanges;try{await this._tileHandler.updateStyle(r)}catch(o){Y.getLogger(this.declaredClass).error("error applying vector-tiles style update",o.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0}const e=this._styleRepository,t=[];r.forEach(o=>{if(o.type!==f.LAYER_REMOVED)return;const l=o.data,h=e.getLayerById(l.layer);h&&t.push(h.uid)});const s=[];let i;r.forEach(o=>{const l=o.type,h=o.data;switch(l){case f.PAINTER_CHANGED:e.setPaintProperties(h.layer,h.paint),i=h.layer;break;case f.LAYOUT_CHANGED:e.setLayoutProperties(h.layer,h.layout),i=h.layer;break;case f.LAYER_REMOVED:return void e.deleteStyleLayer(h.layer);case f.LAYER_CHANGED:e.setStyleLayer(h.layer,h.index),i=h.layer.id;break;case f.SPRITES_CHANGED:this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(this._newSpriteSource)),this._newSpriteSource=null,i=null}const d=e.getLayerById(i);d&&s.push(d.uid)});const a=this._vectorTileContainer.children;if(t.length>0){this._vectorTileContainer.deleteStyleLayers(t);for(const o of a)o.deleteLayerData(t)}if(this._fetchQueue.resume(),this._parseQueue.resume(),s.length>0){const o=[];for(const l of a){const h=this._fetchQueue.push(l.key).then(d=>this._parseQueue.push({key:l.key,data:d,styleLayerUIDs:s})).then(d=>l.setData(d));o.push(h)}await Promise.all(o)}this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}async _loadStyle(){const{style:r}=this.layer.currentStyleInfo,e=Re(r);this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new W(e),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:t}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,e),await this._tileHandlerPromise}catch(i){if(!G(i))throw i}if(t.aborted)return this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate();const s=await this._tileHandler.spriteMosaic;this._vectorTileContainer.setStyleResources(s,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}_createVectorTile(r){const e=this._tileInfoView.getTileBounds(B(),r),t=this._tileInfoView.getTileResolution(r.level);return new De(r,t,e[0],e[3],512,512,this._styleRepository)}};function Ye(r){if(x(r))return 0;switch(r.type){case"partial":return Object.keys(r.diff).length;case"complete":return Math.max(Object.keys(r.oldValue).length,Object.keys(r.newValue).length);case"collection":return Object.keys(r.added).length+Object.keys(r.changed).length+Object.keys(r.removed).length}}H([O()],R.prototype,"_fetchQueue",void 0),H([O()],R.prototype,"_parseQueue",void 0),H([O()],R.prototype,"_isTileHandlerReady",void 0),H([O()],R.prototype,"fading",void 0),R=H([Ee("esri.views.2d.layers.VectorTileLayerView2D")],R);const Ct=R;export{Ct as default};
