import{fz as ei,dE as ti,qG as ii,qH as ni,jt as si,r as p,r0 as ai,t as g,fS as ze,cR as De,d9 as $e,bY as M,r1 as oi,r2 as ri,fD as E,hz as v,qA as li,c4 as Ne,r3 as st,hN as at,fT as ot,fJ as k,h2 as N,g_ as I,iE as Ct,hB as te,gL as di,fq as Ye,g$ as we,c1 as ae,r4 as rt,gi as ci,oB as Ve,e as d,y as u,a as W,v as pe,bn as Ke,au as de,m as P,C as V,g9 as ui,s as bt,bg as $,hr as hi,gC as Le,fL as me,hH as oe,r5 as ke,gv as Ot,hO as pi,j5 as $t,js as xt,bM as L,gq as Me,r6 as mi,bS as J,hx as Ge,hp as Ie,gt as Tt,iM as lt,iQ as gi,r7 as fi,iG as _i,gs as w,r8 as vi,qp as yi,qK as Y,j0 as dt,r9 as Si,gw as ct,gx as ut,jm as wi,i3 as ht,iu as Mi,h7 as Pi,c0 as Fe,B as Ue,w as Ci,c3 as pt,bK as Ze,ra as Be,gA as ne,bZ as bi,b_ as Oi,gU as $i,he as We,rb as xi,cQ as Ti,rc as zi,gr as Di,jr as Ai,gy as Ri,rd as zt,qQ as Hi,qR as Ei,o as mt,re as Vi,rf as Li,rg as ie,at as ki,aw as Gi,f as Dt,bo as gt,c5 as ft}from"./MapView-d4248bee.js";import{n as At,g as j,b as Ii,c as Fi,a as Ui}from"./LineVisualElement-610e4bd1.js";import{t as y,r as Bi,u as Wi}from"./LengthDimension-da1c4464.js";import{i as ji}from"./viewUtils-653374a2.js";import{a as qi,v as Rt,f as K,g as Ni,b as Yi}from"./Segment-9922a109.js";import{N as Ki,i as Ht,b as re,c as Et,d as Zi,D as Qi,x as ge,V as Qe,w as Je,C as Ji,U as Xi,v as _t,a as en}from"./AnalysisToolBase-c69e0046.js";import{B as tn,C as Vt,z as Xe}from"./dragEventPipeline3D-f09aab35.js";import{W as Lt,t as nn,a as sn,h as an,m as on,b as rn,e as ln,x as dn,c as vt}from"./SnappingOperation-24685952.js";import{o as cn}from"./Factory-585937a9.js";import{c as un}from"./ImageMaterial-b196cc20.js";import{V as hn,g as pn,w as mn}from"./EditGeometryOperations-7a18c435.js";import{r as gn}from"./RenderTexture-16babd20.js";import{s as fn,m as _n,c as vn}from"./analysisViewUtils-678f2875.js";import"./index-9ba3f23e.js";import"./VisualElement-62e5dd07.js";import"./elevationInfoUtils-be893fde.js";import"./RightAngleQuadVisualElement-7f36d6f3.js";import"./VisualElementResources-d63a6ee6.js";import"./PointVisualElement-97fe269b.js";import"./QueryEngineResult-000a2eb4.js";import"./WhereClause-34fcc82f.js";import"./executionError-fb3f283a.js";import"./utils-5fb83578.js";import"./ClassBreaksDefinition-6b9f5256.js";import"./projectionSupport-96272605.js";import"./json-48e3ea08.js";import"./utils-f77fba44.js";import"./dehydratedFeatureComparison-0ac2f54e.js";function yn(t){const e=ei(t),i=e===ii?ni:e;return ti(t,i)?i:t}var X;function Sn(t,e){const{spatialReference:i}=t;return si(i,e.spatialReference)?(fe[0]=t.x,fe[1]=t.y,fe[2]=t.hasZ?t.z:0,_e[0]=e.x,_e[1]=e.y,_e[2]=e.hasZ?e.z:0,kt(fe,_e,i)):null}function kt(t,e,i){const n=wn(t,e,i,X.Direct);return p(n)?qi(n.direct,n.unit):null}function wn(t,e,i,n){const s=yn(i),a=ai(s);if(g(a))return null;const o=e[2]-t[2];if(n===X.Vertical)return{verticalSigned:o,unit:a};if(!ze(t,i,Ae,s)||!ze(e,i,ve,s))return null;if(n===X.Direct)return{direct:De(ve,Ae),unit:a};if($e(ye,t[0],t[1],e[2]),!ze(ye,i,ye,s))return null;const r=De(ye,ve);return n===X.Horizontal?{horizontal:r,unit:a}:{direct:De(ve,Ae),horizontal:r,vertical:Math.abs(o),unit:a}}(function(t){t[t.Direct=0]="Direct",t[t.Horizontal=1]="Horizontal",t[t.Vertical=2]="Vertical"})(X||(X={}));const fe=M(),_e=M(),Ae=M(),ve=M(),ye=M();function Mn(t,e,i){if(g(t))return null;const n=t.dimensionSegment.startRenderSpace,s=t.dimensionSegment.endRenderSpace,a=kt(n,s,t.spatialReference);if(g(a))return null;const o=e===y.Vertical?oi(a.value,a.unit,i):ri(a.value,a.unit,i);return Rt(a,o)}function Pe(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:s,orientation:a}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,offset:n,measureType:s,orientation:a}}function Ce({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:i,measureType:n,orientation:s},a,o=null){if(g(t)||g(e))return null;const r=It(p(o)?o.directSegment:new K,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},a),l=p(o)?o.primaryOffsetAxis:M();xe(l,{measureType:n,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:r,orientation:s,renderCoordsHelper:a});const c=p(o)?o.dimensionSegment:new K;return et({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&n===y.Vertical?(E(c.startRenderSpace,r.startRenderSpace),E(c.endRenderSpace,r.endRenderSpace)):Ft(c,{offsetAxis:l,offset:i,relativeToSegment:r,renderCoordsHelper:a}),{directSegment:r,dimensionSegment:c,primaryOffsetAxis:l,spatialReference:a.spatialReference}}function yt(t,e,i,n){return e===ce.Start?(E(t.startRenderSpace,i.startRenderSpace),E(t.endRenderSpace,n.startRenderSpace)):(E(t.startRenderSpace,i.endRenderSpace),E(t.endRenderSpace,n.endRenderSpace)),t}var ce;function Pn(t,e,i,n){we(t.startRenderSpace,e.startRenderSpace,i,n),we(t.endRenderSpace,e.endRenderSpace,i,n)}function Gt(t,e,i,n){switch(e){case y.Direct:return It(t,i,n);case y.Horizontal:case y.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,dimension:o,geometry:r}=i;let l;o.measureType===y.Direct?(l=Cn(r,n)===s.z>a.z,e===y.Horizontal&&(l=!l)):l=!bn(r);const[c,h]=l?[s,a]:[a,s],m=ae(h,On);return e===y.Horizontal?m.z=c.z:(m.x=c.x,m.y=c.y),n.toRenderCoords(c,t.startRenderSpace),n.toRenderCoords(m,t.endRenderSpace),t}}}function It(t,e,i){return i.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),i.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}function Cn(t,e){const i=t.directSegment.eval(.5,v.get()),n=e.worldUpAtPosition(i,v.get()),s=t.dimensionSegment.eval(.5,v.get()),a=k(v.get(),s,i);return!Ct(a,te)&&I(a,n)>0}function bn(t){const{startRenderSpace:e,endRenderSpace:i}=t.dimensionSegment,{startRenderSpace:n,endRenderSpace:s}=t.directSegment;return rt(n,e)<rt(s,i)}(function(t){t[t.Start=0]="Start",t[t.End=1]="End"})(ce||(ce={}));const On=ci(0,0,0,null);function $n(t,e,i,n){const{directSegment:s}=i,a=xe(v.get(),{measureType:e,directSegment:s,renderCoordsHelper:n}),o=Ft(xn,{offsetAxis:a,offset:0,relativeToSegment:s,renderCoordsHelper:n}).eval(.5,v.get()),r=k(v.get(),t,o);return I(r,a)*n.unitInMeters}const xn=new K;function xe(t,e){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:a,endRenderSpace:o},directSegment:r,renderCoordsHelper:l}=e,c=r.eval(.5,v.get()),h=l.worldUpAtPosition(c,v.get()),m=l.worldBasisAtPosition(c,li.Y,v.get());switch(i){case y.Horizontal:E(t,h);break;case y.Vertical:I(a,h)<I(o,h)?k(t,o,a):k(t,a,o),N(t,t,h),N(t,t,h);break;case y.Direct:{const f=Ne(e.orientation,0);if(et({elevationAlignedStartPoint:n,elevationAlignedEndPoint:s}))st(Se,-at(f),h),ot(t,m,Se);else{const b=k(v.get(),o,a),O=N(v.get(),b,h);N(O,O,b),st(Se,at(f),b),ot(t,O,Se)}break}}return Ct(t,te)?E(t,m):di(t,t)}const Se=Ye();function et({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return p(t)&&p(e)&&t.x===e.x&&t.y===e.y}function Ft(t,e){const{offsetAxis:i,offset:n,relativeToSegment:{startRenderSpace:s,endRenderSpace:a},relativeToSegment:o,renderCoordsHelper:r}=e,l=n/r.unitInMeters,[c,h]=Tn(s,a,i,l);return we(t.startRenderSpace,o.startRenderSpace,i,c),we(t.endRenderSpace,o.endRenderSpace,i,h),t}function Tn(t,e,i,n=0){const s=I(e,i),a=I(t,i),o=Math.abs(s-a)+n;return s>a?[o,n]:[n,o]}function Te(t,e,i){const n=e.directSegment.eval(.5,v.get());return i.worldUpAtPosition(n,t)}function tt(t,e){const{startRenderSpace:i,endRenderSpace:n}=e.directSegment;return k(t,n,i)}function it(t,e,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:s}=e.dimensionSegment;return i.invert?k(t,n,s):k(t,s,n)}function je(t,e){const i=t.directSegment.eval(.5,v.get());return e.headingAtPosition(i,t.primaryOffsetAxis)}function zn(t,e){return Ve(it(Dn,t))/e**2}const Dn=M();function Ut(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i}=t;if(g(e)||g(i))return!1;const n=Sn(e,i);return p(n)&&Rt(n,"meters").value>Bt}const Bt=1e5;function ue(t){return p(t.geometry)}let q=class extends pe{constructor(e){super(e),this._handles=new Ke}initialize(){const{computations:e}=this.analysisViewData;for(const i of e)this._addComputation(i);this.addHandles(e.on("change",({added:i,removed:n})=>{for(const s of n)this._removeComputation(s);for(const s of i)this._addComputation(s)}))}destroy(){this._handles=de(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return ji(this.view)}_addComputation(e){this._handles.has(e)||this._handles.add(P(()=>Pe(e),i=>{const{measureType:n}=i;if(Ut(i)&&n!==y.Direct){const a=Math.round(ui(Bt,"meters","kilometers"));return bt.getLogger(this.declaredClass).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${a} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const s=Ce(i,this.view.renderCoordsHelper,e.geometry);e.geometry=s,e.result.length=Mn(s,n,this._defaultUnit)},V),e)}_removeComputation(e){this._handles.remove(e)}};d([u({constructOnly:!0})],q.prototype,"analysisViewData",void 0),d([u({constructOnly:!0})],q.prototype,"view",void 0),d([u()],q.prototype,"analysis",null),d([u()],q.prototype,"_defaultUnit",null),q=d([W("esri.views.3d.analysis.Dimension.support.DimensionController")],q);const Wt={main:new $([255,127,0])};class An{constructor(){this.color=Wt.main,this.opacity=.5,this.radius=5}}class Rn{constructor(){this.color=new $([127,127,127]),this.opacity=.5,this.radius=5}}class Hn{constructor(){this.lineSizeFraction=.8}}let En=class{constructor(){this.color=Wt.main,this.opacity=.5,this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}};class Vn{constructor(){this.calloutOffsetPx=18,this.calloutOpacity=.5,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2}}let Ln=class{constructor(){this.lineSizeFraction=.25}},kn=class{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}},Gn=class{constructor(){this.color=new $([255,127,0,.5])}},In=class{constructor(){this.pointManipulators=new An,this.offsetManipulator=new En,this.orientationManipulator=new Vn,this.markers=new Hn,this.labels=new kn,this.offsetLine=new Ln,this.constraint=new Gn,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new Rn,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}};const S=new In;class Fn{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&e===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const i of Bi)e(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(e){switch(e){case y.Direct:return this.direct;case y.Horizontal:return this.horizontal;case y.Vertical:return this.vertical}}}function Un(t,e){const i=Ki(t,$.toUnitRGB(S.pointManipulators.color),S.pointManipulators.opacity,G);return i.available=!1,i.grabCursor="crosshair",i.radius=S.pointManipulators.radius,i.metadata=e.metadata,i.collisionPriority=1,i}function Bn(t,e){const i=[Me(-.5,0,0),Me(.5,0,0)],{lengthFraction:n}=S.offsetManipulator,s=Le(e.unfocusedMaterial,i.map(o=>me(M(),o,n))),a=s.instantiate({material:e.focusedMaterial});return new Ht({view:t,renderObjects:[new re(s,oe.Unfocused|oe.Selected|G),new re(a,oe.Focused|G)],collisionType:{type:"line",paths:[i]},radius:nt(e.lineSizePt)/2,metadata:e.metadata,available:!1,...Et})}function jt(t,{lineSizePt:e,material:i}){const{calloutOffsetPx:n,calloutOpacity:s,calloutWidth:a,discScale:o,focusMultiplier:r}=S.orientationManipulator;return{calloutLength:.25*mi*S.markers.lineSizeFraction*L(e)+n,calloutOpacity:s,calloutWidth:a,customStateMask:G,discScale:o,focusMultiplier:r,material:i,metadata:t}}function St(t,e){return Zi(t,jt(e.metadata,e))}function wt(t,e){Qi(t,jt(t.metadata,e))}function Wn(t,e){const i=[Me(-.5,0,0),Me(.5,0,0)],{lengthFraction:n}=S.offsetManipulator,s=Le(e.thinOffsetManipulatorMaterial,i),a=Le(e.unfocusedMaterial,i.map(r=>me(M(),r,n))),o=a.instantiate({material:e.focusedMaterial});return new Ht({view:t,renderObjects:[new re(a,oe.Unfocused|G),new re(o,oe.Focused|G),new re(s,G)],collisionType:{type:"line",paths:[i]},radius:nt(e.lineSizePt)/2,available:!1,metadata:e.metadata,...Et})}function jn(t,{isStart:e,createSnappingPipelineStep:i,dimension:n,onUpdate:s,view:a}){const o=e?"startPoint":"endPoint";return[ge(t,(l,c,h,m)=>{const f=Xe(l),{snappingStep:b,cancelSnapping:O}=i(m);h=h.next(f).next(Je(n,[o,"measureType","orientation"])).next(O),c.next(f).next(tn(a)).next(...b).next(z=>{const C=ae(z.mapEnd,new J);s(o==="startPoint"?{startPoint:C}:{endPoint:C})})})]}function qn(t,{computation:e,view:i}){return[ge(t,(n,s,a)=>{if(!ue(e)||!n.selected)return;const{geometry:o,dimension:r}=e,l=Xe(n);s.next(l).next(Nt(i,r,o.dimensionSegment,o.primaryOffsetAxis)),a.next(l).next(Je(r,["offset"]))})]}function Nn(t,{computation:e,view:i}){return[ge(t,(n,s,a)=>{qt({cancel:a,computation:e,settingHeading:!0,steps:s,view:i})})]}function Yn(t,{computation:e,view:i}){return[ge(t,(n,s,a)=>{qt({cancel:a,computation:e,settingHeading:!1,steps:s,view:i})}),t.events.on("immediate-click",n=>{Kn(n,e,i)})]}function Kn(t,e,i){const{dimension:n,geometry:s}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void t.stopPropagation();if(g(s))return;const{renderCoordsHelper:a}=i,o=Ce({...Pe(e),orientation:90},a),r=Ce({...Pe(e),orientation:270},a);if(g(o)||g(r))return;const l=je(o,a),c=je(r,a),h=Yt(s,i),m=ke.shortestSignedDiff(h,l),f=ke.shortestSignedDiff(h,c);n.orientation=Math.abs(m)<Math.abs(f)?90:270,t.stopPropagation()}function qt(t){const{cancel:e,computation:i,settingHeading:n,steps:s,view:a}=t;if(!ue(i))return;const{renderCoordsHelper:o}=a,{dimension:r,geometry:l}=i,c=M(),h=Zt(M(),l,l.directSegment,o),m=Qt(v.get(),{forHeading:n,geometry:l,renderCoordsHelper:o}),f=Ge(h,m,Ie()),b=Ne(r.orientation,n?()=>je(l,a.renderCoordsHelper):0);s.next(Vt(a,f)).next(O=>{O.action==="start"&&E(c,O.renderStart);const z=gi(f),C=Ji(c,O.renderEnd,h,z);let F=b-fi(C);n||(F=Zn(F)),r.orientation=F}),e.next(Je(r,["orientation"]))}function Zn(t){const e=ke.normalize(t)%90;return e<S.orientationSnapThresholdDegrees?t-e:90-e<S.orientationSnapThresholdDegrees?t+(90-e):t}function Qn(t,{computation:e,manipulatorMeasureType:i,view:n}){let s=y.Direct,a=0,o=0;return[t.events.on("grab-changed",r=>{if(r.action!=="start"||!ue(e))return;const{dimension:l,geometry:c}=e;s=l.measureType,a=l.offset,o=l.orientation;const h=E(v.get(),t.renderLocation);l.measureType=i,l.offset=$n(h,i,c,n.renderCoordsHelper),l.orientation=0}),ge(t,(r,l,c)=>{if(!ue(e))return;const{geometry:h,dimension:m}=e,{renderCoordsHelper:f}=n,b=Gt(Jt,i,e,f),O=xe(v.get(),{measureType:i,directSegment:h.directSegment,renderCoordsHelper:f}),z=Xe(r);l.next(z).next(Nt(n,m,b,O)),c.next(z).next(C=>(m.measureType=s,m.offset=a,m.orientation=o,C))})]}function Nt(t,e,i,n){const s=Tt(v.get(),i.endRenderSpace,i.startRenderSpace);N(s,s,n);const a=Ge(i.startRenderSpace,s,Ie()),o=Ge(i.startRenderSpace,n,Ie()),r=e.offset;let l,c=0;const h=new Xi;return h.next(Vt(t,a)).next(m=>{m.action==="start"&&(c=lt(o,m.renderStart));const f=(lt(o,m.renderEnd)-c)*t.renderCoordsHelper.unitInMeters;e.offset=r+f,l=m}),m=>(h.execute(m),l)}function Yt(t,e){const{directSegment:i}=t,{renderCoordsHelper:n}=e,s=Te(v.get(),t,n),a=tt(v.get(),t),o=N(v.get(),a,s),{viewForward:r}=e.state.camera;I(o,r)>0&&me(o,o,-1);const l=i.eval(.5,v.get());return n.headingAtPosition(l,o)}function Jn(t,e,i){const{dimensionSegment:n,primaryOffsetAxis:s}=e,a=it(le,e),o=Ot(a,te)?pi(be):Qe(a,s,te,be),r=Math.max($t(a),S.offsetManipulator.minLengthMeters/i.unitInMeters);xt(o,o,$e(le,r,r,r)),t.modelTransform=o,t.renderLocation=n.eval(.5,le)}function Xn(t,e,i){Kt(t,e,i,{forHeading:!0})}function es(t,e,i){Kt(t,e,i,{forHeading:!1})}function Kt(t,e,i,{forHeading:n}){const{dimension:s,geometry:a}=e,{primaryOffsetAxis:o}=a,r=me(ts,o,s.offset>=0?1:-1),l=Qt(is,{forHeading:n,geometry:a,renderCoordsHelper:i});N(l,l,r);const c=Qe(r,l,te,be);t.modelTransform=c,t.renderLocation=Zt(le,a,a.dimensionSegment,i)}const ts=M(),is=M();function ns(t,e,i,n){const{geometry:s}=e,a=Gt(Jt,i,e,n),o=xe(le,{measureType:i,directSegment:s.directSegment,renderCoordsHelper:n}),r=k(Re,a.endRenderSpace,a.startRenderSpace),l=Qe(r,o,te,be),c=$t(r);xt(l,l,$e(Re,c,c,c)),t.modelTransform=l,t.renderLocation=a.eval(.5,Re)}function Zt(t,e,i,n){const{startRenderSpace:s,endRenderSpace:a}=i,o=ss(e,n)?s:a;return E(t,o)}function Qt(t,{forHeading:e,geometry:i,renderCoordsHelper:n}){return e?Te(t,i,n):it(t,i,{invert:!0})}function ss(t,e){const i=tt(as,t),n=Te(os,t,e);return I(i,n)>0}const as=M(),os=M();function rs(t){return L(t)+S.offsetManipulator.linePaddingPx}function nt(t){return L(t)+S.offsetManipulator.focusedLinePaddingPx}const G=hi.Custom1,le=M(),Re=M(),be=Ye(),Jt=new K;var R;function ls(t,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,geometry:t.geometry}}function ds(t,e){if(Ut(t))return R.Direct;if(!t.enabled)return null;const{geometry:i}=t;if(g(i)||Ot(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{constraintThresholdPx:n}=S,{camera:s}=e.state,a=Te(v.get(),i,e.renderCoordsHelper),o=tt(v.get(),i),r=me(v.get(),a,I(o,a)),l=Tt(v.get(),o,r),c=Ve(l),h=Ve(r),{startRenderSpace:m,endRenderSpace:f}=i.directSegment,b=Math.max(s.computeRenderPixelSizeAt(m)*n,s.computeRenderPixelSizeAt(f)*n)**2;return c<b?R.Vertical:h<b?R.Horizontal:null}function cs(t,e,{constraint:i,view:n}){const{unconstrainedGeometry:s}=t;if(g(s))return;const{renderCoordsHelper:a,spatialReference:o}=n,{startRenderSpace:r,endRenderSpace:l}=s.directSegment,c=a.fromRenderCoords(r,new J,o),h=a.fromRenderCoords(l,new J,o);let m;m=e==="start"?{startPoint:c}:{endPoint:h},Xt(t,m,{constraint:i,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,unconstrainedGeometry:s,view:n})}function Xt(t,e,i){const{constraint:n,elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,unconstrainedGeometry:o,view:r}=i,{dimension:l,previousConstraint:c,preConstraintProperties:h}=t;if(g(s)||g(a))return;const m=()=>{"startPoint"in e?l.startPoint=e.startPoint:"endPoint"in e&&(l.endPoint=e.endPoint)};if(g(n))m(),p(c)&&p(h)&&(l.measureType=h.measureType,l.orientation=h.orientation);else switch(l.measureType=y.Direct,n){case R.Horizontal:if(n!==c&&(l.orientation=0),"startPoint"in e){const f=e.startPoint;p(f)&&(f.z=a.z),l.startPoint=f}else if("endPoint"in e){const f=e.endPoint;p(f)&&(f.z=s.z),l.endPoint=f}break;case R.Vertical:if(n!==c&&(l.orientation=Yt(o,r)),"startPoint"in e){const f=e.startPoint;p(f)&&(f.x=a.x,f.y=a.y),l.startPoint=f}else if("endPoint"in e){const f=e.endPoint;p(f)&&(f.x=s.x,f.y=s.y),l.endPoint=f}break;case R.Direct:n!==c&&p(h)&&(l.orientation=h.orientation),m()}t.previousConstraint=n,t.unconstrainedGeometry=o}(function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Direct=2]="Direct"})(R||(R={}));const _={main:new $([255,127,0]),selected:new $([255,255,255]),staged:new $([12,207,255]),outline:new $([0,0,0,.5]),selectedOutline:new $([255,255,255])},ee=.3;function he(t,e){const i=t.clone();return i.a*=e,i}function us(t,e){const i=t.clone(),n=vi(i);n.s*=e;const s=yi(n);return i.r=s.r,i.g=s.g,i.b=s.b,i}function H(t,e){if(e)for(const i in e)t[i]=e[i]}class hs{constructor(e){this.color=_.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=w.Opaque,H(this,e)}}let He=class{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=_.main,this.outlineColor=_.outline,this.renderOccluded=w.Opaque,this.hoverOutlineColor=_.selectedOutline,H(this,e)}apply(e,i){const n=this[e];i.setParameters({color:B(n),transparent:e!=="color"||n.a<1,renderOccluded:this.renderOccluded})}},ps=class{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=he(_.main,.5),this.hoverColor=_.main,this.renderOccluded=w.Transparent,this.minSquaredEdgeLength=900,H(this,e)}apply(e,i){const n=this[e];i.setParameters({color:B(n),transparent:n.a<1,renderOccluded:this.renderOccluded})}};class ms{constructor(e){this.vertex=new He({color:_.main,outlineColor:_.outline}),this.edge=new He({color:us(he(_.main,2/3),.5),outlineColor:he(_.outline,.5),size:8,collisionPadding:8}),this.selected=new He({color:_.selected,outlineColor:_.outline}),this.edgeOffset=new ps,H(this,e)}}let qe=class{constructor(e){this.color=_.selected,this.width=1.5,this.stipplePattern=Y(5),this.stippleOffColor=_.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=_.selected,this.renderOccluded=w.OccludeAndTransparent,H(this,e)}apply(e){e.color=B(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=B(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=B(this.innerColor),e.renderOccluded=this.renderOccluded}};class gs{constructor(e){this.color=_.selected,this.size=4,this.outlineSize=1,this.outlineColor=_.outline,this.shape="square",H(this,e)}apply(e){e.color=B(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=B(this.outlineColor),e.primitive=this.shape}}let Oe=class{constructor(e){this.innerColor=_.selected,this.innerWidth=1,this.glowColor=_.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=ee,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=_.main,H(this,e)}apply(e,i=1){const n={glowColor:$.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:$.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*i,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=n:e.laserlineStyle=n}},fs=class{constructor(e){this.outline=new qe({color:_.outline,renderOccluded:w.OccludeAndTransparentStencil,stippleOffColor:_.selected,stipplePattern:Y(5),width:1.5,innerWidth:0}),this.staged=new qe({color:_.selected,renderOccluded:w.OccludeAndTransparentStencil,innerColor:_.staged,stippleOffColor:_.outline,stipplePattern:Y(5),width:1.5}),this.shadowStyle=new Oe({globalAlpha:ee,glowColor:_.main,glowFalloff:8,glowWidth:8,innerColor:_.selected,innerWidth:1}),H(this,e)}};class _s{constructor(e){this.outline=new gs({color:_.selected,outlineColor:_.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Oe({globalAlpha:ee,glowColor:_.main,glowFalloff:1.5,glowWidth:6,innerColor:_.selected,innerWidth:1,radius:2}),H(this,e)}}class vs extends qe{constructor(e){super(),this.extensionType=Lt.GROUND_RAY,H(this,e)}}let ys=class{constructor(e){this.lineGraphics=new fs,this.pointGraphics=new _s,this.heightPlane=new Oe({globalAlpha:ee,glowColor:_.main,glowFalloff:8,glowWidth:8,innerColor:_.selected,innerWidth:1}),this.heightBox=new Oe({globalAlpha:ee,glowColor:_.main,glowFalloff:8,glowWidth:8,innerColor:_.selected,innerWidth:0,heightFillColor:_.main}),this.zVerticalLine=new vs({color:he(_.main,5*ee/3),falloff:2,innerColor:he(_.selected,0),renderOccluded:w.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:Lt.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,H(this,e)}},Ss=class{constructor(e){this.visualElements=new ys,this.reshapeManipulators=new ms,this.zManipulator=new hs,H(this,e)}colorToVec4(e){return B(e)}};function B(t){return _i($.toUnitRGBA(t))}const Z=new Ss;function ws(t,e,i,n,s){const a=dt(3*t.length),o=dt(a.length);t.forEach((c,h)=>{a[3*h+0]=c[0],a[3*h+1]=c[1],a[3*h+2]=c.length>2?c[2]:0});const r=Si(a,e,0,o,0,a,0,a.length/3,i,n,s),l=r!=null;return{numVertices:t.length,position:a,mapPositions:o,projectionSuccess:l,sampledElevation:r}}let Ms=class extends At{constructor(e){super(e),this.view=null,this._renderOccluded=w.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=Z.colorToVec4(Z.reshapeManipulators.vertex.color),this._size=Z.reshapeManipulators.vertex.size,this._outlineColor=Z.colorToVec4(Z.reshapeManipulators.vertex.outlineColor),this._outlineSize=Z.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){ct(e,this._color)||(ut(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){ct(e,this._outlineColor)||(ut(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(g(e)||e.length===0)return[];const i=.5,n=.5,s=ws(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,wi.fromElevationInfo(this.elevationInfo)),a=[],o=s.numVertices,r=s.position;for(let l=0;l<o;++l){const c=$e(Ps,r[3*l+0],r[3*l+1],r[3*l+2]),h=Mt(this._vertexMaterial,i,c),m=Mt(this._vertexOutlineMaterial,n,c);a.push({vertexGeometry:h,vertexOutlineGeometry:m})}return a}createGeometries(e){const i=this._createRenderGeometries();for(const{vertexGeometry:n,vertexOutlineGeometry:s}of i)e.addGeometry(n),e.addGeometry(s)}createExternalResources(){this._vertexMaterial=new _t({...this._vertexMaterialParameters,writeDepth:!0,cullFace:ht.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new _t({...this._vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:ht.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}};const Ps=M();function Mt(t,e,i){return Mi(t,e,16,16,{offset:i})}let x=class extends Pi{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new Ke,this._getSnappingContext=nn(i=>new ln({elevationInfo:{mode:"absolute-height",offset:0},pointer:i,editGeometryOperations:new hn(new pn("point",mn(!0,!1,this.view.spatialReference))),visualizer:new dn})),this._snappingManagerResult=sn(t.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=Ee(),this._focusedOffsetManipulatorMaterial=Ee(),this._thinOffsetManipulatorMaterial=Ee(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:Y(2)}),this._constraintSnappingIndicator=new j({view:t.view,attached:!0,width:1,color:$.toUnitRGBA(S.constraint.color),renderOccluded:w.OccludeAndTransparent,stipplePattern:Y(5)});const e=$.toUnitRGBA(S.disabledPointIndicator.color);e[3]*=S.disabledPointIndicator.opacity,this._stagedStartIndicator=new Ms({view:t.view,attached:!1,color:e,size:2*S.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:w.OccludeAndTransparent})}initialize(){this._snappingOperation=new an({view:this.view}),this._orientationManipulatorTexture=cn(this.view.toolViewManager.textures),this._orientationManipulatorMaterial=new un({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:w.Opaque});const{computations:t}=this.analysisViewData;for(const e of t)this._addComputation(e);this.addHandles([t.on("after-add",e=>this._addComputation(e.item)),t.on("after-remove",e=>this._removeComputation(e.item))]),this.addHandles([P(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:e,stagedComputation:i})=>{if(g(i)||g(e))return;const n=ae(e,new J);this._applyPointUpdate(i,{endPoint:n})},Fe),P(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(e,i)=>{const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:a}=e;if(n===(i==null?void 0:i.stagedDimension)&&a===(i==null?void 0:i.firstGrabbedManipulator)){for(const o of[s,i==null?void 0:i.selectedComputation])if(p(o)){const r=this._computationManipulators.get(o);this._updateManipulators(o,r,e)}}else for(const[o,r]of this._computationManipulators)this._updateManipulators(o,r,e)},V),P(()=>this.analysis.style.lineSize,e=>{this._updateManipulatorStyle(e)},Ue),P(()=>this.view.state.camera,()=>{p(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)}),P(()=>Ci(this._stagedComputation,e=>{const i=e.elevationAlignedStartPoint,n=M();return p(i)&&this.view.renderCoordsHelper.toRenderCoords(i,n)?n:null}),e=>{p(e)?(this._stagedStartIndicator.vertices=[e],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),on(this,()=>{const e=this._activeComputation,i=this._stagedComputation;if(g(e)||p(i)){const n=Ne(this.view.inputManager.latestPointerType,"mouse"),s=this._getSnappingContext(n);this.updatingHandles.addPromise(pt(this._snappingOperation.resnap(this._snappingManager,s)))}if(p(e)){const{start:n,end:s}=this._computationManipulators.get(e);if(n.grabbing||s.grabbing){const a=n.grabbing?"start":"end",o=this._computeConstraint(e);cs(e,a,{constraint:o,view:this.view})}}})}destroy(){this._snappingOperation=de(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(p(this._stagedComputation))return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&p(t)?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return g(t)||g(e)||e.dimension!==t?null:e}get _constraintHandles(){return[Ze(()=>this.analysisViewData.selectedComputation,t=>{t.previousConstraint=this._computeConstraint(t)},{...V,equals:Be}),P(()=>{const t=this._activeComputation;if(g(t))return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}},(t,e)=>{if(p(t)&&g(e)){const{measureType:i,orientation:n,computation:s}=t;switch(s.previousConstraint){case R.Horizontal:s.preConstraintProperties={measureType:y.Horizontal,orientation:0};break;case R.Vertical:s.preConstraintProperties={measureType:y.Vertical,orientation:0};break;case R.Direct:s.preConstraintProperties={measureType:y.Direct,orientation:n};break;default:s.preConstraintProperties={measureType:i,orientation:n}}}g(t)&&p(e)&&(e.computation.preConstraintProperties=null)},Fe)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[P(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(t),g(i))n.attached=!1;else if(i===e)n.attached=!0;else{const{start:s,end:a}=this._computationManipulators.get(i),o=()=>{n.attached=s.grabbing||a.grabbing};o(),this.addHandles([s.events.on("grab-changed",o),a.events.on("grab-changed",o)],t)}}),P(()=>{const e=this._activeComputation;return p(e)?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:i})=>{const n=this._constraintSnappingIndicator;p(e)&&p(i)&&i!==R.Direct?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return!!p(this._stagedDimension)&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(g(e)){const i=this._onUnstagedClick(t);return this.analysis.dimensions.add(i),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if(e==="touch")return;const i=this._getSnappingContext(e);this.updatingHandles.addPromise(pt(this._snappingOperation.snap({point:t},this._snappingManager,i)))}onManipulatorSelectionChanged(){p(this.analysisViewData.selectedComputation)&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let i=t;if(e==="mouse"){const s=this._getSnappingContext(e);i=this._snappingManager.update({point:t,context:s})}const n=new Wi({startPoint:ae(i,new J),endPoint:null,measureType:y.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(g(i))return;let n=t;if(e==="mouse"){const a=this._getSnappingContext(e);n=this._snappingManager.update({point:t,context:a})}const s=ae(n,new J);this._applyPointUpdate(i,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(t){if(this._computationManipulators.has(t))return;const e=this._setupPointManipulator(t,{isStart:!0}),i=this._setupPointManipulator(t,{isStart:!1}),n=this._setupOffsetManipulator(t),s=this._setupHeadingManipulator(t),a=this._setupRotationManipulator(t),o=this._setupMeasureTypeManipulator(t,y.Direct),r=this._setupMeasureTypeManipulator(t,y.Horizontal),l=this._setupMeasureTypeManipulator(t,y.Vertical),c=new Fn({start:e,end:i,offset:n,heading:s,rotation:a,direct:o,horizontal:r,vertical:l});this._setupComputationToManipulatorsSync(t,c),this._computationManipulators.set(t,c),this.manipulators.addMany(c.values())}_removeComputation(t){const e=this._computationManipulators.get(t);if(!g(e)){this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const i of e.values())this.manipulators.remove(i)}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([P(()=>t.geometry,()=>this._updateManipulators(t,e),{...V,equals:Be})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:n}=t,s=Un(i,{metadata:n}),a=jn(s,{isStart:e.isStart,createSnappingPipelineStep:o=>rn({snappingContext:this._getSnappingContext(o),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:n,onUpdate:o=>this._applyPointUpdate(t,o),view:i});return this._computationHandles.add(a,t),s}_setupOffsetManipulator(t){const{view:e}=this,i=Bn(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),n=qn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=St(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=Nn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupRotationManipulator(t){const{view:e}=this,i=St(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=Yn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,n=Wn(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),s=Qn(n,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(s,t),n}_updateManipulators(t,e,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:a}=i,{start:o,end:r,offset:l,heading:c,rotation:h}=e,m=s===t,f=ue(t),{dimension:b}=t;for(const C of e.values()){const F=f&&g(n)&&(g(a)||C===a);C===l?(C.available=F,C.selected=m):C.available=F&&m}if(!f)return;p(this._computeConstraint(t))?e.forEachMeasureTypeManipulator(C=>C.available=!1):e.manipulatorForMeasureType(b.measureType).available=!1;for(const C of[c,h])b.measureType===y.Direct&&b.offset!==0||(C.available=!1);et(t)?h.available=!1:c.available=!1;const{geometry:O}=t;o.renderLocation=O.directSegment.startRenderSpace,r.renderLocation=O.directSegment.endRenderSpace;const{renderCoordsHelper:z}=this.view;Jn(l,O,z),c.available&&Xn(c,t,z),h.available&&es(h,t,z),e.forEachMeasureTypeManipulator((C,F)=>{C.available&&ns(C,t,F,z)})}_updateManipulatorStyle(t){const e=rs(t),i=nt(t),n={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:a,rotation:o}of this._computationManipulators.values())s.radius=i/2,wt(a,n),wt(o,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(t,e){const{view:i}=this,n=Pe(t);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const s=Ce(n,i.renderCoordsHelper);if(g(s))return;const a=this._computeConstraint({...n,geometry:s});Xt(t,e,{...n,constraint:a,unconstrainedGeometry:s,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(g(t.geometry))return;t.geometry.directSegment.eval(.5,Pt);const e=this.view.state.camera.computeRenderPixelSizeAt(Pt);t.dimension.offset=S.initialOffsetPx*e}_computeConstraint(t){return ds(ls(t,this._snappingManager.options),this.view)}get testInfo(){const t=e=>this.analysisViewData.computations.find(i=>i.dimension===e);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=w.Occlude,this.manipulators.forEach(({manipulator:e})=>{for(const{geometry:i}of e.renderObjects)i.material.setParameters({renderOccluded:w.Occlude})})},getManipulatorsForDimension:e=>this._computationManipulators.get(t(e)),getComputationForDimension:e=>t(e),getConstraintForDimension:e=>{const i=t(e);return p(i)?this._computeConstraint(i):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function Ee(){const{color:t,opacity:e}=S.offsetManipulator;return new ne({color:[...$.toUnitRGB(t),e],width:1,renderOccluded:w.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}d([u({constructOnly:!0})],x.prototype,"analysis",void 0),d([u({constructOnly:!0})],x.prototype,"analysisViewData",void 0),d([u({constructOnly:!0})],x.prototype,"manipulators",void 0),d([u({constructOnly:!0})],x.prototype,"parentTool",void 0),d([u({constructOnly:!0,nonNullable:!0})],x.prototype,"view",void 0),d([u({readOnly:!0})],x.prototype,"updating",null),d([u()],x.prototype,"firstGrabbedManipulator",null),d([u()],x.prototype,"hasGrabbedManipulators",null),d([u()],x.prototype,"snappingOptions",null),d([u()],x.prototype,"_stagedDimension",void 0),d([u()],x.prototype,"_activeComputation",null),d([u()],x.prototype,"_stagedComputation",null),x=d([W("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],x);const Pt=M();var Q;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(Q||(Q={}));let D=class extends en{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=S.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=bi(this.view.state.viewingMode),this._intersector.options.store=Oi.MIN,this._lengthDimensionSubTool=new x({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([$i(this._lengthDimensionSubTool),We(()=>this._clearPointerMoveTimeout()),P(()=>this.state,t=>{t===Q.Created&&this.finishToolCreation()},V),Ze(()=>this.firstGrabbedManipulator,t=>{this.selectedDimension=t.metadata},V),P(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),V)])}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?p(this._activeSubTool)?Q.Creating:Q.Created:Q.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":if(vt.cancel===t.key){if(p(this._activeSubTool)&&this._activeSubTool.removeStaged())return void t.stopPropagation();this.active||(this.selectedDimension=null)}else vt.delete.includes(t.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){p(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(g(this._activeSubTool))return;const e=this._intersectScreen(t);g(e)||(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),g(this._activeSubTool)||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);g(e)||this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_deleteKeyHandler(){p(this._activeSubTool)&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(t){const e=xi(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,n=v.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){p(this.selectedDimension)&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Ti(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(t=>{t.manipulator.state|=G}),this._prevPointerMoveTimeout=zi.setTimeout(()=>{this.manipulators.forEach(t=>{t.manipulator.state&=~G})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:t=>{this._pointerMoveTimerMs=t,this._resetPointerMoveTimeout()}}}};d([u({constructOnly:!0})],D.prototype,"view",void 0),d([u({constructOnly:!0})],D.prototype,"analysis",void 0),d([u({readOnly:!0})],D.prototype,"state",null),d([u({readOnly:!0})],D.prototype,"updating",null),d([u({readOnly:!0})],D.prototype,"cursor",null),d([u({constructOnly:!0})],D.prototype,"analysisViewData",void 0),d([u()],D.prototype,"selectedDimension",null),d([u()],D.prototype,"automaticManipulatorSelection",void 0),d([u()],D.prototype,"_activeSubTool",void 0),d([u()],D.prototype,"_lengthDimensionSubTool",void 0),D=d([W("esri.views.3d.analysis.Dimension.DimensionTool")],D);let Cs=class extends At{constructor(e,i){super(e),this._hasExternalMaterial=!1,this._renderOccluded=w.OccludeAndTransparent,this._width=1,this._color=Di(1,0,1,1),this._placement="end",this._textureId=null,this._material=i,this._hasExternalMaterial=p(i),this.applyProps(e)}setGeometryFromSegment(e,i){const n=e.endRenderSpace;this.transform=Ai(bs,n),this._normal=i;const{points:s}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return p(this._material)?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,p(this._material)&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return p(this._material)?this._material.parameters.width:this._width}set width(e){this._width=e,p(this._material)&&this._material.setParameters({width:e})}get color(){return p(this._material)?this._material.parameters.color:this._color}set color(e){this._color=Ri(e),p(this._material)&&this._material.setParameters({color:this._color})}get placement(){return p(this._material)?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,p(this._material)&&this._material.setParameters({placement:this._placement})}get textureId(){return p(this._material)?this._material.parameters.textureId:this._textureId}set textureId(e){this._textureId=e,p(this._material)&&this._material.setParameters({textureId:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new zt({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,textureId:this._textureId}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const i of Hi(this.geometry,this.normal)){const n=Ei(mt(this._material),i);e.addGeometry(n)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(mt(this._material))}};const bs=Ye();class Os{set visible(e){for(const i of this._visualElements.values())i.attached=e}constructor(e){this.destroyed=!1,this._handles=new Ke,this._messages=null,this._labelSegment=new K;const{analysis:i,computation:n,view:s,messages:a}=e;this.analysis=i,this.computation=n,this.view=s,this._messages=a;const o=e.visible,r={view:s,attached:o},{fontSize:l,textColor:c,textBackgroundColor:h}=i.style;this._visualElements=new Ds({marker:new Cs(r,e.markerMaterial),dimension:new j(r,e.dimensionLineMaterial),startOffset:new j(r,e.offsetLineMaterial),endOffset:new j(r,e.offsetLineMaterial),dimensionSmall:new j(r,e.smallDimensionLineMaterial),startOffsetSmall:new j(r,e.smallOffsetLineMaterial),endOffsetSmall:new j(r,e.smallOffsetLineMaterial),label:new Ni({view:s,attached:o,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:L(l),textColor:c.clone(),backgroundColor:h.clone()})}),this._handles.add([P(()=>n.geometry,m=>{this.updateCameraDependentElements(s.state.camera,m,i.style),p(n.geometry)&&this._updateLines(n.geometry)},{...Ue,equals:Be}),P(()=>n.length,m=>this._updateLabelContent(m),Ue)])}destroy(){this.destroyed=!0,this._handles=de(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const i=yt(xs,ce.Start,e.directSegment,e.dimensionSegment),n=yt(Ts,ce.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(i),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(i),s.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(e,i,n){const s=this._visualElements;if(g(i)){for(const z of s.values())z.visible=!1;return}const a=e.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,zs)),o=zn(i,a),r=o<(L(n.lineSize)*S.smallScreenLengthLineSizeFactor)**2,l=!r;s.marker.visible=l,s.dimension.visible=l,s.startOffset.visible=l,s.endOffset.visible=l,s.dimensionSmall.visible=r,s.startOffsetSmall.visible=r,s.endOffsetSmall.visible=r;const c=L(n.fontSize)*S.labels.minScreenLengthFontSizeFactor,{label:h}=s;if(h.visible=o>=c**2,!h.visible)return;const{dimensionSegment:m,primaryOffsetAxis:f}=i,{offset:b}=this.computation.dimension,O=(Math.sign(b)>=0?1:-1)*$s(n)*a;Pn(this._labelSegment,m,f,O),h.updateLabelPosition()}updateLabelStyle(e){const{label:i}=this._visualElements;i.fontSize=L(e.fontSize),i.textColor=e.textColor,i.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(e){const{label:i}=this._visualElements;g(e)||g(this._messages)?i.text="":i.text=Yi(this._messages,e,e.unit)}}function $s(t){return 1.5*L(t.fontSize)+S.labels.marginPx+L(t.lineSize/2)}const xs=new K,Ts=new K,zs=M();class Ds{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let As=class{constructor(e,i){this._textures=e,this._textureRepository=i,this._texturesByPrimitive=new Map}acquire(e){if(!this._texturesByPrimitive.has(e)){const i=Vi(this._textures,e),n=new gn(this._textureRepository,i.texture.id);return this._texturesByPrimitive.set(e,{result:i,reference:n}),i.texture}return this._texturesByPrimitive.get(e).result.texture}destroy(){this._texturesByPrimitive.forEach(({result:e,reference:i})=>{i.dispose(),e.release()}),this._texturesByPrimitive.clear()}},U=class extends pe{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(t){super(t),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new zt({width:1,anchor:Li.Tip,color:ie,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:w.OccludeAndTransparent}),this._dimensionLineMaterial=new ne({width:1,color:ie,renderOccluded:w.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new ne({width:1,color:ie,renderOccluded:w.OccludeAndTransparent,stipplePattern:Y(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new ne({width:1,color:ie,renderOccluded:w.OccludeAndTransparent}),this._smallOffsetLineMaterial=new ne({width:1,color:ie,renderOccluded:w.OccludeAndTransparent,stipplePattern:Y(5),stippleScaleWithLineWidth:!0})}initialize(){var i;const t=(i=this.view.sharedSymbolResources)==null?void 0:i.textures;if(p(t)){const{textureRepository:n}=this.view._stage.renderView,s=new As(t,n),a=s.acquire("triangle");this.addHandles(We(()=>s.destroy())),this._markerMaterial.setParameters({textureId:a.id})}for(const n of this._lineMaterials())this.view._stage.add(n),this.addHandles(We(()=>{this.view._stage.remove(n),n.dispose()}));const{computations:e}=this.analysisViewData;for(const n of e)this._addComputation(n);this.addHandles([e.on("change",({added:n,removed:s})=>{for(const a of s)this._removeComputation(a);for(const a of n)this._addComputation(a)}),P(()=>$.toUnitRGBA(this.analysis.style.color),n=>{for(const s of this._lineMaterials())s.setParameters({color:n})},V),P(()=>this.analysis.style.lineSize,n=>{const s=L(n);this._markerMaterial.setParameters({width:s*S.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:s,markerParameters:this._markerMaterial.parameters});const a=Math.max(s*S.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:a})},V),P(()=>({camera:this.view.state.camera,style:Rs(this.analysis)}),({camera:n,style:s})=>{for(const[a,o]of this._dimensionVisualizations)o.updateCameraDependentElements(n,a.geometry,s),o.updateLabelStyle(s)}),P(()=>this.visible,n=>{for(const s of this._dimensionVisualizations.values())s.visible=n})]),this.addHandles([ki(()=>this._updateMessageBundle()),Ze(()=>!this.loadingMessages,()=>{for(const n of this._dimensionVisualizations.values())n.updateUnitsMessages(this._messages)},Fe)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(t=>{t.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const t of this._lineMaterials())t.setParameters({renderOccluded:w.Occlude})}}}_addComputation(t){this._dimensionVisualizations.has(t)||this._dimensionVisualizations.set(t,new Os({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(t){const e=this._dimensionVisualizations.get(t);g(e)||(e.destroy(),this._dimensionVisualizations.delete(t))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Gi("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Rs(t){const{fontSize:e,lineSize:i,textColor:n,textBackgroundColor:s}=t.style;return{fontSize:e,lineSize:i,textBackgroundColor:s.clone(),textColor:n.clone()}}d([u({constructOnly:!0})],U.prototype,"analysisViewData",void 0),d([u({constructOnly:!0,nonNullable:!0})],U.prototype,"view",void 0),d([u()],U.prototype,"analysis",null),d([u()],U.prototype,"visible",null),d([u()],U.prototype,"loadingMessages",void 0),U=d([W("esri.views.3d.analysis.Dimension.DimensionVisualization")],U);let se=class extends pe{constructor(t){super(t),this.dimension=null,this.length=null}};d([u({constructOnly:!0,nonNullable:!0})],se.prototype,"dimension",void 0),d([u()],se.prototype,"length",void 0),se=d([W("esri.views.3d.analysis.LengthDimensionResult")],se);const Hs=se;let A=class extends pe{constructor(t){super(t),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...i}=t;return{result:new Hs({dimension:e}),...i}}initialize(){this.addHandles([P(()=>this.dimension.startPoint,t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t),V),P(()=>this.dimension.endPoint,t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t),V)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};d([u({constructOnly:!0,nonNullable:!0})],A.prototype,"result",void 0),d([u({constructOnly:!0,nonNullable:!0})],A.prototype,"projectAndAlignPoint",void 0),d([u()],A.prototype,"dimension",null),d([u()],A.prototype,"length",null),d([u()],A.prototype,"geometry",void 0),d([u()],A.prototype,"unconstrainedGeometry",void 0),d([u()],A.prototype,"elevationAlignedStartPoint",void 0),d([u()],A.prototype,"elevationAlignedEndPoint",void 0),d([u()],A.prototype,"preConstraintProperties",void 0),d([u()],A.prototype,"previousConstraint",void 0),A=d([W("esri.views.3d.analysis.LengthDimensionComputation")],A);const Es=t=>{let e=class extends t{constructor(...i){super(...i),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new Dt}createLengthDimensions(i){throw new Error("Method not implemented.")}};return d([u({constructOnly:!0})],e.prototype,"view",void 0),d([u({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),d([u()],e.prototype,"tool",void 0),d([u({readOnly:!0})],e.prototype,"results",null),d([u()],e.prototype,"selectedDimension",void 0),d([u()],e.prototype,"interactive",void 0),d([u()],e.prototype,"visible",void 0),e=d([W("esri.views.analysis.DimensionAnalysisView")],e),e};let T=class extends Es(Ii(pe)){constructor(t){super(t),this.type="dimension-view-3d",this.tool=null,this.computations=new Dt,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=t=>{if(g(t))return null;const{spatialReference:e,elevationProvider:i}=this.view,n=Fi(t,e,i);return g(n)&&Ui(this.analysis,t.spatialReference,bt.getLogger(this.declaredClass)),n},this.addHandles([fn(this,D),gt(()=>this.analysis.dimensions,"after-add",t=>this._onDimensionAdd(t.item),{onListenerAdd:t=>{for(const e of t)this._onDimensionAdd(e)},onListenerRemove:()=>{this._onDimensionsClear()}}),gt(()=>this.analysis.dimensions,"after-remove",t=>this._onDimensionRemove(t.item))]),this._analysisVisualization=new U({analysisViewData:this,view:this.view}),this._analysisController=new q({analysisViewData:this,view:this.view})}destroy(){this._placementTask=ft(this._placementTask),this._analysisVisualization=de(this._analysisVisualization),_n(this)}get updating(){var t;return((t=this._analysisVisualization)==null?void 0:t.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToComputations.get(t).result)}get selectedComputation(){const{selectedDimension:t}=this;return g(t)?null:this._dimensionsToComputations.get(t)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(t){return this.selectedDimension=null,this._placementTask=ft(this._placementTask),this._placementTask=vn(this,t),this._placementTask.promise}_onDimensionAdd(t){const{computations:e,_dimensionsToComputations:i}=this;if(i.has(t))return;const n=new A({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});e.add(n),i.set(t,n)}_onDimensionRemove(t){const{computations:e,_dimensionsToComputations:i}=this,n=e.findIndex(a=>a.dimension===t),s=e.getItemAt(n);s.dimension===this.selectedDimension&&(this.selectedDimension=null),e.removeAt(n),i.delete(t),de(s)}_onDimensionsClear(){this.computations.drain(t=>t.destroy()),this._dimensionsToComputations.clear()}};d([u({readOnly:!0})],T.prototype,"type",void 0),d([u()],T.prototype,"tool",void 0),d([u()],T.prototype,"updating",null),d([u({readOnly:!0})],T.prototype,"results",null),d([u({readOnly:!0})],T.prototype,"computations",void 0),d([u()],T.prototype,"selectedDimension",void 0),d([u()],T.prototype,"selectedComputation",null),d([u()],T.prototype,"_analysisVisualization",void 0),d([u()],T.prototype,"_analysisController",void 0),d([u()],T.prototype,"_dimensionsToComputations",void 0),d([u()],T.prototype,"_placementTask",void 0),T=d([W("esri.views.3d.analysis.DimensionAnalysisView3D")],T);const Oa=T;export{Oa as default};
