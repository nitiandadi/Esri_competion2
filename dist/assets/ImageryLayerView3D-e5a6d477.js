import{a8 as m,bK as h,t as d,e as l,a as p}from"./MapView-d4248bee.js";import{q as g}from"./DynamicLayerView3D-8dd8a321.js";import{m as u}from"./ImageryLayerView-13aacd6b.js";import"./index-9ba3f23e.js";import"./LayerView3D-d82b3e07.js";import"./projectExtentUtils-9657433f.js";import"./ImageMaterial-b196cc20.js";import"./LayerView-374f7208.js";import"./RefreshableLayerView-82af8ccd.js";import"./popupUtils-7e1f6d3e.js";let r=class extends u(g){constructor(){super(...arguments),this.type="imagery-3d",this.redrawDebounced=m(async e=>{this.redraw((t,a)=>this._redrawImage(t,a),e)},2e3)}initialize(){this.handles.add([h(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this.updatingHandles.addPromise(this.redrawDebounced()))]),this.updatingHandles.add(()=>{var e,t;return(t=(e=this.layer)==null?void 0:e.exportImageServiceParameters)==null?void 0:t.version},()=>{this.updatingHandles.addPromise(this.refreshDebounced())}),this.updatingHandles.add(()=>{var e;return(e=this.layer)==null?void 0:e.renderer},()=>{this.updatingHandles.addPromise(this.refreshDebounced())}),this.updatingHandles.add(()=>this.timeExtent,()=>this.updatingHandles.addPromise(this.refreshDebounced()))}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}getFetchOptions(){return{timeExtent:this.timeExtent}}async processResult(e,t,a){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,a))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||d(e.pixelData))throw new Error;const a=e.image,s=a.getContext("2d"),o=await this.layer.applyRenderer(e.pixelData,{signal:t}),i=this.layer.applyFilter(o).pixelBlock;if(d(i))throw new Error;a.width=i.width,a.height=i.height;const n=s.createImageData(i.width,i.height);n.data.set(i.getAsRGBA()),s.putImageData(n,0,0)}};r=l([p("esri.views.3d.layers.ImageryLayerView3D")],r);const b=r;export{b as default};
