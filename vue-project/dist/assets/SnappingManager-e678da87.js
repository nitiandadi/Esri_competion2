import{e as p,y as u,b as ee,bP as ot,b3 as Le,t as L,ff as j,fg as ae,fh as G,cq as S,fi as D,fj as ye,fk as Ee,fl as fe,fm as z,dy as ve,fn as R,fo as I,fp as B,fq as bt,fr as Nt,fs as at,ft as Fe,fu as Ie,fv as Oe,fw as Q,fx as Ct,r as E,fy as lt,fz as _,cg as Vt,fA as Me,p as le,E as Te,ci as At,dd as Ft,fB as ct,fC as It,cu as qe,q as K,e9 as Ot,bR as Mt,ba as qt,fD as Ht,fE as Dt,fF as kt,fG as jt,fH as dt,fI as zt,v as ze,h as Ge,o as Gt,ce as Qe,fJ as Zt,cy as Wt}from"./mapviewstore-8a6f290e.js";import{g as Ut,E as m,h as Xt}from"./elevationInfoUtils-db1a4384.js";import{l as me}from"./index-93a23f67.js";import{D as et}from"./QueryEngineResult-555e15c4.js";import{b as T,L as Ve,m as Yt}from"./geometry2dUtils-3b519363.js";import{u as w}from"./viewUtils-4b1f07e9.js";const Mn={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},tt={toggle:"Control"};let C=class extends ot{constructor(){super(...arguments),this.enabled=!0}};p([u({type:Boolean})],C.prototype,"enabled",void 0),C=p([ee("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],C);let y=class extends ot{constructor(e){super(e),this.lineSnapper=new C,this.parallelLineSnapper=new C,this.rightAngleSnapper=new C,this.rightAngleTriangleSnapper=new C,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThreshold=.1,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new Le([255,127,0]),this.orangeTransparent=new Le([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};p([u({type:C,constructOnly:!0,nonNullable:!0,json:{write:!0}})],y.prototype,"lineSnapper",void 0),p([u({type:C,constructOnly:!0,nonNullable:!0,json:{write:!0}})],y.prototype,"parallelLineSnapper",void 0),p([u({type:C,constructOnly:!0,nonNullable:!0,json:{write:!0}})],y.prototype,"rightAngleSnapper",void 0),p([u({type:C,constructOnly:!0,nonNullable:!0,json:{write:!0}})],y.prototype,"rightAngleTriangleSnapper",void 0),p([u({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],y.prototype,"shortLineThreshold",void 0),p([u({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],y.prototype,"distance",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],y.prototype,"pointThreshold",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],y.prototype,"intersectionParallelLineThreshold",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],y.prototype,"parallelLineThreshold",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],y.prototype,"verticalLineThreshold",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],y.prototype,"touchSensitivityMultiplier",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],y.prototype,"pointOnLineThreshold",void 0),p([u({type:Le,nonNullable:!0})],y.prototype,"orange",void 0),p([u({type:Le,nonNullable:!0})],y.prototype,"orangeTransparent",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],y.prototype,"lineHintWidthReference",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],y.prototype,"lineHintWidthTarget",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],y.prototype,"lineHintFadedExtensions",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],y.prototype,"parallelLineHintWidth",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],y.prototype,"parallelLineHintLength",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],y.prototype,"parallelLineHintOffset",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],y.prototype,"rightAngleHintSize",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],y.prototype,"rightAngleHintOutlineSize",void 0),p([u({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],y.prototype,"satisfiesConstraintScreenThreshold",void 0),y=p([ee("esri.views.interactive.snapping.Settings.Defaults")],y);const H=new y;var x;(function(i){i[i.FEATURE=1]="FEATURE",i[i.SELF=2]="SELF",i[i.ALL=3]="ALL"})(x||(x={}));function Dn(i){return i}function ht(i){return G(i)}function kn(i,e,t){return j(i,e,t)}function v(i,e,t){return L(i)?null:ue(t.coordinateHelper.vectorToDehydratedPoint(i,Jt),e,t)}function ue(i,e,t){if(L(i))return null;if(L(e))return j(i.x,i.y,i.z??0);if(e.type==="2d")return j(i.x,i.y,0);const{elevationInfo:n}=t,s=Ut(e,i,n,m)??0;return j(i.x,i.y,s)}function nt(i,e,{z:t,m:n,spatialReference:s,elevationInfo:r}){if(t==null&&n==null){const l=ae(i[0],i[1],void 0,s);return n!=null&&(l.m=n,l.hasM=!0),l}if(L(e)||e.type==="2d"){const l=ae(i[0],i[1],t,s);return n!=null&&(l.m=n,l.hasM=!0),l}const o=Xt(e,i,s,m,r)??0,a=ae(i[0],i[1],o,s);return n!=null&&(a.m=n,a.hasM=!0),a}function jn(i,e){return ae(i[0],i[1],i[2],e)}const Jt=ae(0,0,0,null);function He({start:i,end:e,type:t},n,s){const r=[],o=D(te,e,i),a=D(de,i,n),l=ye(o),c=2*Ee(o,a),d=c*c-4*l*(ye(a)-s*s);if(d===0){const h=-c/(2*l);(t===A.PLANE||h>=0)&&r.push(fe(z(),i,o,h))}else if(d>0){const h=Math.sqrt(d),f=(-c+h)/(2*l);(t===A.PLANE||f>=0)&&r.push(fe(z(),i,o,f));const g=(-c-h)/(2*l);(t===A.PLANE||g>=0)&&r.push(fe(z(),i,o,g))}return r}function De(i,e){const t=i.start,n=i.end,s=D(te,n,t),r=ve(de,-s[1],s[0],0),o=e.start,a=e.end,l=R(We,a,o),c=I(l,r),d=ve(gt,t[0],t[1],0),h=R(yt,d,o),f=I(h,r);if(Math.abs(c)<V)return[];const g=B(vt,o,l,f/c);if(e.type===T.RAY){const $=R($e,g,o);if(I($,l)<-V)return[]}if(i.type===A.HALF_PLANE){const $=bt($e,g,t);if(Ee($,s)<-V)return[]}return[G(g)]}function ke(i,e){return je(Pe(Ue,e[2],i),e)}function pt(i,e){const n=ft(Pe(Ue,0,i),Pe(Qt,0,e)),s=[];for(const r of n)s.push(Nt(r));return s}function ut(i,e){return Ze(i,Pe(Ue,i[2],e))}function Bt(i,e,t){const n=D(te,i,e),s=t/Ct(n),r=fe(S(),e,n,s);return r[2]=i[2],r}function Ze(i,{start:e,end:t,type:n}){const s=R(te,i,e),r=R(de,t,e),o=I(s,r)/I(r,r);return B(S(),e,r,n===T.RAY?Math.max(o,0):o)}function it({start:i,end:e,type:t},n,s){const r=[],o=at(te,e,i),a=D(de,i,n),l=ye(o),c=2*Ee(o,a),d=c*c-4*l*(ye(a)-s*s);if(d===0){const h=-c/(2*l);(t===T.LINE||h>=0)&&r.push(B(S(),i,o,h))}else if(d>0){const h=Math.sqrt(d),f=(-c+h)/(2*l);(t===T.LINE||f>=0)&&r.push(B(S(),i,o,f));const g=(-c-h)/(2*l);(t===T.LINE||g>=0)&&r.push(B(S(),i,o,g))}return r}function ft(i,e){const t=i.start,n=i.end,s=e.start,r=e.end,o=R(te,n,t),a=R(de,r,s),l=R(We,s,t),c=Fe(gt,o,a),d=I(l,c);if(!Ie(d,0,V))return[];const h=Oe(c);if(Ie(h,0,V))return[];const f=Fe(yt,l,a),g=I(f,c)/h,$=B(vt,t,o,g);if(i.type===T.RAY){const M=R($e,$,t);if(I(o,M)<-V)return[]}if(e.type===T.RAY){const M=R($e,$,s);if(I(a,M)<-V)return[]}return[G($)]}function je({start:i,end:e,type:t},n){const s=R(te,n,i),r=R(de,e,i),o=Fe(We,r,s);if(Oe(o)/Oe(r)<V)switch(t){case T.LINE:return[G(n)];case T.RAY:return I(r,s)<-V?[]:[G(n)]}return[]}function st(i,e,t){return Ie(Q(t,i),e*e,V)?[G(t)]:[]}function Pe(i,e,{start:t,end:n,type:s}){return ve(i.start,t[0],t[1],e),ve(i.end,n[0],n[1],e),i.type=Kt[s],i}var A;(function(i){i[i.PLANE=0]="PLANE",i[i.HALF_PLANE=1]="HALF_PLANE"})(A||(A={}));const Kt={[A.PLANE]:T.LINE,[A.HALF_PLANE]:T.RAY},V=1e-6,te=S(),de=S(),We=S(),gt=S(),yt=S(),vt=S(),$e=S(),Ue={start:S(),end:S(),type:T.LINE},Qt={start:S(),end:S(),type:T.LINE};let ne=class{intersect(e){return sn(this,e)}};class en extends ne{constructor(e){super(),this.point=e}equals(e){return re(e)&&_(this.point,e.point)}closestTo(){return ht(this.point)}}let Et=class extends ne{constructor(e,t,n){super(),this.start=e,this.end=t,this.type=n,this.lineLike={start:this.start,end:this.end,type:this.type}}equals(e){return X(e)&&this.type===e.type&&_(this.start,e.start)&&_(this.end,e.end)}closestTo(e){const t=Ze(e,this.lineLike);return t}},tn=class extends Et{constructor(e,t){super(e,t,T.LINE)}};class be extends ne{constructor(e,t,n){super(),this.intersection=e,this.first=t,this.second=n}equals(e){return e instanceof be&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(){return ht(this.intersection)}}class ge extends ne{constructor(e,t,n){super(),this.basePoint=e,this.first=t,this.second=n}equals(e){return e instanceof ge&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(e){const t=this.basePoint;return j(t[0],t[1],e[2])}}let St=class extends ne{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return oe(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const t=Bt(e,this.center,this.radius);return t}},Xe=class extends ne{constructor(e,t,n){super(),this.start=e,this.end=t,this.type=n,this.planeLike={start:e,end:t,type:n}}equals(e){return Y(e)&&this.type===e.type&&_(this.start,e.start)&&_(this.end,e.end)}closestTo(e){return ut(e,this.planeLike)}closestEndTo(e){const{start:t,end:n}=this;return Math.sign(Ee(D(on,n,t),D(an,e,t)))>0?n:t}};class mt extends Xe{constructor(e,t){super(e,t,A.HALF_PLANE)}}let _t=class extends Xe{constructor(e,t){super(e,t,A.PLANE)}},xt=class extends ne{constructor(e,t,n){super(),this.start=e,this.end=t,this.getZ=n,this.planeLike={start:e,end:t,type:A.HALF_PLANE}}equals(e){return J(e)&&_(this.start,e.start)&&_(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return nn(this,e)}addIfOnTheGround(e,t){for(const n of t){const s=Vt(this.getZ(n[0],n[1],n[2]),0);Math.abs(n[2]-s)<V&&(n[2]=s,e.push(n))}}};function nn(i,e){const t=ut(e,i.planeLike);return t[2]=lt(i.getZ(e[0],e[1],e[2]))??wt,t}function sn(i,e){let t=[];if(re(i)){const{point:n}=i;X(e)?t=je(e.lineLike,n):oe(e)?t=st(e.center,e.radius,n):Y(e)?t=ke(e.planeLike,n):J(e)&&(t=pe(e,i))}else if(X(i)){const{lineLike:n}=i;re(e)?t=je(n,e.point):X(e)?t=ft(n,e.lineLike):oe(e)?t=it(n,e.center,e.radius):Y(e)?t=De(e.planeLike,n):J(e)&&(t=pe(e,i))}else if(oe(i)){const{center:n,radius:s}=i;if(X(e))t=it(e.lineLike,n,s);else if(re(e))t=st(n,s,e.point);else{if(Y(e))return He(e.planeLike,n,s).map(r=>new ge(r,i,e));J(e)&&(t=pe(e,i))}}else if(Y(i)){const{planeLike:n}=i;if(Y(e))return pt(n,e.planeLike).map(s=>new ge(s,i,e));if(re(e))t=ke(n,e.point);else if(X(e))t=De(n,e.lineLike);else{if(oe(e))return He(n,e.center,e.radius).map(s=>new ge(s,i,e));J(e)&&(t=pe(e,i))}}else J(i)&&(t=pe(i,e));return rn(t,i,e)}function pe(i,e){const{planeLike:t,getZ:n}=i,s=[];if(re(e))i.addIfOnTheGround(s,ke(t,e.point));else if(X(e))i.addIfOnTheGround(s,De(t,e.lineLike));else if(oe(e))for(const[r,o]of He(t,e.center,e.radius)){const a=n(r,o,0);E(a)&&s.push(j(r,o,a))}else if(Y(e)||J(e))for(const[r,o]of pt(t,e.planeLike)){const a=lt(n(r,o,0))??wt;s.push(j(r,o,a))}return s}function rn(i,e,t){return i.map(n=>new be(n,e,t))}function re(i){return i instanceof en}function X(i){return i instanceof Et}function oe(i){return i instanceof St}function Y(i){return i instanceof Xe}function J(i){return i instanceof xt}const on=z(),an=z(),wt=0;function ie(i,e){const t=i.x-e.x,n=i.y-e.y;return t*t+n*n}function ln(i,e){return Math.sqrt(ie(i,e))}function Ye(i,e){e.sort((t,n)=>Me(t.targetPoint,i)-Me(n.targetPoint,i))}var b;function Jn({point:i,distance:e,types:t,coordinateHelper:{spatialReference:n}},s,r){return{point:ae(i[0],i[1],i[2],n.toJSON()),mode:s,distance:e,types:t,query:E(r)?r.toJSON():{where:"1=1"}}}function Re(i,e,t){return{left:v(i.leftVertex.pos,e,t),right:v(i.rightVertex.pos,e,t)}}function Bn(i){return i.createQuery()}function Kn(i,e=()=>{}){const t=le(()=>({view:i.view,snappingOptions:i.snappingOptions}),({view:n,snappingOptions:s})=>{const r="snapping-toggle",o=At.TOOL;if(i.removeHandles(r),n&&E(s)){const a=[n.on("key-down",l=>{l.key!==tt.toggle||l.repeat||(s.enabledToggled=!0,e())},o),n.on("key-up",l=>{l.key===tt.toggle&&(s.enabledToggled=!1,e())},o),n.on("pointer-move",l=>{const c=l.native.ctrlKey;s.enabledToggled!==c&&(s.enabledToggled=c,e())},o)];i.addHandles(a,r)}},Te);i.addHandles(t)}(function(i){i[i.TARGET=0]="TARGET",i[i.REFERENCE=1]="REFERENCE",i[i.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(b||(b={}));class he{constructor(e,t,n,s){this.targetPoint=e,this.constraint=t,this.isDraped=n,this.domain=s}}let Je=class extends he{constructor({targetPoint:e,objectId:t,constraint:n,isDraped:s}){super(e,n,s,x.FEATURE),this.objectId=t}},Ne=class{constructor(e,t){this.isDraped=e,this.domain=t}},O=class Lt extends Ne{constructor(e,t,n,s,r=x.ALL,o=!0,a=!0){super(s,r),this.type=e,this.lineStart=t,this.lineEnd=n,this.fadeLeft=o,this.fadeRight=a}equals(e){return e instanceof Lt&&this.type===e.type&&_(this.lineStart,e.lineStart)&&_(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return Ft(this.lineStart,this.lineEnd)}},cn=class extends Je{constructor(e){super({...e,isDraped:!0,constraint:new xt(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new O(b.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},dn=class extends Je{constructor(e){super({...e,constraint:new tn(e.edgeStart,e.edgeEnd)})}get hints(){return[new O(b.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},Tt=class Pt extends Ne{constructor(e,t,n,s,r=x.ALL){super(s,r),this.previousVertex=e,this.centerVertex=t,this.nextVertex=n}equals(e){return e instanceof Pt&&_(this.previousVertex,e.previousVertex)&&_(this.centerVertex,e.centerVertex)&&_(this.nextVertex,e.nextVertex)}},$t=class extends he{constructor({targetPoint:e,constraint:t,previousVertex:n,otherVertex:s,otherVertexType:r,objectId:o,isDraped:a}){super(e,t,a,x.SELF),this.previousVertex=n,this.otherVertex=s,this.otherVertexType=r,this.objectId=o}get hints(){const e=this.previousVertex,t=this.otherVertexType===ce.CENTER?this.otherVertex:this.targetPoint,n=this.otherVertexType===ce.CENTER?this.targetPoint:this.otherVertex;return[new O(b.TARGET,t,n,this.isDraped,this.domain),new O(b.REFERENCE,e,t,this.isDraped,this.domain),new Tt(this.previousVertex,t,n,this.isDraped,this.domain)]}};var ce;(function(i){i[i.NEXT=0]="NEXT",i[i.CENTER=1]="CENTER"})(ce||(ce={}));let k=class extends ct{get updating(){return It(this.snappingSources,({snappingSource:e})=>e.updating)||this.updatingHandles.updating}get snappingSources(){const e=this._get("snappingSources")||new Map,t=new Map;if(E(this.options)&&E(this.options.featureSources))for(const n of this.options.featureSources.items){const s=n.layer.uid,r=e.get(s);if(r){e.delete(s),t.set(s,r);continue}if(!n.layer.loaded){this.updatingHandles.addPromise(n.layer.load());continue}const o=this._createSourceInfo(n);E(o)&&t.set(s,o)}for(const[,n]of e)n.destroy();return t}constructor(e){super(e),this.options=null,this._domain=x.FEATURE,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),qe),E(this.view)&&this.handles.add([this.view.on("layerview-create",e=>this._updateLayerView(e.layer,e.layerView)),this.view.on("layerview-destroy",e=>this._updateLayerView(e.layer,null))])}_updateLayerView(e,t){for(const[,n]of this.snappingSources)n.snappingSource.layerSource.layer===e&&(n.layerView=t)}destroy(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()}async fetchCandidates(e,t,n,s){var c;if(!(t&this._domain)||L(this.options)||!this.options.effectiveFeatureEnabled)return[];const r=[],o=this._computeScreenSizeDistanceParameters(e,n),a={distance:o,mode:((c=K(this.view))==null?void 0:c.type)??"2d",point:e,coordinateHelper:n.coordinateHelper,types:this._types};for(const[,{snappingSource:d,layerView:h}]of this.snappingSources)!d.layerSource.enabled||E(h)&&h.suspended||r.push(d.fetchCandidates(a,s).then(f=>f.filter(g=>!this._candidateIsExcluded(d,g,n.excludeFeature))));const l=(await Ot(r)).flat();return this._addRightAngleCandidates(l,e,o,n),Mt(s),Ye(e,l),l}_addRightAngleCandidates(e,t,n,s){var h,f,g,$,M,N,Z,Ke;const r=E(s.vertexHandle)?(f=(h=s.vertexHandle.rightEdge)==null?void 0:h.rightVertex)==null?void 0:f.pos:E(s.editGeometryOperations)&&s.editGeometryOperations.data.type==="polygon"?($=K((g=s.editGeometryOperations.data.components[0])==null?void 0:g.getFirstVertex()))==null?void 0:$.pos:null,o=E(s.vertexHandle)?(N=(M=s.vertexHandle.leftEdge)==null?void 0:M.leftVertex)==null?void 0:N.pos:E(s.editGeometryOperations)?(Ke=K((Z=s.editGeometryOperations.data.components[0])==null?void 0:Z.getLastVertex()))==null?void 0:Ke.pos:null,{view:a}=this,l=v(r,a,s),c=v(o,a,s),d=e.length;for(let Se=0;Se<d;Se++)this._addRightAngleCandidate(e[Se],c,t,n,e),this._addRightAngleCandidate(e[Se],l,t,n,e)}_addRightAngleCandidate(e,t,n,s,r){if(L(t)||!pn(e))return;const o=e.constraint.closestTo(t),a=(o[0]-n[0])/s.x,l=(o[1]-n[1])/s.y,{start:c,end:d}=e.constraint;if(a*a+l*l<=1){const h=new $t({targetPoint:o,otherVertex:t,otherVertexType:ce.NEXT,previousVertex:Q(o,c)>Q(o,d)?c:d,constraint:new mt(t,o),objectId:e.objectId,isDraped:e.isDraped});r.push(h)}}_computeScreenSizeDistanceParameters(e,t){let n=E(this.options)?this.options.distance*(t.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return L(this.view)?{x:n,y:n,z:n,distance:n}:this.view.type==="2d"?(n*=this.view.resolution,{x:n,y:n,z:n,distance:n}):this._computeScreenSizeDistanceParameters3D(e,n,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,n,s){const{spatialReference:r}=s;n.renderCoordsHelper.toRenderCoords(e,r,rt);const o=n.state.camera.computeScreenPixelSizeAt(rt),a=o*n.renderCoordsHelper.unitInMeters/n.mapCoordsHelper.unitInMeters,l=t*a,c=w(e,r,m,n),d=c?Ae(c,e,a,0,0,n,s):0,h=c?Ae(c,e,0,a,0,n,s):0,f=c?Ae(c,e,0,0,a,n,s):0;return{x:d===0?0:l/d,y:h===0?0:l/h,z:f===0?0:l/f,distance:o*t}}get _types(){return et.EDGE|et.VERTEX}_candidateIsExcluded(e,t,n){if(L(n))return!1;const s=this._getCandidateObjectId(t);if(L(s))return!1;const r=e.layerSource.layer;return r.type==="graphics"?n.uid===s:n.sourceLayer===r&&!(!n.attributes||!("objectIdField"in r))&&n.attributes[r.objectIdField]===s}_getCandidateObjectId(e){return e instanceof Je?e.objectId:null}_createSourceInfo(e){const t=this._createFeatureSnappingSourceType(e);if(L(t))return null;if("loading"in t)return this.updatingHandles.addPromise(t.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const n=E(this.view)?this.view.allLayerViews.find(s=>s.layer===e.layer):null;return new hn(t.source,n)}_createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}_createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;if(L(t)||t.type!=="3d")return null;const n=this._getSourceModule("scene");return E(n.module)?{source:new n.module.SceneLayerSnappingSource({layerSource:e,view:t})}:{loading:n.loader}}_createFeatureSnappingSourceFeatureLayer(e){var t;switch((t=e.layer.source)==null?void 0:t.type){case"feature-layer":case"oriented-imagery":{const n=this._getSourceModule("featureService");return E(n.module)?{source:new n.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:n.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(e.layer.geometryType==="mesh")return null;const n=this._getSourceModule("featureCollection");return E(n.module)?{source:new n.module.FeatureCollectionSnappingSource({layerSource:e,view:this.view})}:{loading:n.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(e){const t=this._getSourceModule("graphics");return E(t.module)?{source:new t.module.GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}_createFeatureSnappingSourceMapNotesLayer(e){const t=this._getSourceModule("notes");return E(t.module)?{source:new t.module.GraphicsSnappingSource({getGraphicsLayers:()=>E(e.layer.sublayers)?e.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:t.loader}}_getSourceModule(e){const t=this._sourceModules[e];if(L(t.loader)){const n=this._loadSourceModule(e).then(s=>{t.module=s});return t.loader=n,{module:t.module,loader:n}}return{module:t.module,loader:t.loader}}_loadSourceModule(e){const t=this.updatingHandles;switch(e){case"featureService":return t.addPromise(me(()=>import("./FeatureServiceSnappingSource-97151ece.js"),["assets/FeatureServiceSnappingSource-97151ece.js","assets/mapviewstore-8a6f290e.js","assets/index-93a23f67.js","assets/index-2d69a2d2.css","assets/elevationInfoUtils-db1a4384.js","assets/queryEngineUtils-e185f7d2.js","assets/VertexSnappingCandidate-8a726754.js","assets/PointSnappingHint-65883099.js","assets/TileTreeDebugger-e59746f4.js","assets/QueryEngineResult-555e15c4.js","assets/WhereClause-1d488167.js","assets/executionError-fb3f283a.js","assets/utils-da1501b7.js","assets/ClassBreaksDefinition-e0623088.js","assets/projectionSupport-2ac8e0ed.js","assets/json-48e3ea08.js","assets/utils-756c69af.js","assets/geometry2dUtils-3b519363.js","assets/viewUtils-4b1f07e9.js"]));case"featureCollection":return t.addPromise(me(()=>import("./FeatureCollectionSnappingSource-109d8bab.js"),["assets/FeatureCollectionSnappingSource-109d8bab.js","assets/mapviewstore-8a6f290e.js","assets/index-93a23f67.js","assets/index-2d69a2d2.css","assets/elevationInfoUtils-db1a4384.js","assets/queryEngineUtils-e185f7d2.js","assets/VertexSnappingCandidate-8a726754.js","assets/PointSnappingHint-65883099.js","assets/symbologySnappingCandidates-de7646d1.js","assets/QueryEngineResult-555e15c4.js","assets/WhereClause-1d488167.js","assets/executionError-fb3f283a.js","assets/utils-da1501b7.js","assets/ClassBreaksDefinition-e0623088.js","assets/projectionSupport-2ac8e0ed.js","assets/json-48e3ea08.js","assets/utils-756c69af.js","assets/geometry2dUtils-3b519363.js","assets/viewUtils-4b1f07e9.js"]));case"graphics":case"notes":return t.addPromise(me(()=>import("./GraphicsSnappingSource-47977505.js"),["assets/GraphicsSnappingSource-47977505.js","assets/mapviewstore-8a6f290e.js","assets/index-93a23f67.js","assets/index-2d69a2d2.css","assets/normalizeUtilsSync-60d2daaf.js","assets/FeatureStore-92853357.js","assets/BoundsStore-ebfef852.js","assets/PooledRBush-d915efbf.js","assets/optimizedFeatureQueryEngineAdapter-2b234c6e.js","assets/centroid-15f2128f.js","assets/utils-756c69af.js","assets/projectionSupport-2ac8e0ed.js","assets/json-48e3ea08.js","assets/QueryEngine-d8795282.js","assets/QueryEngineResult-555e15c4.js","assets/WhereClause-1d488167.js","assets/executionError-fb3f283a.js","assets/utils-da1501b7.js","assets/ClassBreaksDefinition-e0623088.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-592d163d.js","assets/elevationInfoUtils-db1a4384.js","assets/queryEngineUtils-e185f7d2.js","assets/VertexSnappingCandidate-8a726754.js","assets/PointSnappingHint-65883099.js","assets/symbologySnappingCandidates-de7646d1.js","assets/geometry2dUtils-3b519363.js","assets/viewUtils-4b1f07e9.js"]));case"scene":return t.addPromise(me(()=>import("./SceneLayerSnappingSource-a9a1c328.js"),["assets/SceneLayerSnappingSource-a9a1c328.js","assets/mapviewstore-8a6f290e.js","assets/index-93a23f67.js","assets/index-2d69a2d2.css","assets/VertexSnappingCandidate-8a726754.js","assets/PointSnappingHint-65883099.js","assets/elevationInfoUtils-db1a4384.js","assets/QueryEngineResult-555e15c4.js","assets/WhereClause-1d488167.js","assets/executionError-fb3f283a.js","assets/utils-da1501b7.js","assets/ClassBreaksDefinition-e0623088.js","assets/projectionSupport-2ac8e0ed.js","assets/json-48e3ea08.js","assets/utils-756c69af.js","assets/geometry2dUtils-3b519363.js","assets/viewUtils-4b1f07e9.js"]))}}};p([u({constructOnly:!0})],k.prototype,"spatialReference",void 0),p([u({constructOnly:!0})],k.prototype,"view",void 0),p([u()],k.prototype,"options",void 0),p([u({readOnly:!0})],k.prototype,"updating",null),p([u({readOnly:!0})],k.prototype,"snappingSources",null),k=p([ee("esri.views.interactive.snapping.FeatureSnappingEngine")],k);let hn=class{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new qt;const n=this.snappingSource.layerSource.layer;if("refresh"in n){const s=n;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([le(()=>e.updating,s=>e.layerSource.updating=s,Te),le(()=>e.availability,s=>e.layerSource.availability=s,Te)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}};function pn(i){return(i instanceof dn||i instanceof cn)&&!un(i)}function un({constraint:{start:i,end:e}}){const t=Me(i,e),n=Q(i,e);return t<Ht()||n/t<gn}function Ae(i,e,t,n,s,r,{spatialReference:o}){const a=Dt(fn,e);a[0]+=t,a[1]+=n,a[2]+=s;const l=w(a,o,m,r);return l?ln(l,i):1/0}const rt=S(),fn=S(),gn=1e-4;let Ce=class{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=H.shortLineThreshold*H.shortLineThreshold}snap(e,t){return E(t.vertexHandle)?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(v(e.leftVertex.pos,this.view,t),v(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:n}){return this.squaredShortLineThreshold===0||ie(w(t,n,m,this.view),w(e,n,m,this.view))>this.squaredShortLineThreshold}isVertical(e,t){return Q(e,t)<H.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}},yn=class extends he{constructor({lineStart:e,lineEnd:t,targetPoint:n,isDraped:s}){super(n,new _t(e,t),s,x.SELF),this._referenceLineHint=new O(b.REFERENCE_EXTENSION,e,t,s,this.domain)}get hints(){return[this._referenceLineHint,new O(b.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}},vn=class extends Ce{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.edges.length,r=[];if(s<1)return r;const{spatialReference:o}=t,a=w(e,o,m,this.view),{view:l}=this,c=n.edges[s-1];let d=c;do{if(this.edgeExceedsShortLineThreshold(d,t)){const h=Re(d,l,t);this._processCandidateProposal(h.left,h.right,e,a,t,r)}d=d.leftVertex.leftEdge}while(d&&d!==c);return r}snapExistingVertex(e,t){const n=[],s=K(t.vertexHandle),r=s.component;if(r.edges.length<2)return n;const{view:o}=this,{spatialReference:a}=t,l=w(e,a,m,o),c=s.leftEdge,d=s.rightEdge;c&&d&&this.edgeExceedsShortLineThreshold(c,t)&&this.edgeExceedsShortLineThreshold(d,t)&&this._processCandidateProposal(v(c.leftVertex.pos,o,t),v(d.rightVertex.pos,o,t),e,l,t,n);const h=r.edges[0];let f=h;do{if(f!==s.leftEdge&&f!==s.rightEdge&&this.edgeExceedsShortLineThreshold(f,t)){const g=Re(f,o,t);this._processCandidateProposal(g.left,g.right,e,l,t,n)}f=f.rightVertex.rightEdge}while(f&&f!==h);return n}_processCandidateProposal(e,t,n,s,r,o){var d;const{spatialReference:a,pointer:l}=r,c=Ze(n,{start:e,end:t,type:T.LINE});ie(s,w(c,a,m,this.view))<this.squaredProximityThreshold(l)&&o.push(new yn({lineStart:e,lineEnd:t,targetPoint:c,isDraped:((d=r.elevationInfo)==null?void 0:d.mode)==="on-the-ground"}))}},En=class Rt extends Ne{constructor(e,t,n,s=x.ALL){super(n,s),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof Rt&&_(this.lineStart,e.lineStart)&&_(this.lineEnd,e.lineEnd)}},Sn=class extends he{constructor({referenceLine:e,lineStart:t,targetPoint:n,isDraped:s}){const r=G(t),{left:o,right:a}=e;at(r,kt(r,r,a),o),super(n,new _t(t,r),s,x.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new O(b.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new En(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new O(b.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(n=>{_(e.right,n.edge.left)&&(n.fadeLeft=!1,t.fadeRight=!1),_(e.right,n.edge.right)&&(n.fadeRight=!1,t.fadeRight=!1),_(e.left,n.edge.right)&&(n.fadeRight=!1,t.fadeLeft=!1),_(e.left,n.edge.left)&&(n.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}};class mn extends Ce{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.edges.length,r=n.vertices.length,o=[];if(s<2)return o;const{view:a}=this,l=w(e,t.spatialReference,m,a),c=v(n.vertices[r-1].pos,a,t),d=v(n.vertices[0].pos,a,t),h=n.edges[s-1];let f=h;do{if(this.edgeExceedsShortLineThreshold(f,t)){const g=Re(f,a,t);this._checkEdgeForParallelLines(g,c,e,l,t,o),this._checkEdgeForParallelLines(g,d,e,l,t,o)}f=f.leftVertex.leftEdge}while(f&&f!==h);return o}snapExistingVertex(e,t){const n=[],s=K(t.vertexHandle),r=s.component;if(r.edges.length<3)return n;const{view:o}=this,a=w(e,t.spatialReference,m,o),l=s.leftEdge,c=s.rightEdge,d=r.vertices[0],h=v(d.pos,o,t),f=r.vertices.length,g=r.vertices[f-1],$=v(g.pos,o,t),M=r.edges[0];let N=M;do{if(N!==l&&N!==c&&this.edgeExceedsShortLineThreshold(N,t)){const Z=Re(N,o,t);l&&this._checkEdgeForParallelLines(Z,v(l.leftVertex.pos,o,t),e,a,t,n),c&&this._checkEdgeForParallelLines(Z,v(c.rightVertex.pos,o,t),e,a,t,n),s===d?this._checkEdgeForParallelLines(Z,$,e,a,t,n):s===g&&this._checkEdgeForParallelLines(Z,h,e,a,t,n)}N=N.rightVertex.rightEdge}while(N&&N!==M);return n}_checkEdgeForParallelLines(e,t,n,s,r,o){var f;const a=e.left,l=e.right;if(Ve(W,t,a,l),Q(W,t)<H.parallelLineThreshold)return;Ve(W,n,a,l,t);const{spatialReference:c,pointer:d}=r,h=j(W[0],W[1],n[2]);if(ie(s,w(h,c,m,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(h,t)||this.isVertical(a,l)||this._parallelToPreviousCandidate(e,o))return;o.push(new Sn({referenceLine:e,lineStart:t,targetPoint:h,isDraped:((f=r.elevationInfo)==null?void 0:f.mode)==="on-the-ground"}))}}_parallelToPreviousCandidate(e,t){const n=e.left,s=e.right;for(const r of t)if(Ve(W,s,r.constraint.start,r.constraint.end,n),Q(W,s)<H.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}const W=z();class _n extends Ce{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.vertices.length,r=[];if(s<2)return r;const{view:o}=this,a=w(e,t.spatialReference,m,o),l=n.vertices[s-1];if(this.edgeExceedsShortLineThreshold(l.leftEdge,t)){const d=v(l.pos,o,t),h=v(l.leftEdge.leftVertex.pos,o,t);this._checkForSnappingCandidate(r,h,d,e,a,t)}const c=n.vertices[0];if(this.edgeExceedsShortLineThreshold(c.rightEdge,t)){const d=v(c.pos,o,t),h=v(c.rightEdge.rightVertex.pos,o,t);this._checkForSnappingCandidate(r,h,d,e,a,t)}return r}snapExistingVertex(e,t){const n=[],s=K(t.vertexHandle);if(s.component.vertices.length<3)return n;const{view:r}=this,o=w(e,t.spatialReference,m,r),a=s.leftEdge,l=s.rightEdge;if(a&&a.leftVertex.leftEdge){const c=a.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(c,t)){const d=v(c.rightVertex.pos,r,t),h=v(c.leftVertex.pos,r,t);this._checkForSnappingCandidate(n,h,d,e,o,t)}}if(l&&l.rightVertex.rightEdge){const c=l.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(c,t)){const d=v(c.leftVertex.pos,r,t),h=v(c.rightVertex.pos,r,t);this._checkForSnappingCandidate(n,h,d,e,o,t)}}return n}_checkForSnappingCandidate(e,t,n,s,r,o){var f;const{spatialReference:a,pointer:l}=o;D(_e,n,t);const c=ve(xn,_e[1],-_e[0],0),d=Ee(c,D(_e,s,n))/ye(c),h=fe(G(s),n,c,d);if(ie(r,w(h,a,m,this.view))<this.squaredProximityThreshold(l)){if(this.isVertical(h,n)||this.isVertical(n,t))return;const g=B(S(),n,c,Math.sign(d));e.push(new $t({targetPoint:h,constraint:new mt(n,g),previousVertex:t,otherVertex:n,otherVertexType:ce.CENTER,isDraped:((f=o.elevationInfo)==null?void 0:f.mode)==="on-the-ground"}))}}}const _e=z(),xn=S();let wn=class extends he{constructor({targetPoint:e,point1:t,point2:n,isDraped:s}){super(e,new St(jt(S(),t,n,.5),.5*dt(t,n)),s,x.SELF),this._p1=t,this._p2=n}get hints(){return[new O(b.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new O(b.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new Tt(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}};class Ln extends Ce{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=[],r=n.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:o}=this,a=n.vertices[0],l=n.vertices[r-1],c=v(a.pos,o,t),d=v(l.pos,o,t);return this._processCandidateProposal(c,d,e,t,s),s}snapExistingVertex(e,t){const n=[],s=K(t.vertexHandle),r=s.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return n;const{view:o}=this,a=v(s.leftEdge.leftVertex.pos,o,t),l=v(s.rightEdge.rightVertex.pos,o,t);return this._processCandidateProposal(a,l,e,t,n),n}_processCandidateProposal(e,t,n,s,r){var g;if(!this.exceedsShortLineThreshold(e,t,s))return;const o=zt(Tn,e,t,.5),a=.5*dt(e,t),l=S();Yt(l,n,o,a),l[2]=n[2];const c=l,{spatialReference:d,pointer:h}=s,f=w(n,d,m,this.view);if(ie(f,w(c,d,m,this.view))<this.squaredProximityThreshold(h)){if(this.isVertical(e,c)||this.isVertical(c,t))return;r.push(new wn({targetPoint:c,point1:e,point2:t,isDraped:((g=s.elevationInfo)==null?void 0:g.mode)==="on-the-ground"}))}}}const Tn=z();let se=class extends ze{constructor(i){super(i),this.updating=!1,this._snappers=new Ge,this._domain=x.SELF}initialize(){this._snappers.push(new mn(this.view,this.options),new vn(this.view,this.options),new _n(this.view,this.options),new Ln(this.view,this.options))}set options(i){this._set("options",i);for(const e of this._snappers)e.options=i}async fetchCandidates(i,e,t){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const n=[];for(const s of this._snappers.items)for(const r of s.snap(i,t))n.push(r);return Ye(i,n),n}};p([u({readOnly:!0})],se.prototype,"updating",void 0),p([u({constructOnly:!0})],se.prototype,"view",void 0),p([u()],se.prototype,"options",null),se=p([ee("esri.views.interactive.snapping.SelfSnappingEngine")],se);function Pn(i,e){return[new se({view:i,options:e}),new k({view:i,options:e,spatialReference:i.spatialReference})]}let U=class extends ze{constructor(i){super(i),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};p([u({constructOnly:!0})],U.prototype,"layer",void 0),p([u()],U.prototype,"enabled",void 0),p([u()],U.prototype,"updating",void 0),p([u()],U.prototype,"availability",void 0),U=p([ee("esri.views.interactive.snapping.FeatureSnappingLayerSource")],U);const $n=U;let P=class extends ze{constructor(i){super(i),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new Ge,this.distance=H.distance,this.touchSensitivityMultiplier=H.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};p([u()],P.prototype,"enabled",void 0),p([u()],P.prototype,"enabledToggled",void 0),p([u()],P.prototype,"selfEnabled",void 0),p([u()],P.prototype,"featureEnabled",void 0),p([u({type:Ge.ofType($n)})],P.prototype,"featureSources",void 0),p([u()],P.prototype,"distance",void 0),p([u()],P.prototype,"touchSensitivityMultiplier",void 0),p([u({readOnly:!0})],P.prototype,"effectiveEnabled",null),p([u({readOnly:!0})],P.prototype,"effectiveSelfEnabled",null),p([u({readOnly:!0})],P.prototype,"effectiveFeatureEnabled",null),P=p([ee("esri.views.interactive.snapping.SnappingOptions")],P);const Rn=P;class Be extends Ne{constructor(e,t,n=x.ALL){super(t,n),this.intersectionPoint=e}equals(e){return e instanceof Be&&_(this.intersectionPoint,e.intersectionPoint)}}class xe extends he{constructor(e,t,n,s){super(e,new be(e,t.constraint,n.constraint),s,x.ALL),this.first=t,this.second=n}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Be(this.targetPoint,this.isDraped,this.domain)]}}let F=class extends Gt.EventedMixin(ct){constructor(i){super(i),this.options=new Rn,this.snappingEnginesFactory=Pn,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=q.MAIN}initialize(){this.handles.add([le(()=>{const{effectiveFeatureEnabled:i,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:n}=this.options;return{effectiveFeatureEnabled:i,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:n}},()=>{this.doneSnapping(),this.emit("changed")},qe),le(()=>this.options,i=>{for(const e of this._engines)e.options=i},qe),le(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:i,snappingEnginesFactory:e})=>this._recreateEngines(i,e),Te)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(i=>i.updating)}_recreateEngines(i,e){if(this._destroyEngines(),!i)return;const{view:t,options:n}=this;this._engines=e(t,n)}_destroyEngines(){for(const i of this._engines)i.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:i,touchSensitivityMultiplier:e}=this.options,t=i*e;return t*t}get _squaredSatisfiesConstraintThreshold(){return H.satisfiesConstraintScreenThreshold*H.satisfiesConstraintScreenThreshold}async snap(i){return bn(i)?this._snapMultiPoint(i):this._snapSinglePoint(i)}update(i){const{point:e,context:t}=i;this._removeVisualization();const n=this._currentMainCandidate;if(L(n))return e;const s=this._selectUpdateInput(i);if(L(s))return e;const{spatialReference:r}=t,o=Qe(s,r);if(L(o))return e;const{view:a}=this,{elevationInfo:l,visualizer:c}=t,d=[],h=ue(o,a,t),f=n.constraint.closestTo(h);if(!this._arePointsWithinScreenThreshold(h,f,t))return this._resetSnappingState(),e;n.targetPoint=f,d.push(...n.hints);for(const g of this._currentOtherActiveCandidates)g.targetPoint=f,d.push(...g.hints);return E(c)&&this.handles.add(c.draw(d,{spatialReference:r,elevationInfo:Nn(t),view:a,selfSnappingZ:t.selfSnappingZ}),we),nt(f,a,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:l})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:i,scenePoint:e}){switch(this._currentSnappedType){case q.MAIN:return i;case q.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=q.MAIN}_removeVisualization(){this.handles.remove(we)}async _snapSinglePoint({point:i,context:e,signal:t}){const{view:n}=this,s=ue(i,n,e),r=await this._fetchCandidates(s,x.ALL,e,t);return this._createSnapResult(s,q.MAIN,r,n,e,{z:i.z,m:i.m,spatialReference:i.spatialReference,elevationInfo:e.elevationInfo},t)}async _snapMultiPoint({point:i,scenePoint:e,context:t,signal:n}){const{view:s}=this,{coordinateHelper:r,spatialReference:o}=t;await Zt(e.spatialReference,o);const a=Qe(e,o),l=ue(a,s,t),c=await this._fetchCandidates(l,x.FEATURE,t,n);if(c.length>0){const f=await this._fetchCandidates(l,x.SELF,t,n);return this._createSnapResult(l,q.SCENE,[...c,...f],s,t,{z:a.z,m:a.m,spatialReference:a.spatialReference,elevationInfo:t.elevationInfo},n)}const d=ue(i,s,t),h=await this._fetchCandidates(d,x.SELF,t,n);return this._createSnapResult(d,q.MAIN,h,s,t,{z:r.hasZ()&&i.hasZ?i.z??0:void 0,m:r.hasM()&&i.hasM?i.m??0:void 0,spatialReference:i.spatialReference,elevationInfo:t.elevationInfo},n)}async _fetchCandidates(i,e,t,n){return(await Promise.all(this._engines.map(s=>s.fetchCandidates(i,e,t,n)))).flat()}_createSnapResult(i,e,t,n,s,r,o){return{get valid(){return!Wt(o)},apply:()=>{const{spatialReference:a}=s,{snappedPoint:l,hints:c}=this._processCandidates(i,e,t,s);return this._removeVisualization(),E(s.visualizer)&&this.handles.add(s.visualizer.draw(c,{spatialReference:a,elevationInfo:m,view:n,selfSnappingZ:s.selfSnappingZ}),we),nt(l,n,r)}}}_processCandidates(i,e,t,n){if(t.length<1)return this.doneSnapping(),{snappedPoint:i,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),Ye(i,t);const s=this._currentMainCandidate;if(E(s)){const r=this._findOldConstraintInNewCandidates(s,t);if(r>=0){if(!(t[r]instanceof xe))return this._intersectWithOtherCandidates(r,t,i,e,n);if(this._arePointsWithinScreenThreshold(i,s.targetPoint,n))return this._updateSnappingCandidate(s,e,t,n)}}return this._intersectWithOtherCandidates(0,t,i,e,n)}_findOldConstraintInNewCandidates(i,e){return i instanceof xe?this._findOldCandidateIndex(e,i.first)>=0&&this._findOldCandidateIndex(e,i.second)>=0?0:-1:this._findOldCandidateIndex(e,i)}_intersectWithOtherCandidates(i,e,t,n,s){const{coordinateHelper:r}=s,o=e[i],a=[];for(let l=0;l<e.length;++l){if(l===i)continue;const c=e[l];for(const d of o.constraint.intersect(c.constraint)){const h=d.closestTo(o.targetPoint);a.push([new xe(h,o,c,c.isDraped),this._squaredScreenDistance(t,h,r)])}}return a.length>0&&(a.sort((l,c)=>l[1]-c[1]),a[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(a[0][0],n,e,s):this._updateSnappingCandidate(o,n,e,s)}_updateSnappingCandidate(i,e,t,n){this.doneSnapping(),this._currentMainCandidate=i,this._currentSnappedType=e;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...i.hints);for(const o of t){if(i instanceof xe){if(o.constraint.equals(i.first.constraint)||o.constraint.equals(i.second.constraint))continue}else if(o.constraint.equals(i.constraint))continue;const a=o.constraint.closestTo(s);this._squaredScreenDistance(a,s,n.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(o.targetPoint=s,this._currentOtherActiveCandidates.push(o),r.push(...o.hints))}return{snappedPoint:s,hints:r}}_squaredPointProximityThreshold(i){return i==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(i,e,t){return this._squaredScreenDistance(i,e,t.coordinateHelper)<this._squaredPointProximityThreshold(t.pointer)}_squaredScreenDistance(i,e,t){return ie(this._toScreen(i,t),this._toScreen(e,t))}_toScreen(i,e){return w(i,e.spatialReference,m,this.view)}_findOldCandidateIndex(i,e){let t=-1;for(let n=0;n<i.length;++n)if(e.constraint.equals(i[n].constraint)){t=n;break}return t}get test(){return{visualizationsActive:this.handles.has(we),engines:this._engines}}};var q;p([u({constructOnly:!0})],F.prototype,"view",void 0),p([u()],F.prototype,"options",void 0),p([u({readOnly:!0})],F.prototype,"updating",null),p([u()],F.prototype,"snappingEnginesFactory",void 0),p([u()],F.prototype,"_engines",void 0),p([u()],F.prototype,"_squaredMouseProximityTreshold",null),p([u()],F.prototype,"_squaredTouchProximityThreshold",null),p([u()],F.prototype,"_squaredSatisfiesConstraintThreshold",null),F=p([ee("esri.views.interactive.snapping.SnappingManager")],F),function(i){i[i.MAIN=0]="MAIN",i[i.SCENE=1]="SCENE"}(q||(q={}));const we="visualization-handle";function bn(i){return E(i.scenePoint)}function Nn({coordinateHelper:i,elevationInfo:e}){return i.hasZ()?m:e}export{x as E,k as V,en as Z,$n as a,O as b,jn as c,Tt as d,Mn as e,Ne as f,cn as g,dn as h,Je as i,Bn as j,Jn as k,Dn as l,Kn as m,Rn as n,Be as o,H as p,Ye as q,En as r,kn as s,b as u,F as w};
