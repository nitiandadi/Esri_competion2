import{t as g,rm as Te,rn as xe,r as u,cq as C,fE as A,j7 as _,qJ as De,cg as xt,ro as Gt,im as Ft,h6 as Ut,fn as k,ft as B,fo as V,i7 as te,jd as J,hx as ze,gI as Dt,fp as dt,cv as X,rp as jt,fg as Ae,oM as vt,e as d,y as c,b as F,v as at,ba as zt,av as it,p as S,E as R,c2 as Re,s as ee,b3 as G,jj as He,hJ as St,g$ as ot,jt as Q,aD as W,rq as Mt,i0 as wt,h$ as Pt,fs as ie,ih as Bt,fz as ne,jz as ke,hZ as se,jf as ae,dy as oe,bB as H,ff as ct,rr as Le,il as Ve,k5 as Ee,fB as Ie,qT as pt,hC as D,cu as bt,D as Ct,A as Ge,cw as qt,bz as At,rs as $t,hH as Y,cr as Fe,cs as Ue,hU as je,hr as Ot,rt as Be,dc as qe,ru as Ne,hB as We,je as Je,hG as Ke,rv as re,qZ as Ye,q_ as Ze,q as Nt,rw as Xe,rx as Qe,ry as K,au as ti,ax as ei,h as le,bb as Wt,c8 as Jt}from"./mapviewstore-8a6f290e.js";import{n as ii}from"./AnalysisView3D-cc96cd7b.js";import{t as y,r as ni,u as si}from"./LengthDimension-5b1ff216.js";import{i as ai}from"./getDefaultUnitForView-09ed9ab9.js";import{v as de,g as oi}from"./quantityFormatUtils-6059fd77.js";import{f as q,g as ri}from"./Segment-07134633.js";import{j as li,y as di}from"./euclideanLengthMeasurementUtils-a4a01115.js";import{N as ci,i as ce,e as tt,x as pe,U as pi,D as ui,C as mi,V as Rt}from"./manipulatorUtils-6039567a.js";import{B as hi,C as ue,z as Ht}from"./dragEventPipeline3D-cb32ecbd.js";import{x as rt,w as kt,U as gi}from"./InteractiveToolBase-0db68d23.js";import{t as fi,a as _i}from"./SceneSnappingManagerPool-06fb7178.js";import{o as yi}from"./Factory-4952d2db.js";import{x as vi}from"./SnappingVisualizer3D-65e3df3f.js";import{g as U,n as Si,b as Mi,a as wi}from"./LineVisualElement-edc641a4.js";import{_ as Pi}from"./VerticesVisualElement-8ea8fef8.js";import{c as bi}from"./ImageMaterial-86134e3a.js";import{V as Ci,g as $i,w as Oi}from"./EditGeometryOperations-03e088f6.js";import{e as Ti}from"./SnappingContext-3f11e741.js";import{h as xi,m as Di}from"./SnappingOperation-f7fee6c6.js";import{m as zi,e as Kt}from"./SnappingManager-e678da87.js";import{a as Ai}from"./AnalysisToolBase-c24b1232.js";import{r as Ri}from"./RenderTexture-da0df617.js";import{s as Hi,m as ki,c as Li}from"./analysisViewUtils-c748d7fc.js";import"./index-93a23f67.js";import"./VisualElement-cf195c8c.js";import"./viewUtils-4b1f07e9.js";import"./elevationInfoUtils-db1a4384.js";import"./TextOverlayItem-0a39aaf7.js";import"./measurementUtils-834d1f5d.js";import"./drawUtils-04a6e6ca.js";import"./RightAngleQuadVisualElement-51086ef2.js";import"./VisualElementResources-219837dc.js";import"./PointVisualElement-e48a1b74.js";import"./geometry2dUtils-3b519363.js";import"./PointSnappingHint-65883099.js";import"./dehydratedFeatureComparison-baf6aa6d.js";import"./QueryEngineResult-555e15c4.js";import"./WhereClause-1d488167.js";import"./executionError-fb3f283a.js";import"./utils-da1501b7.js";import"./ClassBreaksDefinition-e0623088.js";import"./projectionSupport-2ac8e0ed.js";import"./json-48e3ea08.js";import"./utils-756c69af.js";function Vi(t,e,i){if(g(t))return null;const n=t.dimensionSegment.startRenderSpace,s=t.dimensionSegment.endRenderSpace,a=li(n,s,t.spatialReference);if(g(a))return null;const o=e===y.Vertical?Te(a.value,a.unit,i):xe(a.value,a.unit,i);return de(a,o)}function ut(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:s,orientation:a}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,offset:n,measureType:s,orientation:a}}function mt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:i,measureType:n,orientation:s},a,o=null){if(g(t)||g(e))return null;const l=he(u(o)?o.directSegment:new q,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},a),r=u(o)?o.primaryOffsetAxis:C();gt(r,{measureType:n,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:l,orientation:s,renderCoordsHelper:a});const p=u(o)?o.dimensionSegment:new q;return Lt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&n===y.Vertical?(A(p.startRenderSpace,l.startRenderSpace),A(p.endRenderSpace,l.endRenderSpace)):ge(p,{offsetAxis:r,offset:i,relativeToSegment:l,renderCoordsHelper:a}),{directSegment:l,dimensionSegment:p,primaryOffsetAxis:r,spatialReference:a.spatialReference}}function Yt(t,e,i,n){return e===nt.Start?(A(t.startRenderSpace,i.startRenderSpace),A(t.endRenderSpace,n.startRenderSpace)):(A(t.startRenderSpace,i.endRenderSpace),A(t.endRenderSpace,n.endRenderSpace)),t}var nt;function Ei(t,e,i,n){dt(t.startRenderSpace,e.startRenderSpace,i,n),dt(t.endRenderSpace,e.endRenderSpace,i,n)}function me(t,e,i,n){switch(e){case y.Direct:return he(t,i,n);case y.Horizontal:case y.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,dimension:o,geometry:l}=i;let r;o.measureType===y.Direct?(r=Ii(l,n)===s.z>a.z,e===y.Horizontal&&(r=!r)):r=!Gi(l);const[p,m]=r?[s,a]:[a,s],h=X(m,Fi);return e===y.Horizontal?h.z=p.z:(h.x=p.x,h.y=p.y),n.toRenderCoords(p,t.startRenderSpace),n.toRenderCoords(h,t.endRenderSpace),t}}}function he(t,e,i){return i.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),i.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}function Ii(t,e){const i=t.directSegment.eval(.5,_.get()),n=e.worldUpAtPosition(i,_.get()),s=t.dimensionSegment.eval(.5,_.get()),a=k(_.get(),s,i);return!te(a,J)&&V(a,n)>0}function Gi(t){const{startRenderSpace:e,endRenderSpace:i}=t.dimensionSegment,{startRenderSpace:n,endRenderSpace:s}=t.directSegment;return jt(n,e)<jt(s,i)}(function(t){t[t.Start=0]="Start",t[t.End=1]="End"})(nt||(nt={}));const Fi=Ae(0,0,0,null);function Ui(t,e,i,n){const{directSegment:s}=i,a=gt(_.get(),{measureType:e,directSegment:s,renderCoordsHelper:n}),o=ge(ji,{offsetAxis:a,offset:0,relativeToSegment:s,renderCoordsHelper:n}).eval(.5,_.get()),l=k(_.get(),t,o);return V(l,a)*n.unitInMeters}const ji=new q;function gt(t,e){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:a,endRenderSpace:o},directSegment:l,renderCoordsHelper:r}=e,p=l.eval(.5,_.get()),m=r.worldUpAtPosition(p,_.get()),h=r.worldBasisAtPosition(p,De.Y,_.get());switch(i){case y.Horizontal:A(t,m);break;case y.Vertical:V(a,m)<V(o,m)?k(t,o,a):k(t,a,o),B(t,t,m),B(t,t,m);break;case y.Direct:{const f=xt(e.orientation,0);if(Lt({elevationAlignedStartPoint:n,elevationAlignedEndPoint:s}))Gt(lt,-Ft(f),m),Ut(t,h,lt);else{const w=k(_.get(),o,a),P=B(_.get(),w,m);B(P,P,w),Gt(lt,Ft(f),w),Ut(t,P,lt)}break}}return te(t,J)?A(t,h):ze(t,t)}const lt=Dt();function Lt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return u(t)&&u(e)&&t.x===e.x&&t.y===e.y}function ge(t,e){const{offsetAxis:i,offset:n,relativeToSegment:{startRenderSpace:s,endRenderSpace:a},relativeToSegment:o,renderCoordsHelper:l}=e,r=n/l.unitInMeters,[p,m]=Bi(s,a,i,r);return dt(t.startRenderSpace,o.startRenderSpace,i,p),dt(t.endRenderSpace,o.endRenderSpace,i,m),t}function Bi(t,e,i,n=0){const s=V(e,i),a=V(t,i),o=Math.abs(s-a)+n;return s>a?[o,n]:[n,o]}function ft(t,e,i){const n=e.directSegment.eval(.5,_.get());return i.worldUpAtPosition(n,t)}function Vt(t,e){const{startRenderSpace:i,endRenderSpace:n}=e.directSegment;return k(t,n,i)}function Et(t,e,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:s}=e.dimensionSegment;return i.invert?k(t,n,s):k(t,s,n)}function Tt(t,e){const i=t.directSegment.eval(.5,_.get());return e.headingAtPosition(i,t.primaryOffsetAxis)}function qi(t,e){return vt(Et(Ni,t))/e**2}const Ni=C();function fe(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i}=t;if(g(e)||g(i))return!1;const n=di(e,i);return u(n)&&de(n,"meters").value>_e}const _e=1e5;function st(t){return u(t.geometry)}let j=class extends at{constructor(e){super(e),this._handles=new zt}initialize(){const{computations:e}=this.analysisViewData;for(const i of e)this._addComputation(i);this.addHandles(e.on("change",({added:i,removed:n})=>{for(const s of n)this._removeComputation(s);for(const s of i)this._addComputation(s)}))}destroy(){this._handles=it(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return ai(this.view)}_addComputation(e){this._handles.has(e)||this._handles.add(S(()=>ut(e),i=>{const{measureType:n}=i;if(fe(i)&&n!==y.Direct){const a=Math.round(Re(_e,"meters","kilometers"));return ee.getLogger(this.declaredClass).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${a} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const s=mt(i,this.view.renderCoordsHelper,e.geometry);e.geometry=s,e.result.length=Vi(s,n,this._defaultUnit)},R),e)}_removeComputation(e){this._handles.remove(e)}};d([c({constructOnly:!0})],j.prototype,"analysisViewData",void 0),d([c({constructOnly:!0})],j.prototype,"view",void 0),d([c()],j.prototype,"analysis",null),d([c()],j.prototype,"_defaultUnit",null),j=d([F("esri.views.3d.analysis.Dimension.support.DimensionController")],j);const ye={main:new G([255,127,0])};class Wi{constructor(){this.color=ye.main,this.opacity=.5,this.radius=5}}class Ji{constructor(){this.color=new G([127,127,127]),this.opacity=.5,this.radius=5}}class Ki{constructor(){this.lineSizeFraction=.8}}let Yi=class{constructor(){this.color=ye.main,this.opacity=.5,this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}};class Zi{constructor(){this.calloutOffsetPx=18,this.calloutOpacity=.5,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2}}let Xi=class{constructor(){this.lineSizeFraction=.25}};class Qi{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}}class tn{constructor(){this.color=new G([255,127,0,.5])}}let en=class{constructor(){this.pointManipulators=new Wi,this.offsetManipulator=new Yi,this.orientationManipulator=new Zi,this.markers=new Ki,this.labels=new Qi,this.offsetLine=new Xi,this.constraint=new tn,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new Ji,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}};const v=new en;class nn{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&e===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const i of ni)e(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(e){switch(e){case y.Direct:return this.direct;case y.Horizontal:return this.horizontal;case y.Vertical:return this.vertical}}}function sn(t,e){const i=ci(t,G.toUnitRGB(v.pointManipulators.color),v.pointManipulators.opacity,L);return i.available=!1,i.grabCursor="crosshair",i.radius=v.pointManipulators.radius,i.metadata=e.metadata,i.collisionPriority=1,i}function an(t,e){const i=[ct(-.5,0,0),ct(.5,0,0)],{lengthFraction:n}=v.offsetManipulator,s=St(e.unfocusedMaterial,i.map(o=>ot(C(),o,n))),a=s.instantiate({material:e.focusedMaterial});return new ce({view:t,renderObjects:[new tt(s,Q.Unfocused|Q.Selected|L),new tt(a,Q.Focused|L)],collisionType:{type:"line",paths:[i]},radius:It(e.lineSizePt)/2,metadata:e.metadata,available:!1,...pe})}function ve(t,{lineSizePt:e,material:i}){const{calloutOffsetPx:n,calloutOpacity:s,calloutWidth:a,discScale:o,focusMultiplier:l}=v.orientationManipulator;return{calloutLength:.25*Le*v.markers.lineSizeFraction*H(e)+n,calloutOpacity:s,calloutWidth:a,customStateMask:L,discScale:o,focusMultiplier:l,material:i,metadata:t}}function Zt(t,e){return pi(t,ve(e.metadata,e))}function Xt(t,e){ui(t,ve(t.metadata,e))}function on(t,e){const i=[ct(-.5,0,0),ct(.5,0,0)],{lengthFraction:n}=v.offsetManipulator,s=St(e.thinOffsetManipulatorMaterial,i),a=St(e.unfocusedMaterial,i.map(l=>ot(C(),l,n))),o=a.instantiate({material:e.focusedMaterial});return new ce({view:t,renderObjects:[new tt(a,Q.Unfocused|L),new tt(o,Q.Focused|L),new tt(s,L)],collisionType:{type:"line",paths:[i]},radius:It(e.lineSizePt)/2,available:!1,metadata:e.metadata,...pe})}function rn(t,{isStart:e,createSnappingPipelineStep:i,dimension:n,onUpdate:s,view:a}){const o=e?"startPoint":"endPoint";return[rt(t,(r,p,m,h)=>{const f=Ht(r),{snappingStep:w,cancelSnapping:P}=i(h);m=m.next(f).next(kt(n,[o,"measureType","orientation"])).next(P),p.next(f).next(hi(a)).next(...w).next(O=>{const M=X(O.mapEnd,new W);s(o==="startPoint"?{startPoint:M}:{endPoint:M})})})]}function ln(t,{computation:e,view:i}){return[rt(t,(n,s,a)=>{if(!st(e)||!n.selected)return;const{geometry:o,dimension:l}=e,r=Ht(n);s.next(r).next(Me(i,l,o.dimensionSegment,o.primaryOffsetAxis)),a.next(r).next(kt(l,["offset"]))})]}function dn(t,{computation:e,view:i}){return[rt(t,(n,s,a)=>{Se({cancel:a,computation:e,settingHeading:!0,steps:s,view:i})})]}function cn(t,{computation:e,view:i}){return[rt(t,(n,s,a)=>{Se({cancel:a,computation:e,settingHeading:!1,steps:s,view:i})}),t.events.on("immediate-click",n=>{pn(n,e,i)})]}function pn(t,e,i){const{dimension:n,geometry:s}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void t.stopPropagation();if(g(s))return;const{renderCoordsHelper:a}=i,o=mt({...ut(e),orientation:90},a),l=mt({...ut(e),orientation:270},a);if(g(o)||g(l))return;const r=Tt(o,a),p=Tt(l,a),m=we(s,i),h=Mt.shortestSignedDiff(m,r),f=Mt.shortestSignedDiff(m,p);n.orientation=Math.abs(h)<Math.abs(f)?90:270,t.stopPropagation()}function Se(t){const{cancel:e,computation:i,settingHeading:n,steps:s,view:a}=t;if(!st(i))return;const{renderCoordsHelper:o}=a,{dimension:l,geometry:r}=i,p=C(),m=be(C(),r,r.directSegment,o),h=Ce(_.get(),{forHeading:n,geometry:r,renderCoordsHelper:o}),f=wt(m,h,Pt()),w=xt(l.orientation,n?()=>Tt(r,a.renderCoordsHelper):0);s.next(ue(a,f)).next(P=>{P.action==="start"&&A(p,P.renderStart);const O=Ve(f),M=mi(p,P.renderEnd,m,O);let E=w-Ee(M);n||(E=un(E)),l.orientation=E}),e.next(kt(l,["orientation"]))}function un(t){const e=Mt.normalize(t)%90;return e<v.orientationSnapThresholdDegrees?t-e:90-e<v.orientationSnapThresholdDegrees?t+(90-e):t}function mn(t,{computation:e,manipulatorMeasureType:i,view:n}){let s=y.Direct,a=0,o=0;return[t.events.on("grab-changed",l=>{if(l.action!=="start"||!st(e))return;const{dimension:r,geometry:p}=e;s=r.measureType,a=r.offset,o=r.orientation;const m=A(_.get(),t.renderLocation);r.measureType=i,r.offset=Ui(m,i,p,n.renderCoordsHelper),r.orientation=0}),rt(t,(l,r,p)=>{if(!st(e))return;const{geometry:m,dimension:h}=e,{renderCoordsHelper:f}=n,w=me($e,i,e,f),P=gt(_.get(),{measureType:i,directSegment:m.directSegment,renderCoordsHelper:f}),O=Ht(l);r.next(O).next(Me(n,h,w,P)),p.next(O).next(M=>(h.measureType=s,h.offset=a,h.orientation=o,M))})]}function Me(t,e,i,n){const s=ie(_.get(),i.endRenderSpace,i.startRenderSpace);B(s,s,n);const a=wt(i.startRenderSpace,s,Pt()),o=wt(i.startRenderSpace,n,Pt()),l=e.offset;let r,p=0;const m=new gi;return m.next(ue(t,a)).next(h=>{h.action==="start"&&(p=Bt(o,h.renderStart));const f=(Bt(o,h.renderEnd)-p)*t.renderCoordsHelper.unitInMeters;e.offset=l+f,r=h}),h=>(m.execute(h),r)}function we(t,e){const{directSegment:i}=t,{renderCoordsHelper:n}=e,s=ft(_.get(),t,n),a=Vt(_.get(),t),o=B(_.get(),a,s),{viewForward:l}=e.state.camera;V(o,l)>0&&ot(o,o,-1);const r=i.eval(.5,_.get());return n.headingAtPosition(r,o)}function hn(t,e,i){const{dimensionSegment:n,primaryOffsetAxis:s}=e,a=Et(et,e),o=ne(a,J)?ke(ht):Rt(a,s,J,ht),l=Math.max(se(a),v.offsetManipulator.minLengthMeters/i.unitInMeters);ae(o,o,oe(et,l,l,l)),t.modelTransform=o,t.renderLocation=n.eval(.5,et)}function gn(t,e,i){Pe(t,e,i,{forHeading:!0})}function fn(t,e,i){Pe(t,e,i,{forHeading:!1})}function Pe(t,e,i,{forHeading:n}){const{dimension:s,geometry:a}=e,{primaryOffsetAxis:o}=a,l=ot(_n,o,s.offset>=0?1:-1),r=Ce(yn,{forHeading:n,geometry:a,renderCoordsHelper:i});B(r,r,l);const p=Rt(l,r,J,ht);t.modelTransform=p,t.renderLocation=be(et,a,a.dimensionSegment,i)}const _n=C(),yn=C();function vn(t,e,i,n){const{geometry:s}=e,a=me($e,i,e,n),o=gt(et,{measureType:i,directSegment:s.directSegment,renderCoordsHelper:n}),l=k(_t,a.endRenderSpace,a.startRenderSpace),r=Rt(l,o,J,ht),p=se(l);ae(r,r,oe(_t,p,p,p)),t.modelTransform=r,t.renderLocation=a.eval(.5,_t)}function be(t,e,i,n){const{startRenderSpace:s,endRenderSpace:a}=i,o=Sn(e,n)?s:a;return A(t,o)}function Ce(t,{forHeading:e,geometry:i,renderCoordsHelper:n}){return e?ft(t,i,n):Et(t,i,{invert:!0})}function Sn(t,e){const i=Vt(Mn,t),n=ft(wn,t,e);return V(i,n)>0}const Mn=C(),wn=C();function Pn(t){return H(t)+v.offsetManipulator.linePaddingPx}function It(t){return H(t)+v.offsetManipulator.focusedLinePaddingPx}const L=He.Custom1,et=C(),_t=C(),ht=Dt(),$e=new q;var z;function bn(t,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,geometry:t.geometry}}function Cn(t,e){if(fe(t))return z.Direct;if(!t.enabled)return null;const{geometry:i}=t;if(g(i)||ne(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{constraintThresholdPx:n}=v,{camera:s}=e.state,a=ft(_.get(),i,e.renderCoordsHelper),o=Vt(_.get(),i),l=ot(_.get(),a,V(o,a)),r=ie(_.get(),o,l),p=vt(r),m=vt(l),{startRenderSpace:h,endRenderSpace:f}=i.directSegment,w=Math.max(s.computeRenderPixelSizeAt(h)*n,s.computeRenderPixelSizeAt(f)*n)**2;return p<w?z.Vertical:m<w?z.Horizontal:null}function $n(t,e,{constraint:i,view:n}){const{unconstrainedGeometry:s}=t;if(g(s))return;const{renderCoordsHelper:a,spatialReference:o}=n,{startRenderSpace:l,endRenderSpace:r}=s.directSegment,p=a.fromRenderCoords(l,new W,o),m=a.fromRenderCoords(r,new W,o);let h;h=e==="start"?{startPoint:p}:{endPoint:m},Oe(t,h,{constraint:i,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,unconstrainedGeometry:s,view:n})}function Oe(t,e,i){const{constraint:n,elevationAlignedStartPoint:s,elevationAlignedEndPoint:a,unconstrainedGeometry:o,view:l}=i,{dimension:r,previousConstraint:p,preConstraintProperties:m}=t;if(g(s)||g(a))return;const h=()=>{"startPoint"in e?r.startPoint=e.startPoint:"endPoint"in e&&(r.endPoint=e.endPoint)};if(g(n))h(),u(p)&&u(m)&&(r.measureType=m.measureType,r.orientation=m.orientation);else switch(r.measureType=y.Direct,n){case z.Horizontal:if(n!==p&&(r.orientation=0),"startPoint"in e){const f=e.startPoint;u(f)&&(f.z=a.z),r.startPoint=f}else if("endPoint"in e){const f=e.endPoint;u(f)&&(f.z=s.z),r.endPoint=f}break;case z.Vertical:if(n!==p&&(r.orientation=we(o,l)),"startPoint"in e){const f=e.startPoint;u(f)&&(f.x=a.x,f.y=a.y),r.startPoint=f}else if("endPoint"in e){const f=e.endPoint;u(f)&&(f.x=s.x,f.y=s.y),r.endPoint=f}break;case z.Direct:n!==p&&u(m)&&(r.orientation=m.orientation),h()}t.previousConstraint=n,t.unconstrainedGeometry=o}(function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Direct=2]="Direct"})(z||(z={}));let b=class extends Ie{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new zt,this._getSnappingContext=fi(i=>new Ti({elevationInfo:{mode:"absolute-height",offset:0},pointer:i,editGeometryOperations:new Ci(new $i("point",Oi(!0,!1,this.view.spatialReference))),visualizer:new vi})),this._snappingManagerResult=_i(t.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=yt(),this._focusedOffsetManipulatorMaterial=yt(),this._thinOffsetManipulatorMaterial=yt(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:pt(2)}),this._constraintSnappingIndicator=new U({view:t.view,attached:!0,width:1,color:G.toUnitRGBA(v.constraint.color),renderOccluded:D.OccludeAndTransparent,stipplePattern:pt(5)});const e=G.toUnitRGBA(v.disabledPointIndicator.color);e[3]*=v.disabledPointIndicator.opacity,this._stagedStartIndicator=new Pi({view:t.view,attached:!1,color:e,size:2*v.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:D.OccludeAndTransparent})}initialize(){this._snappingOperation=new xi({view:this.view}),this._orientationManipulatorTexture=yi(this.view.toolViewManager.textures),this._orientationManipulatorMaterial=new bi({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:D.Opaque});const{computations:t}=this.analysisViewData;for(const e of t)this._addComputation(e);this.addHandles([t.on("after-add",e=>this._addComputation(e.item)),t.on("after-remove",e=>this._removeComputation(e.item))]),this.addHandles([S(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:e,stagedComputation:i})=>{if(g(i)||g(e))return;const n=X(e,new W);this._applyPointUpdate(i,{endPoint:n})},bt),S(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(e,i)=>{const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:a}=e;if(n===(i==null?void 0:i.stagedDimension)&&a===(i==null?void 0:i.firstGrabbedManipulator)){for(const o of[s,i==null?void 0:i.selectedComputation])if(u(o)){const l=this._computationManipulators.get(o);this._updateManipulators(o,l,e)}}else for(const[o,l]of this._computationManipulators)this._updateManipulators(o,l,e)},R),S(()=>this.analysis.style.lineSize,e=>{this._updateManipulatorStyle(e)},Ct),S(()=>this.view.state.camera,()=>{u(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)}),S(()=>Ge(this._stagedComputation,e=>{const i=e.elevationAlignedStartPoint,n=C();return u(i)&&this.view.renderCoordsHelper.toRenderCoords(i,n)?n:null}),e=>{u(e)?(this._stagedStartIndicator.vertices=[e],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),zi(this,()=>{const e=this._activeComputation,i=this._stagedComputation;if(g(e)||u(i)){const n=xt(this.view.inputManager.latestPointerType,"mouse"),s=this._getSnappingContext(n);this.updatingHandles.addPromise(qt(this._snappingOperation.resnap(this._snappingManager,s)))}if(u(e)){const{start:n,end:s}=this._computationManipulators.get(e);if(n.grabbing||s.grabbing){const a=n.grabbing?"start":"end",o=this._computeConstraint(e);$n(e,a,{constraint:o,view:this.view})}}})}destroy(){this._snappingOperation=it(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(u(this._stagedComputation))return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&u(t)?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return g(t)||g(e)||e.dimension!==t?null:e}get _constraintHandles(){return[At(()=>this.analysisViewData.selectedComputation,t=>{t.previousConstraint=this._computeConstraint(t)},{...R,equals:$t}),S(()=>{const t=this._activeComputation;if(g(t))return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}},(t,e)=>{if(u(t)&&g(e)){const{measureType:i,orientation:n,computation:s}=t;switch(s.previousConstraint){case z.Horizontal:s.preConstraintProperties={measureType:y.Horizontal,orientation:0};break;case z.Vertical:s.preConstraintProperties={measureType:y.Vertical,orientation:0};break;case z.Direct:s.preConstraintProperties={measureType:y.Direct,orientation:n};break;default:s.preConstraintProperties={measureType:i,orientation:n}}}g(t)&&u(e)&&(e.computation.preConstraintProperties=null)},bt)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[S(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(t),g(i))n.attached=!1;else if(i===e)n.attached=!0;else{const{start:s,end:a}=this._computationManipulators.get(i),o=()=>{n.attached=s.grabbing||a.grabbing};o(),this.addHandles([s.events.on("grab-changed",o),a.events.on("grab-changed",o)],t)}}),S(()=>{const e=this._activeComputation;return u(e)?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:i})=>{const n=this._constraintSnappingIndicator;u(e)&&u(i)&&i!==z.Direct?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return!!u(this._stagedDimension)&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(g(e)){const i=this._onUnstagedClick(t);return this.analysis.dimensions.add(i),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if(e==="touch")return;const i=this._getSnappingContext(e);this.updatingHandles.addPromise(qt(this._snappingOperation.snap({point:t},this._snappingManager,i)))}onManipulatorSelectionChanged(){u(this.analysisViewData.selectedComputation)&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let i=t;if(e==="mouse"){const s=this._getSnappingContext(e);i=this._snappingManager.update({point:t,context:s})}const n=new si({startPoint:X(i,new W),endPoint:null,measureType:y.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(g(i))return;let n=t;if(e==="mouse"){const a=this._getSnappingContext(e);n=this._snappingManager.update({point:t,context:a})}const s=X(n,new W);this._applyPointUpdate(i,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(t){if(this._computationManipulators.has(t))return;const e=this._setupPointManipulator(t,{isStart:!0}),i=this._setupPointManipulator(t,{isStart:!1}),n=this._setupOffsetManipulator(t),s=this._setupHeadingManipulator(t),a=this._setupRotationManipulator(t),o=this._setupMeasureTypeManipulator(t,y.Direct),l=this._setupMeasureTypeManipulator(t,y.Horizontal),r=this._setupMeasureTypeManipulator(t,y.Vertical),p=new nn({start:e,end:i,offset:n,heading:s,rotation:a,direct:o,horizontal:l,vertical:r});this._setupComputationToManipulatorsSync(t,p),this._computationManipulators.set(t,p),this.manipulators.addMany(p.values())}_removeComputation(t){const e=this._computationManipulators.get(t);if(!g(e)){this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const i of e.values())this.manipulators.remove(i)}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([S(()=>t.geometry,()=>this._updateManipulators(t,e),{...R,equals:$t})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:n}=t,s=sn(i,{metadata:n}),a=rn(s,{isStart:e.isStart,createSnappingPipelineStep:o=>Di({snappingContext:this._getSnappingContext(o),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:n,onUpdate:o=>this._applyPointUpdate(t,o),view:i});return this._computationHandles.add(a,t),s}_setupOffsetManipulator(t){const{view:e}=this,i=an(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),n=ln(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=Zt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=dn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupRotationManipulator(t){const{view:e}=this,i=Zt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=cn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,n=on(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),s=mn(n,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(s,t),n}_updateManipulators(t,e,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:a}=i,{start:o,end:l,offset:r,heading:p,rotation:m}=e,h=s===t,f=st(t),{dimension:w}=t;for(const M of e.values()){const E=f&&g(n)&&(g(a)||M===a);M===r?(M.available=E,M.selected=h):M.available=E&&h}if(!f)return;u(this._computeConstraint(t))?e.forEachMeasureTypeManipulator(M=>M.available=!1):e.manipulatorForMeasureType(w.measureType).available=!1;for(const M of[p,m])w.measureType===y.Direct&&w.offset!==0||(M.available=!1);Lt(t)?m.available=!1:p.available=!1;const{geometry:P}=t;o.renderLocation=P.directSegment.startRenderSpace,l.renderLocation=P.directSegment.endRenderSpace;const{renderCoordsHelper:O}=this.view;hn(r,P,O),p.available&&gn(p,t,O),m.available&&fn(m,t,O),e.forEachMeasureTypeManipulator((M,E)=>{M.available&&vn(M,t,E,O)})}_updateManipulatorStyle(t){const e=Pn(t),i=It(t),n={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:a,rotation:o}of this._computationManipulators.values())s.radius=i/2,Xt(a,n),Xt(o,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(t,e){const{view:i}=this,n=ut(t);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const s=mt(n,i.renderCoordsHelper);if(g(s))return;const a=this._computeConstraint({...n,geometry:s});Oe(t,e,{...n,constraint:a,unconstrainedGeometry:s,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(g(t.geometry))return;t.geometry.directSegment.eval(.5,Qt);const e=this.view.state.camera.computeRenderPixelSizeAt(Qt);t.dimension.offset=v.initialOffsetPx*e}_computeConstraint(t){return Cn(bn(t,this._snappingManager.options),this.view)}get testInfo(){const t=e=>this.analysisViewData.computations.find(i=>i.dimension===e);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=D.Occlude,this.manipulators.forEach(({manipulator:e})=>{for(const{geometry:i}of e.renderObjects)i.material.setParameters({renderOccluded:D.Occlude})})},getManipulatorsForDimension:e=>this._computationManipulators.get(t(e)),getComputationForDimension:e=>t(e),getConstraintForDimension:e=>{const i=t(e);return u(i)?this._computeConstraint(i):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function yt(){const{color:t,opacity:e}=v.offsetManipulator;return new Y({color:[...G.toUnitRGB(t),e],width:1,renderOccluded:D.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}d([c({constructOnly:!0})],b.prototype,"analysis",void 0),d([c({constructOnly:!0})],b.prototype,"analysisViewData",void 0),d([c({constructOnly:!0})],b.prototype,"manipulators",void 0),d([c({constructOnly:!0})],b.prototype,"parentTool",void 0),d([c({constructOnly:!0,nonNullable:!0})],b.prototype,"view",void 0),d([c({readOnly:!0})],b.prototype,"updating",null),d([c()],b.prototype,"firstGrabbedManipulator",null),d([c()],b.prototype,"hasGrabbedManipulators",null),d([c()],b.prototype,"snappingOptions",null),d([c()],b.prototype,"_stagedDimension",void 0),d([c()],b.prototype,"_activeComputation",null),d([c()],b.prototype,"_stagedComputation",null),b=d([F("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],b);const Qt=C();var N;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(N||(N={}));let T=class extends Ai{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=v.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=Fe(this.view.state.viewingMode),this._intersector.options.store=Ue.MIN,this._lengthDimensionSubTool=new b({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([je(this._lengthDimensionSubTool),Ot(()=>this._clearPointerMoveTimeout()),S(()=>this.state,t=>{t===N.Created&&this.finishToolCreation()},R),At(()=>this.firstGrabbedManipulator,t=>{this.selectedDimension=t.metadata},R),S(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),R)])}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?u(this._activeSubTool)?N.Creating:N.Created:N.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":if(Kt.cancel===t.key){if(u(this._activeSubTool)&&this._activeSubTool.removeStaged())return void t.stopPropagation();this.active||(this.selectedDimension=null)}else Kt.delete.includes(t.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){u(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(g(this._activeSubTool))return;const e=this._intersectScreen(t);g(e)||(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),g(this._activeSubTool)||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);g(e)||this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_deleteKeyHandler(){u(this._activeSubTool)&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(t){const e=Be(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,n=_.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){u(this.selectedDimension)&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=qe(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(t=>{t.manipulator.state|=L}),this._prevPointerMoveTimeout=Ne.setTimeout(()=>{this.manipulators.forEach(t=>{t.manipulator.state&=~L})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:t=>{this._pointerMoveTimerMs=t,this._resetPointerMoveTimeout()}}}};d([c({constructOnly:!0})],T.prototype,"view",void 0),d([c({constructOnly:!0})],T.prototype,"analysis",void 0),d([c({readOnly:!0})],T.prototype,"state",null),d([c({readOnly:!0})],T.prototype,"updating",null),d([c({readOnly:!0})],T.prototype,"cursor",null),d([c({constructOnly:!0})],T.prototype,"analysisViewData",void 0),d([c()],T.prototype,"selectedDimension",null),d([c()],T.prototype,"automaticManipulatorSelection",void 0),d([c()],T.prototype,"_activeSubTool",void 0),d([c()],T.prototype,"_lengthDimensionSubTool",void 0),T=d([F("esri.views.3d.analysis.Dimension.DimensionTool")],T);let On=class extends Si{constructor(e,i){super(e),this._hasExternalMaterial=!1,this._renderOccluded=D.OccludeAndTransparent,this._width=1,this._color=We(1,0,1,1),this._placement="end",this._textureId=null,this._material=i,this._hasExternalMaterial=u(i),this.applyProps(e)}setGeometryFromSegment(e,i){const n=e.endRenderSpace;this.transform=Je(Tn,n),this._normal=i;const{points:s}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return u(this._material)?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,u(this._material)&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return u(this._material)?this._material.parameters.width:this._width}set width(e){this._width=e,u(this._material)&&this._material.setParameters({width:e})}get color(){return u(this._material)?this._material.parameters.color:this._color}set color(e){this._color=Ke(e),u(this._material)&&this._material.setParameters({color:this._color})}get placement(){return u(this._material)?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,u(this._material)&&this._material.setParameters({placement:this._placement})}get textureId(){return u(this._material)?this._material.parameters.textureId:this._textureId}set textureId(e){this._textureId=e,u(this._material)&&this._material.setParameters({textureId:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new re({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,textureId:this._textureId}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const i of Ye(this.geometry,this.normal)){const n=Ze(Nt(this._material),i);e.addGeometry(n)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(Nt(this._material))}};const Tn=Dt();class xn{set visible(e){for(const i of this._visualElements.values())i.attached=e}constructor(e){this.destroyed=!1,this._handles=new zt,this._messages=null,this._labelSegment=new q;const{analysis:i,computation:n,view:s,messages:a}=e;this.analysis=i,this.computation=n,this.view=s,this._messages=a;const o=e.visible,l={view:s,attached:o},{fontSize:r,textColor:p,textBackgroundColor:m}=i.style;this._visualElements=new Hn({marker:new On(l,e.markerMaterial),dimension:new U(l,e.dimensionLineMaterial),startOffset:new U(l,e.offsetLineMaterial),endOffset:new U(l,e.offsetLineMaterial),dimensionSmall:new U(l,e.smallDimensionLineMaterial),startOffsetSmall:new U(l,e.smallOffsetLineMaterial),endOffsetSmall:new U(l,e.smallOffsetLineMaterial),label:new ri({view:s,attached:o,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:H(r),textColor:p.clone(),backgroundColor:m.clone()})}),this._handles.add([S(()=>n.geometry,h=>{this.updateCameraDependentElements(s.state.camera,h,i.style),u(n.geometry)&&this._updateLines(n.geometry)},{...Ct,equals:$t}),S(()=>n.length,h=>this._updateLabelContent(h),Ct)])}destroy(){this.destroyed=!0,this._handles=it(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const i=Yt(zn,nt.Start,e.directSegment,e.dimensionSegment),n=Yt(An,nt.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(i),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(i),s.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(e,i,n){const s=this._visualElements;if(g(i)){for(const O of s.values())O.visible=!1;return}const a=e.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,Rn)),o=qi(i,a),l=o<(H(n.lineSize)*v.smallScreenLengthLineSizeFactor)**2,r=!l;s.marker.visible=r,s.dimension.visible=r,s.startOffset.visible=r,s.endOffset.visible=r,s.dimensionSmall.visible=l,s.startOffsetSmall.visible=l,s.endOffsetSmall.visible=l;const p=H(n.fontSize)*v.labels.minScreenLengthFontSizeFactor,{label:m}=s;if(m.visible=o>=p**2,!m.visible)return;const{dimensionSegment:h,primaryOffsetAxis:f}=i,{offset:w}=this.computation.dimension,P=(Math.sign(w)>=0?1:-1)*Dn(n)*a;Ei(this._labelSegment,h,f,P),m.updateLabelPosition()}updateLabelStyle(e){const{label:i}=this._visualElements;i.fontSize=H(e.fontSize),i.textColor=e.textColor,i.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(e){const{label:i}=this._visualElements;g(e)||g(this._messages)?i.text="":i.text=oi(this._messages,e,e.unit)}}function Dn(t){return 1.5*H(t.fontSize)+v.labels.marginPx+H(t.lineSize/2)}const zn=new q,An=new q,Rn=C();class Hn{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let kn=class{constructor(e,i){this._textures=e,this._textureRepository=i,this._texturesByPrimitive=new Map}acquire(e){if(!this._texturesByPrimitive.has(e)){const i=Xe(this._textures,e),n=new Ri(this._textureRepository,i.texture.id);return this._texturesByPrimitive.set(e,{result:i,reference:n}),i.texture}return this._texturesByPrimitive.get(e).result.texture}destroy(){this._texturesByPrimitive.forEach(({result:e,reference:i})=>{i.dispose(),e.release()}),this._texturesByPrimitive.clear()}},I=class extends at{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(t){super(t),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new re({width:1,anchor:Qe.Tip,color:K,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:D.OccludeAndTransparent}),this._dimensionLineMaterial=new Y({width:1,color:K,renderOccluded:D.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new Y({width:1,color:K,renderOccluded:D.OccludeAndTransparent,stipplePattern:pt(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new Y({width:1,color:K,renderOccluded:D.OccludeAndTransparent}),this._smallOffsetLineMaterial=new Y({width:1,color:K,renderOccluded:D.OccludeAndTransparent,stipplePattern:pt(5),stippleScaleWithLineWidth:!0})}initialize(){var i;const t=(i=this.view.sharedSymbolResources)==null?void 0:i.textures;if(u(t)){const{textureRepository:n}=this.view._stage.renderView,s=new kn(t,n),a=s.acquire("triangle");this.addHandles(Ot(()=>s.destroy())),this._markerMaterial.setParameters({textureId:a.id})}for(const n of this._lineMaterials())this.view._stage.add(n),this.addHandles(Ot(()=>{this.view._stage.remove(n),n.dispose()}));const{computations:e}=this.analysisViewData;for(const n of e)this._addComputation(n);this.addHandles([e.on("change",({added:n,removed:s})=>{for(const a of s)this._removeComputation(a);for(const a of n)this._addComputation(a)}),S(()=>G.toUnitRGBA(this.analysis.style.color),n=>{for(const s of this._lineMaterials())s.setParameters({color:n})},R),S(()=>this.analysis.style.lineSize,n=>{const s=H(n);this._markerMaterial.setParameters({width:s*v.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:s,markerParameters:this._markerMaterial.parameters});const a=Math.max(s*v.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:a})},R),S(()=>({camera:this.view.state.camera,style:Ln(this.analysis)}),({camera:n,style:s})=>{for(const[a,o]of this._dimensionVisualizations)o.updateCameraDependentElements(n,a.geometry,s),o.updateLabelStyle(s)}),S(()=>this.visible,n=>{for(const s of this._dimensionVisualizations.values())s.visible=n})]),this.addHandles([ti(()=>this._updateMessageBundle()),At(()=>!this.loadingMessages,()=>{for(const n of this._dimensionVisualizations.values())n.updateUnitsMessages(this._messages)},bt)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(t=>{t.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const t of this._lineMaterials())t.setParameters({renderOccluded:D.Occlude})}}}_addComputation(t){this._dimensionVisualizations.has(t)||this._dimensionVisualizations.set(t,new xn({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(t){const e=this._dimensionVisualizations.get(t);g(e)||(e.destroy(),this._dimensionVisualizations.delete(t))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await ei("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Ln(t){const{fontSize:e,lineSize:i,textColor:n,textBackgroundColor:s}=t.style;return{fontSize:e,lineSize:i,textBackgroundColor:s.clone(),textColor:n.clone()}}d([c({constructOnly:!0})],I.prototype,"analysisViewData",void 0),d([c({constructOnly:!0,nonNullable:!0})],I.prototype,"view",void 0),d([c()],I.prototype,"analysis",null),d([c()],I.prototype,"visible",null),d([c()],I.prototype,"loadingMessages",void 0),I=d([F("esri.views.3d.analysis.Dimension.DimensionVisualization")],I);let Z=class extends at{constructor(t){super(t),this.dimension=null,this.length=null}};d([c({constructOnly:!0,nonNullable:!0})],Z.prototype,"dimension",void 0),d([c()],Z.prototype,"length",void 0),Z=d([F("esri.views.3d.analysis.LengthDimensionResult")],Z);const Vn=Z;let x=class extends at{constructor(t){super(t),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...i}=t;return{result:new Vn({dimension:e}),...i}}initialize(){this.addHandles([S(()=>this.dimension.startPoint,t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t),R),S(()=>this.dimension.endPoint,t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t),R)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};d([c({constructOnly:!0,nonNullable:!0})],x.prototype,"result",void 0),d([c({constructOnly:!0,nonNullable:!0})],x.prototype,"projectAndAlignPoint",void 0),d([c()],x.prototype,"dimension",null),d([c()],x.prototype,"length",null),d([c()],x.prototype,"geometry",void 0),d([c()],x.prototype,"unconstrainedGeometry",void 0),d([c()],x.prototype,"elevationAlignedStartPoint",void 0),d([c()],x.prototype,"elevationAlignedEndPoint",void 0),d([c()],x.prototype,"preConstraintProperties",void 0),d([c()],x.prototype,"previousConstraint",void 0),x=d([F("esri.views.3d.analysis.LengthDimensionComputation")],x);const En=t=>{let e=class extends t{constructor(...i){super(...i),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new le}createLengthDimensions(i){throw new Error("Method not implemented.")}};return d([c({constructOnly:!0})],e.prototype,"view",void 0),d([c({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),d([c()],e.prototype,"tool",void 0),d([c({readOnly:!0})],e.prototype,"results",null),d([c()],e.prototype,"selectedDimension",void 0),d([c()],e.prototype,"interactive",void 0),d([c()],e.prototype,"visible",void 0),e=d([F("esri.views.analysis.DimensionAnalysisView")],e),e};let $=class extends En(ii(at)){constructor(t){super(t),this.type="dimension-view-3d",this.tool=null,this.computations=new le,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=t=>{if(g(t))return null;const{spatialReference:e,elevationProvider:i}=this.view,n=Mi(t,e,i);return g(n)&&wi(this.analysis,t.spatialReference,ee.getLogger(this.declaredClass)),n},this.addHandles([Hi(this,T),Wt(()=>this.analysis.dimensions,"after-add",t=>this._onDimensionAdd(t.item),{onListenerAdd:t=>{for(const e of t)this._onDimensionAdd(e)},onListenerRemove:()=>{this._onDimensionsClear()}}),Wt(()=>this.analysis.dimensions,"after-remove",t=>this._onDimensionRemove(t.item))]),this._analysisVisualization=new I({analysisViewData:this,view:this.view}),this._analysisController=new j({analysisViewData:this,view:this.view})}destroy(){this._placementTask=Jt(this._placementTask),this._analysisVisualization=it(this._analysisVisualization),ki(this)}get updating(){var t;return((t=this._analysisVisualization)==null?void 0:t.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToComputations.get(t).result)}get selectedComputation(){const{selectedDimension:t}=this;return g(t)?null:this._dimensionsToComputations.get(t)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(t){return this.selectedDimension=null,this._placementTask=Jt(this._placementTask),this._placementTask=Li(this,t),this._placementTask.promise}_onDimensionAdd(t){const{computations:e,_dimensionsToComputations:i}=this;if(i.has(t))return;const n=new x({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});e.add(n),i.set(t,n)}_onDimensionRemove(t){const{computations:e,_dimensionsToComputations:i}=this,n=e.findIndex(a=>a.dimension===t),s=e.getItemAt(n);s.dimension===this.selectedDimension&&(this.selectedDimension=null),e.removeAt(n),i.delete(t),it(s)}_onDimensionsClear(){this.computations.drain(t=>t.destroy()),this._dimensionsToComputations.clear()}};d([c({readOnly:!0})],$.prototype,"type",void 0),d([c()],$.prototype,"tool",void 0),d([c()],$.prototype,"updating",null),d([c({readOnly:!0})],$.prototype,"results",null),d([c({readOnly:!0})],$.prototype,"computations",void 0),d([c()],$.prototype,"selectedDimension",void 0),d([c()],$.prototype,"selectedComputation",null),d([c()],$.prototype,"_analysisVisualization",void 0),d([c()],$.prototype,"_analysisController",void 0),d([c()],$.prototype,"_dimensionsToComputations",void 0),d([c()],$.prototype,"_placementTask",void 0),$=d([F("esri.views.3d.analysis.DimensionAnalysisView3D")],$);const ks=$;export{ks as default};
