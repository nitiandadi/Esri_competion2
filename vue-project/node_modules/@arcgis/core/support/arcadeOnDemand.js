/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../core/Error.js";import r from"../core/Logger.js";import{isSome as t}from"../core/maybe.js";import a from"../geometry/SpatialReference.js";const s=r.getLogger("esri.support.arcadeOnDemand");let c;function i(){return c||(c=(async()=>{const e=await import("./arcadeUtils.js");return{arcade:e.arcade,arcadeUtils:e,Dictionary:e.Dictionary,Feature:e.arcadeFeature}})()),c}const n=(e,r,t)=>u.create(e,r,t,null,["$feature"]),o=(e,r,t)=>u.create(e,r,t,null,["$feature","$view"]),l=o,p=(e,r,t,a)=>u.create(e,r,t,a,["$feature","$view"]);class u{constructor(e,r,t,a,s,c,i){this.script=e,this.evaluate=a;const n=Array.isArray(c)?c:c.fields;this.fields=n,this._syntaxTree=t,this._arcade=r,this._arcadeFeature=s,this._spatialReference=i,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(r,c,n,o,l,p){const{arcade:m,Feature:f,Dictionary:d}=await i(),y=a.fromJSON(c);let h;try{h=m.parseScript(r,p)}catch(A){return s.error(new e("arcade-bad-expression","Failed to parse arcade script",{script:r,error:A})),null}const w=l.reduce(((e,r)=>({...e,[r]:null})),{});let g=null;t(o)&&(g=new d(o),g.immutable=!0,w.$config=null);const _=m.scriptUsesGeometryEngine(h),F=_&&m.enableGeometrySupport(),S=m.scriptUsesFeatureSet(h)&&m.enableFeatureSetSupport(),$=m.scriptIsAsync(h),b=$&&m.enableAsyncSupport(),v={vars:w,spatialReference:y,useAsync:!!b};await Promise.all([F,S,b]);const j=new Set;await m.loadDependentModules(j,h,null,$,_);const G=new d;G.immutable=!1,G.setField("scale",0);const R=m.compileScript(h,v),x=e=>("$view"in e&&e.$view&&(G.setField("scale","object"==typeof e.$view?e.$view.scale:void 0),e.$view=G),g&&(e.$config=g),R({vars:e,spatialReference:y}));return new u(r,m,h,x,new f,n,y)}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}}export{u as ArcadeExpression,p as createDictionaryExpression,n as createLabelExpression,o as createRendererExpression,l as createVVExpression,i as loadArcade};
