/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import has from"../../core/has.js";import{isSome as t}from"../../core/maybe.js";import{parse as s,isHostedAgolService as e}from"./arcgisLayerUrl.js";const r={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"};function p(t,s,e){return!!(t&&t.hasOwnProperty(s)?t[s]:e)}function o(t,s,e){return t&&t.hasOwnProperty(s)?t[s]:e}function u(t){const s=t?.supportedSpatialAggregationStatistics?.map((t=>t.toLowerCase()));return{envelope:!!s?.includes("envelopeaggregate"),centroid:!!s?.includes("centroidaggregate"),convexHull:!!s?.includes("convexhullaggregate")}}function a(t,s){const e=t?.supportedOperationsWithCacheHint?.map((t=>t.toLowerCase()));return!!e?.includes(s.toLowerCase())}function n(t,s){return{analytics:i(t),attachment:c(t),data:d(t),metadata:l(t),operations:y(t.capabilities,t,s),query:m(t,s),queryRelated:h(t),queryTopFeatures:g(t),editing:C(t)}}function i(t){return{supportsCacheHint:a(t.advancedQueryCapabilities,"queryAnalytics")}}function c(t){const s=t.attachmentProperties,e={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1,supportsCacheHint:a(t.advancedQueryCapabilities,"queryAttachments"),supportsResize:p(t,"supportsAttachmentsResizing",!1)};return s&&Array.isArray(s)&&s.forEach((t=>{const s=r[t.name];s&&(e[s]=!!t.isEnabled)})),e}function d(t){return{isVersioned:p(t,"isDataVersioned",!1),supportsAttachment:p(t,"hasAttachments",!1),supportsM:p(t,"hasM",!1),supportsZ:p(t,"hasZ",!1)}}function l(t){return{supportsAdvancedFieldProperties:p(t,"supportsFieldDescriptionProperty",!1)}}function y(e,r,o){const u=e?e.toLowerCase().split(",").map((t=>t.trim())):[],a=o?s(o):null,n=u.includes(t(a)&&"MapServer"===a.serverType?"data":"query"),i=u.includes("editing")&&!r.datesInUnknownTimezone;let c=i&&u.includes("create"),d=i&&u.includes("delete"),l=i&&u.includes("update");const y=u.includes("changetracking"),m=r.advancedQueryCapabilities;return i&&!(c||d||l)&&(c=d=l=!0),{supportsCalculate:p(r,"supportsCalculate",!1),supportsTruncate:p(r,"supportsTruncate",!1),supportsValidateSql:p(r,"supportsValidateSql",!1),supportsAdd:c,supportsDelete:d,supportsEditing:i,supportsChangeTracking:y,supportsQuery:n,supportsQueryAnalytics:p(m,"supportsQueryAnalytic",!1),supportsQueryAttachments:p(m,"supportsQueryAttachments",!1),supportsQueryTopFeatures:p(m,"supportsTopFeaturesQuery",!1),supportsResizeAttachments:p(r,"supportsAttachmentsResizing",!1),supportsSync:u.includes("sync"),supportsUpdate:l,supportsExceedsLimitStatistics:p(r,"supportsExceedsLimitStatistics",!1)}}function m(t,s){const r=t.advancedQueryCapabilities,n=t.ownershipBasedAccessControlForFeatures,i=t.archivingInfo,c=t.currentVersion,d=s?.includes("MapServer"),l=!d||c>=has("mapserver-pbf-version-support"),y=e(s),m=new Set((t.supportedQueryFormats??"").split(",").map((t=>t.toLowerCase().trim())));return{supportsStatistics:p(r,"supportsStatistics",t.supportsStatistics),supportsPercentileStatistics:p(r,"supportsPercentileStatistics",!1),supportsSpatialAggregationStatistics:p(r,"supportsSpatialAggregationStatistics",!1),supportedSpatialAggregationStatistics:u(r),supportsCentroid:p(r,"supportsReturningGeometryCentroid",!1),supportsDistance:p(r,"supportsQueryWithDistance",!1),supportsDistinct:p(r,"supportsDistinct",t.supportsAdvancedQueries),supportsExtent:p(r,"supportsReturningQueryExtent",!1),supportsGeometryProperties:p(r,"supportsReturningGeometryProperties",!1),supportsHavingClause:p(r,"supportsHavingClause",!1),supportsOrderBy:p(r,"supportsOrderBy",t.supportsAdvancedQueries),supportsPagination:p(r,"supportsPagination",!1),supportsQuantization:p(t,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:p(t,"supportsQuantizationEditMode",!1),supportsQueryGeometry:p(t,"supportsReturningQueryGeometry",!1),supportsResultType:p(r,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:p(r,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:p(r,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:p(t,"useStandardizedQueries",!1),supportsTopFeaturesQuery:p(r,"supportsTopFeaturesQuery",!1),supportsQueryByOthers:p(n,"allowOthersToQuery",!0),supportsHistoricMoment:p(i,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:l&&m.has("pbf"),supportsDisjointSpatialRelationship:p(r,"supportsDisjointSpatialRel",!1),supportsCacheHint:p(r,"supportsQueryWithCacheHint",!1)||a(r,"query"),supportsDefaultSpatialReference:p(r,"supportsDefaultSR",!1),supportsCompactGeometry:y,supportsFullTextSearch:p(r,"supportsFullTextSearch",!1),maxRecordCountFactor:o(t,"maxRecordCountFactor",void 0),maxRecordCount:o(t,"maxRecordCount",void 0),standardMaxRecordCount:o(t,"standardMaxRecordCount",void 0),tileMaxRecordCount:o(t,"tileMaxRecordCount",void 0)}}function h(t){const s=t.advancedQueryCapabilities,e=p(s,"supportsAdvancedQueryRelated",!1);return{supportsPagination:p(s,"supportsQueryRelatedPagination",!1),supportsCount:e,supportsOrderBy:e,supportsCacheHint:a(s,"queryRelated")}}function g(t){return{supportsCacheHint:a(t.advancedQueryCapabilities,"queryTopFilter")}}function C(t){const s=t.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:p(t,"allowGeometryUpdates",!0),supportsGlobalId:p(t,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:p(t,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:p(t,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:p(t,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:p(t,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:p(s,"allowAnonymousToDelete",!0),supportsDeleteByOthers:p(s,"allowOthersToDelete",!0),supportsUpdateByAnonymous:p(s,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:p(s,"allowOthersToUpdate",!0)}}export{n as getFeatureLayerCapabilities};
