/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import{id as t}from"../../kernel.js";import e from"../../core/Error.js";import{JSONMap as r}from"../../core/jsonMap.js";import{isSome as n}from"../../core/maybe.js";import{parseWhereClause as o}from"../../core/sql.js";import{getOwningPortalUrl as a}from"./layerUtils.js";import i from"../../rest/support/AttachmentQuery.js";import s from"../../rest/support/Query.js";import u from"../../rest/support/RelationshipQuery.js";const c=new r({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function p(t,r,n,o){const a=await E(t);if(await l(t,r,o),!a.addAttachment)throw new e(o,"Layer source does not support addAttachment capability");return a.addAttachment(r,n)}function l(t,r,n){const{attributes:o}=r,{objectIdField:a}=t;return t.get("capabilities.data.supportsAttachment")?r?o?a&&o[a]?Promise.resolve():Promise.reject(new e(n,`feature is missing the identifying attribute ${a}`)):Promise.reject(new e(n,"'attributes' are required on a feature to query attachments")):Promise.reject(new e(n,"A feature is required to add/delete/update attachments")):Promise.reject(new e(n,"this layer doesn't support attachments"))}async function y(t,r,n,o,a){const i=await E(t);if(await l(t,r,a),!i.updateAttachment)throw new e(a,"Layer source does not support updateAttachment capability");return i.updateAttachment(r,n,o)}async function d(t,e,r){const n=await import("../graphics/editingSupport.js"),o=await t.load();return n.applyEdits(o,o.source,e,r)}async function f(t,r,n,o){const a=await E(t);if(await l(t,r,o),!a.deleteAttachments)throw new e(o,"Layer source does not support deleteAttachments capability");return a.deleteAttachments(r,n)}async function m(t,r,n){const o=(await t.load({signal:r?.signal})).source;if(!o.fetchRecomputedExtents)throw new e(n,"Layer source does not support fetchUpdates capability");return o.fetchRecomputedExtents(r)}async function h(t,r,n,o){r=i.from(r),await t.load();const a=t.source,s=t.capabilities;if(!s?.data?.supportsAttachment)throw new e(o,"this layer doesn't support attachments");const{attachmentTypes:u,objectIds:c,globalIds:p,num:l,size:y,start:d,where:f}=r;if(!s?.operations?.supportsQueryAttachments){if(u?.length>0||p?.length>0||y?.length>0||l||d||f)throw new e(o,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",r)}if(!(c?.length||p?.length||f))throw new e(o,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",r);if(!a.queryAttachments)throw new e(o,"Layer source does not support queryAttachments capability",r);return a.queryAttachments(r)}async function w(t,r,n,o){const a=await E(t);if(!a.queryObjectIds)throw new e(o,"Layer source does not support queryObjectIds capability");return a.queryObjectIds(s.from(r)??t.createQuery(),n)}async function b(t,r,n,o){const a=await E(t);if(!a.queryFeatureCount)throw new e(o,"Layer source does not support queryFeatureCount capability");return a.queryFeatureCount(s.from(r)??t.createQuery(),n)}async function g(t,r,n,o){const a=await E(t);if(!a.queryExtent)throw new e(o,"Layer source does not support queryExtent capability");return a.queryExtent(s.from(r)??t.createQuery(),n)}async function q(t,r,n,o){const a=await E(t);if(!a.queryRelatedFeatures)throw new e(o,"Layer source does not support queryRelatedFeatures capability");return a.queryRelatedFeatures(u.from(r),n)}async function j(t,r,n,o){const a=await E(t);if(!a.queryRelatedFeaturesCount)throw new e(o,"Layer source does not support queryRelatedFeaturesCount capability");return a.queryRelatedFeaturesCount(u.from(r),n)}async function F(t){const e=t.source;if(e?.refresh)try{const{dataChanged:r,updates:o}=await e.refresh();if(n(o)&&(t.sourceJSON={...t.sourceJSON,...o},t.read(o,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(await o(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function I(t){const e=new s,r=t.get("capabilities.data"),n=t.get("capabilities.query");e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,n&&(e.compactGeometryEnabled=n.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=n.supportsDefaultSpatialReference),r&&(r.supportsZ&&null!=t.returnZ&&(e.returnZ=t.returnZ),r.supportsM&&null!=t.returnM&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:o,timeExtent:a}=t;return e.timeExtent=null!=o&&null!=a?a.offset(-o.value,o.unit):a||null,e.multipatchOption="multipatch"===t.geometryType?"xyFootprint":null,e}function P(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r)for(const n of r)if("esriFieldTypeGlobalID"===n.type)return n.name}function A(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r)for(const n of r)if("esriFieldTypeOID"===n.type)return n.name}function O(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}async function E(t){return(await t.load()).source}async function x(e,r){if(!t)return;if(t.findCredential(e))return;let o;try{const n=await a(e,r);n&&(o=await t.checkSignInStatus(`${n}/sharing`))}catch(i){}if(o)try{const o=n(r)?r.signal:null;await t.getCredential(e,{signal:o})}catch(i){}}async function R(t,e){const r=t.parsedUrl?.path;if(!r)return;const n=t.editFieldsInfo;(t.userHasUpdateItemPrivileges||t.userHasFullEditingPrivileges&&t.capabilities.operations.supportsEditing||n?.creatorField||n?.editorField)&&await x(r,e)}function C(t){return!t.sourceJSON?.isMultiServicesView&&(t.userHasUpdateItemPrivileges||t.editingEnabled)}export{p as addAttachment,d as applyEdits,C as computeEffectiveEditingEnabled,I as createQuery,f as deleteAttachments,R as ensureLayerCredential,m as fetchRecomputedExtents,c as geometryTypeKebabDict,F as hasDataChanged,h as queryAttachments,g as queryExtent,b as queryFeatureCount,w as queryObjectIds,q as queryRelatedFeatures,j as queryRelatedFeaturesCount,P as readGlobalIdField,A as readObjectIdField,O as readVersion,y as updateAttachment};
