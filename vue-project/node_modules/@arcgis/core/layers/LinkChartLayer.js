/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../geometry.js";import t from"../core/Collection.js";import a from"../core/Error.js";import i from"../core/Logger.js";import{throwIfAborted as n}from"../core/promiseUtils.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import"../core/accessorSupport/ensureType.js";import"../core/arrayUtils.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import{encodeGeohash as s}from"../geohash/geohashUtils.js";import h from"./Layer.js";import{convertFromGeometry as l}from"./graphics/featureConversionUtils.js";import c from"./graphics/OptimizedGeometry.js";import{KnowledgeGraphLayerDataManager as d,MOCK_OID_FIELD_NAME as p,MOCK_ORIGIN_ID_FIELD_NAME as u,MOCK_DESTINATION_ID_FIELD_NAME as y,MOCK_LAYOUT_GEOMETRY_FIELD_NAME as m,GEOHASH_ENCODING_PRECISION as f}from"./knowledgeGraph/KnowledgeGraphLayerDataManager.js";import g from"./knowledgeGraph/KnowledgeGraphSubLayer.js";import{BlendLayer as k}from"./mixins/BlendLayer.js";import{ScaleRangeLayer as C}from"./mixins/ScaleRangeLayer.js";import{LCSimpleLayout as b,LCSmartTreeLayout as L,LCRadialTreeLayout as M,LCHierarchicalLayout as w,LCCommunityLayout as x,LCForceDirectedLayout as E,NodeFlag as D,load as T}from"../libs/linkchartlayout/LinkChartLayout.js";import{fetchKnowledgeGraph as G}from"../rest/knowledgeGraphService.js";import A from"../rest/knowledgeGraph/EntityType.js";import I from"../rest/knowledgeGraph/RelationshipType.js";import v from"../geometry/Extent.js";import R from"../geometry/Point.js";import j from"../geometry/Polyline.js";let P=class extends(k(C(h))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.layers=new t,this.linkChartDiagramLookup=new Map,this.linkChartExtent=new v({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.sublayerIdsCache=new Map,this.tables=new t,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new a("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2]}const t=new Set,n=new Map;let o=[],r=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new a("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.inclusionModeDefinition?.generateAllSublayers?(o=e.knowledgeGraph.dataModel.entityTypes?e.knowledgeGraph.dataModel.entityTypes:[],r=e.knowledgeGraph.dataModel.relationshipTypes?e.knowledgeGraph.dataModel.relationshipTypes:[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?(e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&n.set(e.name,e)})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&n.set(e.name,e)})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((a,s)=>{if(!n.get(s))return i.getLogger(this.declaredClass).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);n.get(s)instanceof I||"strictOrigin"in n.get(s)?t.has(s)||(t.add(s),r.push(n.get(s))):n.get(s)instanceof A||"properties"in n.get(s)?t.has(s)||(t.add(s),o.push(n.get(s))):(i.getLogger(this.declaredClass).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))}))):(o=e.knowledgeGraph.dataModel.entityTypes?e.knowledgeGraph.dataModel.entityTypes:[],r=e.knowledgeGraph.dataModel.relationshipTypes?e.knowledgeGraph.dataModel.relationshipTypes:[]);const s=new d({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=o,this.memberRelationshipTypes=r,this.dataManager=s}load(e){return this.addResolvingPromise(new Promise((t=>{G(this.url).then((a=>{if(this._initializeLayerProperties({knowledgeGraph:a,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e=>{e.useAllData=!1,e.members?.forEach((e=>{let t;t=e.linkChartLocation instanceof c?e.linkChartLocation:e.linkChartLocation?l(e.linkChartLocation):null,this.linkChartDiagramLookup.set(e.id,t),t&&2===t.coords.length&&0===t.lengths.length?this.linkChartGeohashLookup.set(e.id,s(t.coords[1],t.coords[0],f)):this.linkChartGeohashLookup.set(e.id,"")})),this.addResolvingPromise(this._initializeDiagram().then((async()=>{this.layers.forEach((async e=>{await e.refreshCachedQueryEngine()})),this.tables.forEach((async e=>{await e.refreshCachedQueryEngine()}))})))}));else{const t="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!0,t).then((async()=>{n(e);const t=[],a=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1}))),await this._initializeDiagram(),this.layers.forEach((async e=>{a.push(e.refreshCachedQueryEngine()),t.push(new Promise((t=>{e.on("layerview-create",(async()=>{t(null)}))})))})),this.tables.forEach((async e=>{a.push(e.refreshCachedQueryEngine())})),await Promise.all(a),Promise.all(t).then((async()=>{this.dataManager.refreshCacheContent().then((async()=>{this.layers.forEach((e=>{e.refreshCachedQueryEngine()})),this.tables.forEach((e=>{e.refreshCachedQueryEngine()}))}))}))})))}t(null)}))}))),Promise.resolve(this)}loadLayerAssumingLocalCache(){this.memberEntityTypes.forEach((e=>{const t=new g({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberRelationshipTypes.forEach((e=>{const t=new g({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{e.members?.forEach((e=>{if(this.sublayerIdsCache.has(t)?this.sublayerIdsCache.get(t)?.push(e.id):this.sublayerIdsCache.set(t,[e.id]),e.linkChartLocation)if(e.linkChartLocation instanceof c)this.linkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,s(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],f)):this.linkChartGeohashLookup.set(e.id,"");else{const t=l(e.linkChartLocation);this.linkChartDiagramLookup.set(e.id,e.linkChartLocation?t:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,s(e.linkChartLocation.x,e.linkChartLocation.y,f)):this.linkChartGeohashLookup.set(e.id,"")}}))})),Array.from(this.sublayerIdsCache.values()).forEach((e=>e.sort()))}async calculateLinkChartLayout(e="RADIAL_TREE",t){const n=[],o=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{n.push({typeName:t,feature:e})})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{o.push({typeName:t,feature:e})}))})),this.linkChartDiagramLookup=new Map;const r=new Map,h=new Map,c=new Map,d=new Map,g=new Uint8Array(n.length),k=new Float64Array(n.length),C=new Float64Array(n.length),G=new Uint32Array(o.length),A=new Uint32Array(o.length),I=[],P=t?.geographicStrategy?t.geographicStrategy:"FORCE_DIRECTED",S=t?.xScaleFactor?t.xScaleFactor:1,N=t?.yScaleFactor?t.yScaleFactor:1,_=new v({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let F,z="FORCE_DIRECTED",O=0,U=0;switch(z="GEOGRAPHIC"===e?P:e,z){case"FORCE_DIRECTED":F=E.apply;break;case"COMMUNITY":F=x.apply;break;case"HIERARCHICAL":F=w.apply;break;case"RADIAL_TREE":F=M.apply;break;case"SMART_TREE":F=L.apply;break;default:F=b.apply}n.forEach((({typeName:a,feature:i})=>{if(t?.lockedNodeLocations?.has(i.attributes[p])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(a)?g[O]=D.IsGeographic:g[O]=D.None;const n=t.lockedNodeLocations.get(i.attributes[p]);k[O]=n.x,C[O]=n.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(a)){g[O]=D.IsGeographic;let e=null;const t=i.attributes[this.dataManager.geographicLookup.get(a).name],n=this.dataManager.geographicLookup.get(a)?.geometryType;switch(n){case"esriGeometryPoint":k[O]=t?.x,C[O]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,e?.x&&e?.y?(k[O]=e?.x,C[O]=e?.y):g[O]=D.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,e?.x&&e?.y?(k[O]=e?.x,C[O]=e?.y):g[O]=D.IsMovable;break;default:g[O]=D.IsMovable}k[O]||(k[O]=0),C[O]||(C[O]=0)}else g[O]=D.IsMovable,k[O]=0,C[O]=0;d.set(i.attributes[p],O),I[O]={feature:i,typeName:a},O++})),o.forEach((e=>{const t=d.get(e.feature.attributes[u]),a=d.get(e.feature.attributes[y]);void 0!==t&&void 0!==a?(G[U]=t,A[U]=a,U++):(i.getLogger(this.declaredClass).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members.  The diagram geometry will be set to null"),this.linkChartDiagramLookup.set(e.feature.attributes[u],null),this.linkChartGeohashLookup.set(e.feature.attributes[u],null))})),await T();if(!F(g,k,C,G,A))throw new a("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let a=0;a<I.length;a++){if(C[a]>80&&(C[a]=80),C[a]<-80&&(C[a]=-80),g[a]===D.IsMovable?I[a].feature.attributes[m]=new R(k[a]*S,C[a]*N):I[a].feature.attributes[m]=new R(k[a],C[a]),r.has(I[a].typeName)){r.get(I[a].typeName)?.set(I[a].feature.attributes[p],I[a].feature)}else{const e=new Map;e.set(I[a].feature.attributes[p],I[a].feature),r.set(I[a].typeName,e)}c.set(I[a].feature.attributes[p],I[a].feature);const e=l(I[a].feature.attributes[m]);this.linkChartDiagramLookup.set(I[a].feature.attributes[p],I[a].feature.attributes[m]?e:null),this.linkChartGeohashLookup.set(I[a].feature.attributes[p],s(I[a].feature.attributes[m].y,I[a].feature.attributes[m].x,f)),I[a].feature.attributes[m].x<_.xmin&&(_.xmin=I[a].feature.attributes[m].x),I[a].feature.attributes[m].x>_.xmax&&(_.xmax=I[a].feature.attributes[m].x),I[a].feature.attributes[m].y<_.ymin&&(_.ymin=I[a].feature.attributes[m].y),I[a].feature.attributes[m].y>_.ymax&&(_.ymax=I[a].feature.attributes[m].y)}return this.linkChartExtent.xmin=_.xmin,this.linkChartExtent.xmax=_.xmax,this.linkChartExtent.ymin=_.ymin,this.linkChartExtent.ymax=_.ymax,o.forEach((e=>{const t=I[d.get(e.feature.attributes[u])]?.feature.attributes[m],a=I[d.get(e.feature.attributes[y])]?.feature.attributes[m];if(!t||!a)return;const i=new j({paths:[[t.x,t.y],[a.x,a.y]]});if(e.feature.attributes[m]=i,h.has(e.typeName)){h.get(e.typeName)?.set(e.feature.attributes[p],e.feature)}else{const t=new Map;t.set(e.feature.attributes[p],e.feature),h.set(e.typeName,t)}c.set(e.feature.attributes[p],e.feature);const n=l(e.feature.attributes[m]);this.linkChartDiagramLookup.set(e.feature.attributes[p],e.feature.attributes[m]?n:null),this.linkChartGeohashLookup.set(e.feature.attributes[p],"")})),{nodes:r,links:h,idMap:c}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const a=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{a.push(e.refreshCachedQueryEngine())})),await Promise.all(a),this.layers.forEach((e=>{e.emit("refresh",{dataChanged:!0})}))}async synchronizeInclusionListWithCache(){return new Promise((e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const a=Array.from(this.dataManager.sublayerCaches.get(t).keys());Array.from(e.members.keys()).filter((e=>!a.includes(e))).forEach((t=>{e.members?.delete(t)}))}})),e()}))}async _initializeDiagram(){if(this.defaultLinkChartConfig)if(this.defaultLinkChartConfig.doNotRecalculateLayout)this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e=>{e?.members?.forEach((e=>{const t=e.linkChartLocation;let a;const i=e.id;if(!t)return;a="x"in t?{x:t.x,y:t.y}:{x:t.coords[0],y:t.coords[1]};const n=l(a);this.linkChartDiagramLookup.set(i,n),this.linkChartGeohashLookup.set(i,s(a.x,a.y,f)),this.linkChartExtent.xmin>a.x&&(this.linkChartExtent.xmin=a.x),this.linkChartExtent.xmax<a.x&&(this.linkChartExtent.xmax=a.x),this.linkChartExtent.ymin>a.y&&(this.linkChartExtent.ymin=a.y),this.linkChartExtent.ymax<a.y&&(this.linkChartExtent.ymax=a.y)}))})),this.memberRelationshipTypes.forEach((e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach((e=>{const t=this.linkChartDiagramLookup.get(e.attributes[u]),a=this.linkChartDiagramLookup.get(e.attributes[y]);if(t&&a){const i=l(new j({paths:[[t.coords[0],t.coords[1]],[a.coords[0],a.coords[1]]]}));this.linkChartDiagramLookup.set(e.attributes[p],i)}else this.linkChartDiagramLookup.set(e.attributes[p],null);this.linkChartGeohashLookup.set(e.attributes[p],"")}))}));else{const e=new Map;this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t=>{t?.members?.forEach((t=>{const a=t.linkChartLocation;let i;const n=t.id;a&&(i="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]},e.set(n,new R({x:i.x,y:i.y})))}))})),await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{xScaleFactor:this.defaultLinkChartConfig.xScaleFactor,yScaleFactor:this.defaultLinkChartConfig.yScaleFactor,lockedNodeLocations:e})}else await this.calculateLinkChartLayout()}};e([o()],P.prototype,"dataPreloadedInLocalCache",void 0),e([o()],P.prototype,"defaultLinkChartConfig",void 0),e([o()],P.prototype,"dataManager",void 0),e([o()],P.prototype,"knowledgeGraph",void 0),e([o()],P.prototype,"layers",void 0),e([o()],P.prototype,"linkChartDiagramLookup",void 0),e([o()],P.prototype,"linkChartExtent",void 0),e([o()],P.prototype,"linkChartGeohashLookup",void 0),e([o()],P.prototype,"memberEntityTypes",void 0),e([o()],P.prototype,"memberRelationshipTypes",void 0),e([o()],P.prototype,"sublayerIdsCache",void 0),e([o()],P.prototype,"tables",void 0),e([o({json:{read:!1}})],P.prototype,"type",void 0),P=e([r("esri.layers.LinkChartLayer")],P);const S=P;export{S as default};
