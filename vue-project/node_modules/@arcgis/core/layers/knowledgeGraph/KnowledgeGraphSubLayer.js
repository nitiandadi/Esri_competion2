/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../geometry.js";import t from"../../PopupTemplate.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import{fromJSON as r}from"../../renderers/support/jsonUtils.js";import{rendererTypes as o}from"../../renderers/support/types.js";import{unwrap as s}from"../../core/maybe.js";import"../../core/workers/workers.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import"../../core/arrayUtils.js";import{subclass as a}from"../../core/accessorSupport/decorators/subclass.js";import{initializeProjection as p,project as n}from"../../geometry/projection.js";import{WGS84 as l}from"../../geometry/support/spatialReferenceUtils.js";import y from"../Layer.js";import m from"../graphics/data/FeatureStore.js";import{QueryEngine as u}from"../graphics/data/QueryEngine.js";import{createCapabilities as d,createDrawingInfo as h}from"../graphics/sources/support/clientSideDefaults.js";import{MOCK_OID_FIELD_NAME as c,MOCK_LAYOUT_GEOMETRY_FIELD_NAME as g}from"./KnowledgeGraphLayerDataManager.js";import{KnowledgeGraphSubLayerBase as f}from"./KnowledgeGraphSubLayerBase.js";import{BlendLayer as j}from"../mixins/BlendLayer.js";import{FeatureReductionLayer as b}from"../mixins/FeatureReductionLayer.js";import{RefreshableLayer as T}from"../mixins/RefreshableLayer.js";import{ScaleRangeLayer as w}from"../mixins/ScaleRangeLayer.js";import S from"../support/Field.js";import{fixRendererFields as F}from"../support/fieldUtils.js";import Q from"../../rest/support/FeatureSet.js";import x from"../../rest/support/Query.js";import{createPopupTemplate as O}from"../../support/popupUtils.js";import L from"../../core/workers/RemoteClient.js";import N from"../../geometry/Extent.js";import v from"../../geometry/Polygon.js";import E from"../../geometry/Polyline.js";import{featureGeometryTypeKebabDictionary as M}from"../../geometry/support/typeUtils.js";let C=class extends(b(f(j(w(T(y)))))){constructor(e){if(super(e),this.capabilities=d(!1,!1),this.displayField="",this.geometryFieldName=null,this.hasM=!1,this.hasZ=!1,this.objectIdField=c,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new L(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const r=x.fromJSON(e);return this.queryFeaturesJSON(r,t)}}},(()=>null)),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=g;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name?t.name:null,this.geometryType=t?.geometryType?M.fromJSON(t.geometryType):null,t?.name&&e.objectType.properties&&e.objectType.properties[t.name]?(this.hasM=e.objectType.properties[t.name].hasM,this.hasZ=e.objectType.properties[t.name].hasZ):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=null,r=e.fieldType;"esriFieldTypeOID"===r&&(r="esriFieldTypeInteger"),this.fields.push(S.fromJSON({name:e.name,type:r,alias:e.alias,defaultValue:t,editable:e.editable,nullable:e.nullable}))})),this.fields.push(S.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=r(h(M.toJSON("polyline")).renderer):this.renderer=r(h(M.toJSON("point")).renderer):this.renderer=r(h(M.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){F(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return O(this,e)}createQuery(){return new x({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];throw new Error("Field not found")}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e),s=Q.fromJSON(await o.executeQuery(r.toJSON(),t?.signal));return s.features.forEach((e=>{e.sourceLayer=this})),s}async queryFeaturesJSON(e,t){const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e);return await o.executeQuery(r.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e);return o.executeQueryForCount(r.toJSON(),t?.signal)}async queryExtent(e={},t){const r={...e,returnGeometry:!0},{resolvedQuery:o,queryEngine:s}=await this._setupQueryObjects(r),i=await s.executeQueryForExtent(o.toJSON(),t?.signal);let a;return a=null!=i.extent?.xmin&&null!=i.extent?.xmax&&null!=i.extent?.ymin&&null!=i.extent?.ymax?new N(i.extent):new N,{count:i.count,extent:a}}async queryObjectIds(e,t){const r=x.from(e);let o;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)o=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(r,this,t);o=this.loadQueryEngine(e)}return o.executeQueryForIds(r.toJSON(),t?.signal)}loadQueryEngine(e){const t=new m({geometryType:M.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new u({fields:this.fields.map((e=>e.toJSON())),geometryType:M.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return r.featureStore.addMany(e),r}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new x({where:"1=1",outFields:[c]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const r=x.from(e),o=s(r.geometry);let i;if(o&&!o.spatialReference?.isWGS84&&(await p(o.spatialReference,l),r.geometry=n(o instanceof v||o instanceof E?o:o.extent,l)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(r,this,t);i=this.loadQueryEngine(e)}return{resolvedQuery:r,queryEngine:i}}};e([i()],C.prototype,"capabilities",void 0),e([i({readOnly:!0})],C.prototype,"defaultPopupTemplate",null),e([i()],C.prototype,"definitionExpression",void 0),e([i()],C.prototype,"displayField",void 0),e([i()],C.prototype,"elevationInfo",void 0),e([i()],C.prototype,"geometryType",void 0),e([i()],C.prototype,"geometryFieldName",void 0),e([i()],C.prototype,"graphType",void 0),e([i()],C.prototype,"hasM",void 0),e([i()],C.prototype,"hasZ",void 0),e([i()],C.prototype,"labelsVisible",void 0),e([i()],C.prototype,"labelingInfo",void 0),e([i()],C.prototype,"objectIdField",void 0),e([i()],C.prototype,"objectType",void 0),e([i()],C.prototype,"parentCompositeLayer",void 0),e([i({type:t,json:{name:"popupInfo",write:!0}})],C.prototype,"popupTemplate",void 0),e([i({types:o,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],C.prototype,"renderer",null),e([i()],C.prototype,"source",void 0),e([i({json:{read:!1}})],C.prototype,"type",void 0),C=e([a("esri.layers.knowledgeGraph.KnowledgeGraphSubLayer")],C);const R=C;export{R as default};
