/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import{version as n}from"../../kernel.js";import{cloneGeometry as t,convertSquareUnitsToCode as e,convertLinearUnitsToCode as r}from"../kernel.js";import{G as i,y as a,k as o,j as s,m as l,x as u,q as c,T as f,A as d,J as m,H as w,K as h,g as y,h as p,C as g}from"../../chunks/languageUtils.js";import{centroidPolyline as v,centroidMultiPoint as P,getMetersPerVerticalUnitForSR as I,segmentLength3d as A}from"./centroid.js";import F from"../../geometry/Extent.js";import R from"../../geometry/Geometry.js";import{disjoint as x,intersects as N,touches as j,crosses as b,within as S,contains as O,overlaps as k,equals as C,relate as J,intersect as M,union as Z,difference as D,symmetricDifference as U,clip as z,cut as E,planarArea as L,geodesicArea as T,planarLength as q,geodesicLength as W,distance as G,densify as H,geodesicDensify as K,generalize as V,buffer as B,geodesicBuffer as Q,offset as X,rotate as Y,simplify as $,isSimple as _,convexHull as nn}from"../../geometry/geometryEngineAsync.js";import tn from"../../geometry/Multipoint.js";import en from"../../geometry/Point.js";import rn from"../../geometry/Polygon.js";import an from"../../geometry/Polyline.js";import{fromJSON as on}from"../../geometry/support/jsonUtils.js";import{ArcadeExecutionError as sn,ExecutionErrorCodes as ln}from"../executionError.js";import un from"../Dictionary.js";import cn from"../ArcadePortal.js";import{getPortal as fn,lookupUser as dn}from"../portalUtils.js";import{getMetersPerUnitForSR as mn}from"../../core/unitUtils.js";function wn(t){return 0===n.indexOf("4.")?rn.fromExtent(t):new rn({spatialReference:t.spatialReference,rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]})}function hn(n,t,e){if(a(n,2,2,t,e),n[0]instanceof R&&n[1]instanceof R);else if(n[0]instanceof R&&null===n[1]);else if(n[1]instanceof R&&null===n[0]);else if(null!==n[0]||null!==n[1])throw new sn(t,ln.InvalidParameter,e)}async function yn(n,t){if("polygon"!==n.type&&"polyline"!==n.type&&"extent"!==n.type)return 0;let e=1;if(n.spatialReference.vcsWkid||n.spatialReference.latestVcsWkid){e=I(n.spatialReference)/mn(n.spatialReference)}let r=0;if("polyline"===n.type)for(const a of n.paths)for(let n=1;n<a.length;n++)r+=A(a[n],a[n-1],e);else if("polygon"===n.type)for(const a of n.rings){for(let n=1;n<a.length;n++)r+=A(a[n],a[n-1],e);(a[0][0]!==a[a.length-1][0]||a[0][1]!==a[a.length-1][1]||void 0!==a[0][2]&&a[0][2]!==a[a.length-1][2])&&(r+=A(a[0],a[a.length-1],e))}else"extent"===n.type&&(r+=2*A([n.xmin,n.ymin,0],[n.xmax,n.ymin,0],e),r+=2*A([n.xmin,n.ymin,0],[n.xmin,n.ymax,0],e),r*=2,r+=4*Math.abs(d(n.zmax,0)*e-d(n.zmin,0)*e));const i=new an({hasZ:!1,hasM:!1,spatialReference:n.spatialReference,paths:[[0,0],[0,r]]});return q(i,t)}function pn(n){"async"===n.mode&&(n.functions.disjoint=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(hn(a=i(a),t,e),null===a[0]||null===a[1]||x(a[0],a[1]))))},n.functions.intersects=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(hn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&N(a[0],a[1]))))},n.functions.touches=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(hn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&j(a[0],a[1]))))},n.functions.crosses=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(hn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&b(a[0],a[1]))))},n.functions.within=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(hn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&S(a[0],a[1]))))},n.functions.contains=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(hn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&O(a[0],a[1]))))},n.functions.overlaps=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(hn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&k(a[0],a[1]))))},n.functions.equals=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(a(i,2,2,t,e),i[0]===i[1]||(i[0]instanceof R&&i[1]instanceof R?C(i[0],i[1]):!(!o(i[0])||!o(i[1]))&&i[0].equals(i[1])))))},n.functions.relate=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{if(o=i(o),a(o,3,3,t,e),o[0]instanceof R&&o[1]instanceof R)return J(o[0],o[1],s(o[2]));if(o[0]instanceof R&&null===o[1])return!1;if(o[1]instanceof R&&null===o[0])return!1;if(null===o[0]&&null===o[1])return!1;throw new sn(t,ln.InvalidParameter,e)}))},n.functions.intersection=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(hn(a=i(a),t,e),null===a[0]||null===a[1]?null:M(a[0],a[1]))))},n.functions.union=function(e,r){return n.standardFunctionAsync(e,r,((n,a,o)=>{const s=[];if(0===(o=i(o)).length)throw new sn(e,ln.WrongNumberOfParameters,r);if(1===o.length)if(l(o[0])){const n=i(o[0]);for(let t=0;t<n.length;t++)if(null!==n[t]){if(!(n[t]instanceof R))throw new sn(e,ln.InvalidParameter,r);s.push(n[t])}}else{if(!u(o[0])){if(o[0]instanceof R)return c(t(o[0]),e.spatialReference);if(null===o[0])return null;throw new sn(e,ln.InvalidParameter,r)}{const n=i(o[0].toArray());for(let t=0;t<n.length;t++)if(null!==n[t]){if(!(n[t]instanceof R))throw new sn(e,ln.InvalidParameter,r);s.push(n[t])}}}else for(let t=0;t<o.length;t++)if(null!==o[t]){if(!(o[t]instanceof R))throw new sn(e,ln.InvalidParameter,r);s.push(o[t])}return 0===s.length?null:Z(s)}))},n.functions.difference=function(e,r){return n.standardFunctionAsync(e,r,((n,a,o)=>(hn(o=i(o),e,r),null!==o[0]&&null===o[1]?t(o[0]):null===o[0]?null:D(o[0],o[1]))))},n.functions.symmetricdifference=function(e,r){return n.standardFunctionAsync(e,r,((n,a,o)=>(hn(o=i(o),e,r),null===o[0]&&null===o[1]?null:null===o[0]?t(o[1]):null===o[1]?t(o[0]):U(o[0],o[1]))))},n.functions.clip=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{if(o=i(o),a(o,2,2,t,e),!(o[1]instanceof F)&&null!==o[1])throw new sn(t,ln.InvalidParameter,e);if(null===o[0])return null;if(!(o[0]instanceof R))throw new sn(t,ln.InvalidParameter,e);return null===o[1]?null:z(o[0],o[1])}))},n.functions.cut=function(e,r){return n.standardFunctionAsync(e,r,((n,o,s)=>{if(s=i(s),a(s,2,2,e,r),!(s[1]instanceof an)&&null!==s[1])throw new sn(e,ln.InvalidParameter,r);if(null===s[0])return[];if(!(s[0]instanceof R))throw new sn(e,ln.InvalidParameter,r);return null===s[1]?[t(s[0])]:E(s[0],s[1])}))},n.functions.area=function(t,r){return n.standardFunctionAsync(t,r,(async(n,o,s)=>{if(a(s,1,2,t,r),null===(s=i(s))[0])return 0;if(f(s[0])){const n=await s[0].sumArea(e(d(s[1],-1)),!1,t.abortSignal);if(t.abortSignal.aborted)throw new sn(t,ln.Cancelled,r);return n}if(l(s[0])||u(s[0])){const n=m(s[0],t.spatialReference);return null===n?0:L(n,e(d(s[1],-1)))}if(!(s[0]instanceof R))throw new sn(t,ln.InvalidParameter,r);return L(s[0],e(d(s[1],-1)))}))},n.functions.areageodetic=function(t,r){return n.standardFunctionAsync(t,r,(async(n,o,s)=>{if(a(s,1,2,t,r),null===(s=i(s))[0])return 0;if(f(s[0])){const n=await s[0].sumArea(e(d(s[1],-1)),!0,t.abortSignal);if(t.abortSignal.aborted)throw new sn(t,ln.Cancelled,r);return n}if(l(s[0])||u(s[0])){const n=m(s[0],t.spatialReference);return null===n?0:T(n,e(d(s[1],-1)))}if(!(s[0]instanceof R))throw new sn(t,ln.InvalidParameter,r);return T(s[0],e(d(s[1],-1)))}))},n.functions.length=function(t,e){return n.standardFunctionAsync(t,e,(async(n,o,s)=>{if(a(s,1,2,t,e),null===(s=i(s))[0])return 0;if(f(s[0])){const n=await s[0].sumLength(r(d(s[1],-1)),!1,t.abortSignal);if(t.abortSignal.aborted)throw new sn(t,ln.Cancelled,e);return n}if(l(s[0])||u(s[0])){const n=w(s[0],t.spatialReference);return null===n?0:q(n,r(d(s[1],-1)))}if(!(s[0]instanceof R))throw new sn(t,ln.InvalidParameter,e);return q(s[0],r(d(s[1],-1)))}))},n.functions.length3d=function(t,e){return n.standardFunctionAsync(t,e,((n,o,s)=>{if(a(s,1,2,t,e),null===(s=i(s))[0])return 0;if(l(s[0])||u(s[0])){const n=w(s[0],t.spatialReference);return null===n?0:!0===n.hasZ?yn(n,r(d(s[1],-1))):q(n,r(d(s[1],-1)))}if(!(s[0]instanceof R))throw new sn(t,ln.InvalidParameter,e);return!0===s[0].hasZ?yn(s[0],r(d(s[1],-1))):q(s[0],r(d(s[1],-1)))}))},n.functions.lengthgeodetic=function(t,e){return n.standardFunctionAsync(t,e,(async(n,o,s)=>{if(a(s,1,2,t,e),null===(s=i(s))[0])return 0;if(f(s[0])){const n=await s[0].sumLength(r(d(s[1],-1)),!0,t.abortSignal);if(t.abortSignal.aborted)throw new sn(t,ln.Cancelled,e);return n}if(l(s[0])||u(s[0])){const n=w(s[0],t.spatialReference);return null===n?0:W(n,r(d(s[1],-1)))}if(!(s[0]instanceof R))throw new sn(t,ln.InvalidParameter,e);return W(s[0],r(d(s[1],-1)))}))},n.functions.distance=function(t,e){return n.standardFunctionAsync(t,e,((n,o,s)=>{s=i(s),a(s,2,3,t,e);let c=s[0];(l(s[0])||u(s[0]))&&(c=h(s[0],t.spatialReference));let f=s[1];if((l(s[1])||u(s[1]))&&(f=h(s[1],t.spatialReference)),!(c instanceof R))throw new sn(t,ln.InvalidParameter,e);if(!(f instanceof R))throw new sn(t,ln.InvalidParameter,e);return G(c,f,r(d(s[2],-1)))}))},n.functions.distancegeodetic=function(t,e){return n.standardFunctionAsync(t,e,((n,o,s)=>{s=i(s),a(s,2,3,t,e);const l=s[0],u=s[1];if(!(l instanceof en))throw new sn(t,ln.InvalidParameter,e);if(!(u instanceof en))throw new sn(t,ln.InvalidParameter,e);const c=new an({paths:[],spatialReference:l.spatialReference});return c.addPath([l,u]),W(c,r(d(s[2],-1)))}))},n.functions.densify=function(t,e){return n.standardFunctionAsync(t,e,((n,o,s)=>{if(s=i(s),a(s,2,3,t,e),null===s[0])return null;if(!(s[0]instanceof R))throw new sn(t,ln.InvalidParameter,e);const l=y(s[1]);if(isNaN(l))throw new sn(t,ln.InvalidParameter,e);if(l<=0)throw new sn(t,ln.InvalidParameter,e);return s[0]instanceof rn||s[0]instanceof an?H(s[0],l,r(d(s[2],-1))):s[0]instanceof F?H(wn(s[0]),l,r(d(s[2],-1))):s[0]}))},n.functions.densifygeodetic=function(t,e){return n.standardFunctionAsync(t,e,((n,o,s)=>{if(s=i(s),a(s,2,3,t,e),null===s[0])return null;if(!(s[0]instanceof R))throw new sn(t,ln.InvalidParameter,e);const l=y(s[1]);if(isNaN(l))throw new sn(t,ln.InvalidParameter,e);if(l<=0)throw new sn(t,ln.InvalidParameter,e);return s[0]instanceof rn||s[0]instanceof an?K(s[0],l,r(d(s[2],-1))):s[0]instanceof F?K(wn(s[0]),l,r(d(s[2],-1))):s[0]}))},n.functions.generalize=function(t,e){return n.standardFunctionAsync(t,e,((n,o,s)=>{if(s=i(s),a(s,2,4,t,e),null===s[0])return null;if(!(s[0]instanceof R))throw new sn(t,ln.InvalidParameter,e);const l=y(s[1]);if(isNaN(l))throw new sn(t,ln.InvalidParameter,e);return V(s[0],l,p(d(s[2],!0)),r(d(s[3],-1)))}))},n.functions.buffer=function(e,o){return n.standardFunctionAsync(e,o,((n,s,l)=>{if(l=i(l),a(l,2,3,e,o),null===l[0])return null;if(!(l[0]instanceof R))throw new sn(e,ln.InvalidParameter,o);const u=y(l[1]);if(isNaN(u))throw new sn(e,ln.InvalidParameter,o);return 0===u?t(l[0]):B(l[0],u,r(d(l[2],-1)))}))},n.functions.buffergeodetic=function(e,o){return n.standardFunctionAsync(e,o,((n,s,l)=>{if(l=i(l),a(l,2,3,e,o),null===l[0])return null;if(!(l[0]instanceof R))throw new sn(e,ln.InvalidParameter,o);const u=y(l[1]);if(isNaN(u))throw new sn(e,ln.InvalidParameter,o);return 0===u?t(l[0]):Q(l[0],u,r(d(l[2],-1)))}))},n.functions.offset=function(t,e){return n.standardFunctionAsync(t,e,((n,o,l)=>{if(l=i(l),a(l,2,6,t,e),null===l[0])return null;if(!(l[0]instanceof rn||l[0]instanceof an))throw new sn(t,ln.InvalidParameter,e);const u=y(l[1]);if(isNaN(u))throw new sn(t,ln.InvalidParameter,e);const c=y(d(l[4],10));if(isNaN(c))throw new sn(t,ln.InvalidParameter,e);const f=y(d(l[5],0));if(isNaN(f))throw new sn(t,ln.InvalidParameter,e);return X(l[0],u,r(d(l[2],-1)),s(d(l[3],"round")).toLowerCase(),c,f)}))},n.functions.rotate=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{o=i(o),a(o,2,3,t,e);let s=o[0];if(null===s)return null;if(!(s instanceof R))throw new sn(t,ln.InvalidParameter,e);s instanceof F&&(s=rn.fromExtent(s));const l=y(o[1]);if(isNaN(l))throw new sn(t,ln.InvalidParameter,e);const u=d(o[2],null);if(null===u)return Y(s,l);if(u instanceof en)return Y(s,l,u);throw new sn(t,ln.InvalidParameter,e)}))},n.functions.centroid=function(e,r){return n.standardFunctionAsync(e,r,((n,o,s)=>{if(s=i(s),a(s,1,1,e,r),null===s[0])return null;let f=s[0];if((l(s[0])||u(s[0]))&&(f=h(s[0],e.spatialReference)),null===f)return null;if(!(f instanceof R))throw new sn(e,ln.InvalidParameter,r);return f instanceof en?c(t(s[0]),e.spatialReference):f instanceof rn?f.centroid:f instanceof an?v(f):f instanceof tn?P(f):f instanceof F?f.center:null}))},n.functions.multiparttosinglepart=function(e,r){return n.standardFunctionAsync(e,r,(async(n,o,s)=>{s=i(s),a(s,1,1,e,r);const l=[];if(null===s[0])return null;if(!(s[0]instanceof R))throw new sn(e,ln.InvalidParameter,r);if(s[0]instanceof en)return[c(t(s[0]),e.spatialReference)];if(s[0]instanceof F)return[c(t(s[0]),e.spatialReference)];const u=await $(s[0]);if(u instanceof rn){const n=[],t=[];for(let e=0;e<u.rings.length;e++)if(u.isClockwise(u.rings[e])){const t=on({rings:[u.rings[e]],hasZ:!0===u.hasZ,hazM:!0===u.hasM,spatialReference:u.spatialReference.toJSON()});n.push(t)}else t.push({ring:u.rings[e],pt:u.getPoint(e,0)});for(let e=0;e<t.length;e++)for(let r=0;r<n.length;r++)if(n[r].contains(t[e].pt)){n[r].addRing(t[e].ring);break}return n}if(u instanceof an){const n=[];for(let t=0;t<u.paths.length;t++){const e=on({paths:[u.paths[t]],hasZ:!0===u.hasZ,hazM:!0===u.hasM,spatialReference:u.spatialReference.toJSON()});n.push(e)}return n}if(s[0]instanceof tn){const n=c(t(s[0]),e.spatialReference);for(let t=0;t<n.points.length;t++)l.push(n.getPoint(t));return l}return null}))},n.functions.issimple=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{if(o=i(o),a(o,1,1,t,e),null===o[0])return!0;if(!(o[0]instanceof R))throw new sn(t,ln.InvalidParameter,e);return _(o[0])}))},n.functions.simplify=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{if(o=i(o),a(o,1,1,t,e),null===o[0])return null;if(!(o[0]instanceof R))throw new sn(t,ln.InvalidParameter,e);return $(o[0])}))},n.functions.convexhull=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{if(o=i(o),a(o,1,1,t,e),null===o[0])return null;if(!(o[0]instanceof R))throw new sn(t,ln.InvalidParameter,e);return nn(o[0])}))},n.functions.getuser=function(t,e){return n.standardFunctionAsync(t,e,(async(n,r,i)=>{a(i,0,2,t,e);let o=d(i[1],""),l=!0===o;if(o=!0===o||!1===o?"":s(o),0===i.length||i[0]instanceof cn){let n=null;t.services&&t.services.portal&&(n=t.services.portal),i.length>0&&(n=fn(i[0],n));const e=await dn(n,o,l);if(e){const n=JSON.parse(JSON.stringify(e));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return un.convertObjectToArcadeDictionary(n,g(t))}return null}let u=null;if(f(i[0])&&(u=i[0]),u){if(l=!1,o)return null;await u.load();const n=await u.getOwningSystemUrl();if(!n){if(!o){const n=await u.getIdentityUser();return n?un.convertObjectToArcadeDictionary({username:n},g(t)):null}return null}let e=null;t.services&&t.services.portal&&(e=t.services.portal),e=fn(new cn(n),e);const r=await dn(e,o,l);if(r){const n=JSON.parse(JSON.stringify(r));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return un.convertObjectToArcadeDictionary(n,g(t))}return null}throw new sn(t,ln.InvalidParameter,e)}))})}export{pn as registerFunctions};
