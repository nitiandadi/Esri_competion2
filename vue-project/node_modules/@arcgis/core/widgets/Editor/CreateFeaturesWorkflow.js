/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{remove as t}from"../../core/arrayUtils.js";import{makeHandle as a,handlesGroup as i}from"../../core/handleUtils.js";import{unwrap as r,removeMaybe as o,isSome as s,isNone as n,destroyMaybe as l}from"../../core/maybe.js";import{whenOnce as c,watch as d,syncAndInitial as u}from"../../core/reactiveUtils.js";import{generateUUID as h}from"../../core/uuid.js";import{property as p}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import{subclass as f}from"../../core/accessorSupport/decorators/subclass.js";import{getEffectiveLayerCapabilities as m,getEffectiveEditingEnabled as w}from"../../layers/support/layerUtils.js";import{getDrawHelpMessage as g}from"../../views/draw/support/helpMessageUtils.js";import v from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{CreateFeaturesWorkflowData as y}from"./CreateFeaturesWorkflowData.js";import M from"./Workflow.js";import{shouldShowAttachmentsForCreateWorkflow as _,startCreatingNewFeature as A,findLayerInfo as b,updateGraphicSymbolWhenRequired as F,isTerminalUpdateEventType as V,getVisualVariableAttributes as I,startUpdatingFeature as k,createWorkflowSteps as S,avoidFeatureTemplateSelectionWithOnlyOneItem as j,prepareAttachmentsForCreateWorkflow as C,visualVariableInteractiveUpdate as E}from"./workflowUtils.js";var G;const O=Symbol();let U=G=class extends M{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[]}get numPendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics.length}get pendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics}get reliesOnOwnerAdminPrivileges(){const{layer:e}=this.data.creationInfo,t=e.capabilities?.operations.supportsAdd,a=m(e)?.operations.supportsAdd;return w(e)&&!e.editingEnabled||!!a&&!t}get shouldShowAttachments(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&_(this.data)}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get helpMessage(){if("creating-features"!==this.stepId)return;const{creationInfo:e,viewModel:t}=this.data;return g(e.layer.geometryType,t.sketchViewModel.createGraphic?.geometry)}async updatePendingFeature(e,a){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),t(this._lastActiveGraphics,e),this._startUpdating(e,a)}static create(e,t,a,i,o){const s=new G({data:new y({creationInfo:r(t),viewModel:e}),onCommit:async e=>{const t=e.viewModel.sketchViewModel.layer.graphics.toArray(),a=e.creationInfo.layer,r=a.capabilities.editing.supportsGlobalId&&"globalIdField"in a,n=s._attachmentFileInfos;if(0===n.size)return void await i(a,{addFeatures:t});if(r){const e=s._getAttachmentEditsWithGlobalIds(t,a,n),r="addAttachments"in e?{globalIdUsed:!0}:void 0;return void await i(a,e,r)}const{addFeatureResults:l}=await i(a,{addFeatures:t}),c=s._getAddAttachmentsData(t,l,a,n);await o(a,c)}});return s._set("steps",this._createWorkflowSteps(s,a)),s}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",a((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,a((()=>e.opacity=t))}_highlight(e){const t=this.data.viewModel.view;"3d"===t?.type&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){o(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){return this.createFeatureState="create-new",A(this.data.viewModel.sketchViewModel,this.data.creationInfo,e)}async _startUpdating(e,t){const{featureFormViewModel:a,layerInfos:r,sketchViewModel:n,view:l}=this.data.viewModel;if(!l)return;const c=this.data.creationInfo.layer,d=b(r,c)?.formTemplate,u=l.spatialReference;return a.set({arcadeEditType:"INSERT",feature:e,formTemplate:d,spatialReference:u,view:l}),o(this._featureFormHandle),this._featureFormHandle=i([a.on("value-change",(async()=>{e.attributes=a.getValues(),await F(e,t)})),n.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&s(e.toolEventInfo)&&V(e.toolEventInfo.type))&&a.notifyFeatureGeometryChanged()}))]),this._removeHighlight(e),this.createFeatureState="update-pending",this._visualVariableAttributes=I(e),k(n,e,c,this._visualVariableAttributes,t)}static _createWorkflowSteps(e,i="awaiting-feature-creation-info"){const{data:r,handles:h}=e;let p=null,f=!0;const m=new Map,w=S(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],i,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){r.creationInfo=null,h.add(r.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{e&&(r.creationInfo=e,r.viewModel.activeWorkflow?.next())})),this.id)},async tearDown(){h.remove(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){if(h.has(this.id))return;const i=r.viewModel.view;if(!i)return;const w=r.viewModel.sketchViewModel;f=w.updateOnGraphicClick,w.updateOnGraphicClick=!1,e._lastActiveGraphics=[],e._featureFormHandle=o(e._featureFormHandle),e._visualVariableAttributes={rotation:null,size:null},C(r.viewModel.attachmentsViewModel);const g="2d"===i.type?e._fadeExistingFeatures(r.creationInfo.layer):null,y=w.on("create",(async t=>{if("cancel"===t.state){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(m);const t=e._lastActiveGraphics.pop();return e._startUpdating(t,m)}if("complete"===t.state&&t.graphic)return e._startUpdating(t.graphic,m)})),M=w.on("update",(async t=>{const o=t.graphics[0];if("complete"===t.state){if(o!==p&&(e._lastActiveGraphics.push(o),e._highlight(o)),p=null,"add"!==r.viewModel.attachmentsViewModel.mode&&"edit"!==r.viewModel.attachmentsViewModel.mode||r.viewModel.activeWorkflow?.previous(),t.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);const s=i.cursor;return i.cursor="progress",h.add([a((()=>i.cursor=s)),i.on("click",(e=>e.preventDefault()))],O),c((()=>!r.viewModel.featureFormViewModel.updating)).then((()=>{h.remove(O),e._startCreating(m)}))}if("start"===t.state){e._removeHighlight(o);const t=r.viewModel.attachmentsViewModel;"add"!==t.mode&&"edit"!==t.mode||r.viewModel.activeWorkflow?.previous(),t.fileInfos.removeAll(),t.graphic=o,t.mode="view";(e._attachmentFileInfos.get(o)||[]).forEach((({file:e,form:a})=>t.addFile(e,a)))}await E(i,o,t,e._visualVariableAttributes,m);const n=o.attributes;if(s(e._visualVariableAttributes.rotation)){const{field:t}=e._visualVariableAttributes.rotation;r.viewModel.featureFormViewModel.setValue(t,n[t])}if(s(e._visualVariableAttributes.size)){const{field:t}=e._visualVariableAttributes.size;r.viewModel.featureFormViewModel.setValue(t,n[t])}})),_=w.on("delete",(async a=>{const i=a.graphics[0];t(e._lastActiveGraphics,i),p=i}));let A=null;const b=d((()=>{const e=w.snappingOptions.featureSources.find((e=>e.layer===r.creationInfo.layer));return{hasFeatureLayerSource:!!e,enabled:e?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=w.snappingOptions.featureSources;e?(n(A)&&(A=new v({layer:w.layer,enabled:t}),a.add(A)),A.enabled=t):(s(A)&&a.remove(A),A=l(A))}),u),F=i.on("immediate-click",(async t=>{const{results:a}=await i.hitTest(t,{include:w.layer}),r=a.find((e=>"graphic"===e.type));if(r){const t=r.graphic;if("transform"===w.activeTool||"reshape"===w.activeTool){if(w.updateGraphics.getItemAt(0)===t)return;await e.updatePendingFeature(t,m)}}})),V=d((()=>r.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&r.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&r.viewModel.activeWorkflow.go("editing-attachment")}));await e._startCreating(m);const I={remove:()=>{o(e._featureFormHandle),y.remove(),M.remove(),_.remove(),b.remove(),s(A)&&w.snappingOptions.featureSources.remove(A),A=l(A),w.cancel(),F.remove(),V.remove(),o(g)}};h.add(I,this.id)},async tearDown(t){t.cancelled&&(r.viewModel.sketchViewModel.layer.removeAll(),h.remove([this.id,O]),r.viewModel.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear(),r.viewModel.sketchViewModel.updateOnGraphicClick=f)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{graphic:t,fileInfos:a}=r.viewModel.attachmentsViewModel;e._attachmentFileInfos.set(t,a.toArray()),r.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{graphic:t,fileInfos:a}=r.viewModel.attachmentsViewModel;e._attachmentFileInfos.set(t,a.toArray()),r.viewModel.attachmentsViewModel.mode="view"}})});return j(r,w)}_getAddAttachmentsData(e,t,a,i){const r=[];return t.forEach(((t,o)=>{if(!t.error){const s=e[o],n=i.get(s)||[];s.attributes[a.objectIdField]=t.objectId,n.forEach((({form:e})=>r.push({feature:s,attachment:e})))}})),r}_getAttachmentEditsWithGlobalIds(e,t,a){const i=[],r=t.globalIdField;return e.forEach(((t,o)=>{const s=a.get(t)||[];let l=t.attributes[r];n(l)&&(l=h(),e[o].attributes[r]=l),s.forEach((({file:e})=>i.push({feature:t,attachment:{globalId:h(),data:e}})))})),i.length?{addFeatures:e,addAttachments:i}:{addFeatures:e}}};e([p()],U.prototype,"reliesOnOwnerAdminPrivileges",null),e([p()],U.prototype,"shouldShowAttachments",null),e([p()],U.prototype,"shouldAllowAttachmentEditing",null),e([p()],U.prototype,"helpMessage",null),U=G=e([f("esri.widgets.Editor.CreateFeaturesWorkflow")],U);const D=U;export{D as default};
