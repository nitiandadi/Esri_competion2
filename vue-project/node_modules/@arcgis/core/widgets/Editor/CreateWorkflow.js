/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{isSome as t}from"../../core/maybe.js";import{watch as a}from"../../core/reactiveUtils.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import"../../core/arrayUtils.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import{getEffectiveLayerCapabilities as r,getEffectiveEditingEnabled as s}from"../../layers/support/layerUtils.js";import{getDrawHelpMessage as n}from"../../views/draw/support/helpMessageUtils.js";import d from"./CreateWorkflowData.js";import{Edits as l}from"./Edits.js";import c from"./Workflow.js";import{shouldShowAttachmentsForCreateWorkflow as w,createWorkflowSteps as p,avoidFeatureTemplateSelectionWithOnlyOneItem as u,setUpFeatureAdd as f,findLayerInfo as m,prepareAttachmentsForCreateWorkflow as h,getVisualVariableAttributes as g,startUpdatingFeature as v,visualVariableInteractiveUpdate as y,updateGraphicSymbolWhenRequired as M}from"./workflowUtils.js";var V;let k=V=class extends c{constructor(e){super(e),this.type="create"}get shouldShowAttachments(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&w(this.data)}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get helpMessage(){if("editing-new-feature"!==this.stepId)return;const{creationInfo:e,viewModel:t}=this.data;return n(e.layer.geometryType,t.sketchViewModel.createGraphic?.geometry)}get reliesOnOwnerAdminPrivileges(){const{layer:e}=this.data.creationInfo,t=e.capabilities?.operations.supportsAdd,a=r(e)?.operations.supportsAdd;return s(e)&&!e.editingEnabled||!!a&&!t}static create(e,t,a){const i=new V({data:new d({edits:new l,viewModel:e}),onCommit:async e=>{await a(e.creationInfo.layer,{addFeatures:[e.edits.feature]})}});return i._set("steps",this._createWorkflowSteps(i,t)),i}static _createWorkflowSteps(e,i="awaiting-feature-creation-info"){const{data:o,handles:r}=e,s=new Map,n=p(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature","adding-attachment","editing-attachment"],i,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){o.creationInfo=null,o.edits.feature=null,o.viewModel.featureTemplatesViewModel.select(null),r.add(o.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{e&&(o.creationInfo=e,o.viewModel.activeWorkflow?.next())})),this.id)},async tearDown(){r.remove(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){r.add(await f(o.viewModel.sketchViewModel,o.creationInfo,(e=>{o.edits.feature=e,o.viewModel.activeWorkflow?.next()}),s),this.id)},async tearDown(){r.remove(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){const e=o.edits.feature,i=e.sourceLayer,n=o.viewModel,d=n.sketchViewModel,l=m(n.layerInfos,i)?.formTemplate,{spatialReference:c}=n.view;n.featureFormViewModel.set({arcadeEditType:"INSERT",feature:e,formTemplate:l,spatialReference:c}),d.allowDeleteKey=!1,h(n.attachmentsViewModel);const w=g(e);await v(d,e,i,w,s);const p=d.on("update",(async e=>{const a=e.graphics[0];if("complete"===e.state)return v(d,a,i,w,s);await y(d.view,a,e,w,s);const o=a.attributes;if(t(w.rotation)){const{field:e}=w.rotation;n.featureFormViewModel.setValue(e,o[e])}if(t(w.size)){const{field:e}=w.size;n.featureFormViewModel.setValue(e,o[e])}}));r.add([o.viewModel.featureFormViewModel.on("value-change",(async()=>{o.edits.updateAttributes(o.viewModel.featureFormViewModel.getValues()),e.attributes=o.edits.feature.attributes,"3d"===d.view.type&&await M(e,s)})),p,a((()=>o.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&o.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&o.viewModel.activeWorkflow.go("editing-attachment")}))],this.id)},async tearDown(e){e.cancelled&&o.viewModel.sketchViewModel.layer.removeAll(),r.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){o.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){o.viewModel.attachmentsViewModel.mode="view"}})});return u(o,n)}};e([i()],k.prototype,"shouldShowAttachments",null),e([i()],k.prototype,"shouldAllowAttachmentEditing",null),e([i()],k.prototype,"helpMessage",null),e([i()],k.prototype,"reliesOnOwnerAdminPrivileges",null),k=V=e([o("esri.widgets.Editor.CreateWorkflow")],k);const j=k;export{j as default};
