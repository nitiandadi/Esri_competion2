/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import e from"../../Graphic.js";import"../../core/has.js";import{handlesGroup as t}from"../../core/handleUtils.js";import{isSome as i,isNone as r,removeMaybe as a}from"../../core/maybe.js";import{whenOrAbort as n,eachAlways as s}from"../../core/promiseUtils.js";import{watch as o,initial as l,whenOnce as c}from"../../core/reactiveUtils.js";import{px2pt as u}from"../../core/screenUtils.js";import{diff as p}from"../../core/accessorSupport/diffUtils.js";import{calculateTolerance as y}from"../../renderers/support/clickToleranceUtils.js";import{meterIn as d}from"../../renderers/support/lengthUtils.js";import{getTransformationType as f,TransformationType as m}from"../../renderers/visualVariables/support/sizeVariableUtils.js";import{getRotationAngle as h,getSize as b}from"../../renderers/visualVariables/support/visualVariableUtils.js";import{to3D as g}from"../../symbols/support/symbolConversion.js";import{getDisplayedSymbol as w}from"../../symbols/support/symbolUtils.js";import{GraphicState as v}from"../../views/3d/layers/graphics/GraphicState.js";import{createQueryGeometry as S}from"../../views/support/drapedUtils.js";import{hitTestSelectSimilarDistance as I,filterGraphicHits as j}from"../../views/support/hitTestSelectUtils.js";function U(e){const t=e.sourceLayer;if(!t||"feature"!==t.type||!L(t.renderer))return{rotation:null,size:null};let r=null,a=null;const n=t.renderer.getVisualVariablesForType("rotation").filter((t=>(!t.axis||"heading"===t.axis)&&t.field&&!t.valueExpression&&i(h(t,e))));1===n.length&&(r=V(n[0],t));const s=t.renderer.getVisualVariablesForType("size").filter((t=>t.field&&!t.useSymbolValue&&!t.valueExpression&&f(t)===m.RealWorldSize&&i(b(t,e))));return 1===s.length&&(a=x(s[0],t)),{rotation:r,size:a}}function V(e,t){const i="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,r=e.field,a=t.fields&&t.fields.filter((e=>e.name===r)),n=a&&1===a.length?a[0].type:"double",s={initial:0,current:0};return{field:r,fieldType:n,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-i*e,T((s.current+360)%360,n)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}function z(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}async function F(e,t,i){if(r(t))return 0;const{symbol:a}=g(t);if(r(a)||"web-style"===a.type||"cim"===a.type)return 0;const n=a.symbolLayers.getItemAt(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("../../symbols/support/symbolLayerUtils.js");return n.size||Math.min(J.icon,(await e(n,J.icon))[0])||J.icon}case"text":return n.size||J.text;case"line":return n.size||J.line;case"object":{const{computeObjectLayerResourceSize:t}=await import("../../symbols/support/symbolLayerUtils.js");return z(await t(n,e.scale/J.viewScaleSizeFactor),i)}case"path":return(null!=n.width?n.width:n.height)||e.scale/J.viewScaleSizeFactor;case"extrude":return n.size||e.scale/J.viewScaleSizeFactor;default:return 0}}function x(e,t){const i=e.field,r=e.axis,a=t.fields&&t.fields.filter((e=>e.name===i)),n=a&&1===a.length?a[0].type:"double",s={updating:!1,initial:0,current:0},o=d[e.valueUnit]??1;let l;return l="area"===e.valueRepresentation?e=>(e*o/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*o/2:e=>e*o,{field:i,fieldType:n,getDefault:async(e,t)=>T(l(await F(t,e,r)),n),getValue:(e,t)=>(s.initial||(s.initial=t.pixelSizeAt(t.center)),s.current=s.initial*e,T(s.current,n)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1,displayUnit:Y(e.valueUnit),axis:e.axis}}function T(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function L(e){switch(e?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}async function E(e,t){const r=await w(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t}),a=p(e.symbol,r);i(a)&&(e.symbol=r)}function M(e){if(!e)throw new Error("no geometry type");if("mesh"===e||"multipatch"===e)throw new Error("Mesh and Multipatch not supported");return e}async function R(e,t,i,r){await A(e,t,r);const a=e.on("create",(async a=>{if("cancel"===a.state)return A(e,t,r);if("complete"===a.state){const e=a.graphic;e.sourceLayer||(e.sourceLayer=t.layer),e.attributes||(e.attributes={...t.template.prototype.attributes}),await E(e,r),i(e)}}));return{remove:()=>{a.remove(),e.cancel()}}}async function A(e,t,i){const r=t.layer,a={...t.template.prototype.attributes};await O(e,r,a,i);const n={graphicProperties:{attributes:a,sourceLayer:r},hasZ:r.capabilities.data.supportsZ};return e.layer.elevationInfo=r.elevationInfo,e.create(M(r.geometryType),n)}async function O(t,i,a,n){const s=new e({sourceLayer:i,attributes:a}),{rotation:o,size:l}=U(s);let c=await w(s,{useSourceLayer:!0,webStyleCache:n}),u=!1;for(const e of[l,o]){if(r(e))continue;null==a[e.field]&&(a[e.field]=await e.getDefault(c,t.view),u=!0)}switch(u&&(c=await w(s,{useSourceLayer:!0,webStyleCache:n})),c?.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=c;break;case"simple-line":case"line-3d":t.polylineSymbol=c;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":t.pointSymbol=c}k(t.tooltipOptions,l,o)}function k(e,t,r){i(t)||i(r)?e.visualVariables={size:i(t)?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:i(r)?{valueType:r.fieldType,rotationType:r.rotationType??"geographic"}:null}:e.visualVariables=null}function C(e,t){return e?e.find((e=>e.layer===t)):void 0}async function G(e,t,i,r){if(0===e.length)return[];const{updatable:a,graphicsByLayer:o}=await i.async((async()=>{const{results:a}=await n(I(t,i),r),s=new Map,o=e=>{const t=e.layer,i=s.get(t);if(!i){const e=new Array;return s.set(t,e),e}return i};j(a).forEach((({graphic:e})=>o(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.includes("update")&&s.has(t)));return 0!==l.length&&i.stopPropagation(),{updatable:l,graphicsByLayer:s}}));return n(s(a.map((async({layer:e})=>{const{objectIdField:t}=e,i="displayField"in e?e.displayField:null,a=[t];null!=i&&e.fieldsIndex.has(i)&&a.push(i);const n=o.get(e);if(!!n.some((e=>a.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=a,t.returnGeometry=!1,t.objectIds=n.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:r}).then((({features:e})=>e))}return n}))),r)}async function P(e,t,i,r){if(0===e.length)return[];let a=null;const o=await i.async((async()=>{const{results:s}=await n(t.hitTest(i),r);if(0===s.length)return[];const o=new Set;a=j(s),a.forEach((({graphic:e})=>e&&o.add(e.layer)));const l=e.items.filter((({layer:e,supports:t,attachmentsOnUpdateEnabled:i})=>o.has(e)&&(t.includes("update")||t.includes("delete")||i)));return l.length>0&&i.stopPropagation(),l}));return n(s(o.map((({layer:e})=>{const n=e.objectIdField,s="displayField"in e?e.displayField:null,o=[n];null!=s&&e.fieldsIndex.has(s)&&o.push(s);const l=e.createQuery();l.outFields=o,l.returnGeometry=!1;const c="renderer"in e?y({renderer:e.renderer,event:i}):0;return l.geometry=S(i.mapPoint,c,t),l.outSpatialReference=t.spatialReference,e.queryFeatures(l,{signal:r}).then((({features:t})=>(a?.forEach((({graphic:i})=>{i.layer!==e||t.some((e=>e.getObjectId()===i.getObjectId()))||t.push(i)})),t)))}))),r)}async function q(e,t,i,r){switch(t.type){case"3d":return G(e,t,i,r);case"2d":return P(e,t,i,r)}}async function D(e,t,i){const{sourceLayer:r}=e,a=r.createQuery();return a.objectIds=[e.getAttribute(r.objectIdField)],a.outFields=["*"],a.outSpatialReference=t.spatialReference,a.returnM=r.capabilities.data.supportsM,a.returnZ=r.capabilities.data.supportsZ,(await r.queryFeatures(a,{signal:i})).features[0]}async function Z(e,t,a,n,s){let o=!1;const{rotation:l,size:c}=n;[l,c].forEach((async a=>{if(r(a))return;const n=t.attributes[a.field];if(i(n))a.initValue(n);else{const i=await a.getDefault(t.symbol,e.view);a.initValue(i),t.setAttribute(a.field,i),o=!0}})),o&&await E(t,s);const u={multipleSelectionEnabled:!1};return"point"===a.geometryType&&(u.enableRotation=i(l),u.enableScaling=i(c)),k(e.tooltipOptions,c,l),e.layer.elevationInfo=a.elevationInfo,e.update(t,u)}function Q(e){return!i(e)||"rotate-start"!==e.type&&"rotate"!==e.type&&"rotate-stop"!==e.type?null:e}function B(e){return!i(e)||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}async function W(e,t,r,a,n){if(!i(t.geometry)||"point"!==t.geometry?.type)return;const s=a.rotation,o=Q(r.toolEventInfo);if(i(s)&&i(o))if("rotate-stop"===o.type)s.isUpdatingInteractively=!1,s.initValue();else{s.isUpdatingInteractively=!0;const{field:i,getValue:r}=s;t.attributes[i]=r(o.angle,e)}const l=a.size,c=B(r.toolEventInfo);if(i(l)&&i(c))if("scale-stop"===c.type)l.isUpdatingInteractively=!1,l.initValue();else{l.isUpdatingInteractively=!0;const{field:i,getValue:r}=l;t.attributes[i]=r(c.xScale,e)}await E(t,n)}async function H(e,n,s,u,p,y){const d=e.clone();await E(d,y),u.map.add(s.layer),s.layer.add(d);const f=e.sourceLayer,m=te(u,f),h=()=>{const t=e.layer,i=e.attributes[t.objectIdField];return m.then((e=>e.setVisibility?.(i,!1)),(()=>{})),{remove(){m.then((e=>e.setVisibility?.(i,!0)),(()=>{}))}}};let b=null,g=null;if("3d"===u.type){const e=new v({graphic:d});b=t([u.trackGraphicState(e),o((()=>e.displaying),(e=>{g=e?h():a(g)}),l)])}else g=h();await Z(s,d,f,n,y);let w=null;m.then((e=>w=e),(()=>{}));const S=n.size,I=n.rotation,j=o((()=>e.attributes),(async e=>{let t=!1;for(const a in e){const n=e[a];n!==d.attributes[a]&&(d.setAttribute(a,n),i(S)&&!S.isUpdatingInteractively&&S.field===a&&S.initValue(n),i(I)&&!I.isUpdatingInteractively&&I.field===a&&I.initValue(n),(r(w)||w.requiredFields.includes(a))&&(t=!0))}t&&await E(d,y)})),U=s.on("update",(async e=>{const t=e.graphics[0];if("complete"===e.state)return Z(s,t,f,n,y);await W(u,t,e,n,y),p(t.clone(),e)})),V=s.on(["undo","redo"],(async e=>{p(e.graphics[0].clone(),e)})),z=()=>{};return{interactive:{remove(){V.remove(),U.remove(),s.cancel(),j&&j.remove(),this.remove=z}},visual:{remove(){a(g),te(u,f).then((e=>c((()=>!e.updating)))).then((()=>{a(b),s.layer.remove(d),this.remove=z}))}}}}const J={icon:u(24),text:u(12),line:u(1),viewScaleSizeFactor:100};function K(e,t,i){let r=!1;return e.filter((e=>!!r||(r=e===t,r))).map((e=>i[e]()))}function N(e){if(1!==e.length)return null;const t=e[0];if("items"in t){const e=t;return 1===e.items.length?e.items[0]:null}return t}function X(e,t){if(e.viewModel.refreshCreationTemplates(),"awaiting-feature-creation-info"===t[0].id){const r=N(e.viewModel.featureTemplatesViewModel.items);i(r)&&(e.creationInfo=r,t.shift())}return t}function Y(e){switch(e){case"unknown":case"decimal-degrees":return null;default:return e}}function $(e){e.set({abilities:{editing:!0,operations:{add:!0,update:!0,delete:!0}},filesEnabled:!0,mode:"view"})}function _(e){const{creationInfo:{layer:t},viewModel:i}=e,r=i.editableItems.find((e=>e.layer===t));if(r)return r.attachmentsOnCreateEnabled;const a=t.capabilities?.data,n=i.layerInfos?.find((e=>e.layer===t));return!(!(a&&"supportsAttachment"in a&&a.supportsAttachment)||n&&(!1===n.allowAttachments||!1===n.attachmentsOnUpdateEnabled))}const ee=e=>/-stop/.test(e)||/vertex-/.test(e),te=(e,t)=>{const i="subtype-sublayer"===t.type?t.parent:t;return e.whenLayerView(i)};export{X as avoidFeatureTemplateSelectionWithOnlyOneItem,K as createWorkflowSteps,q as fetchCandidates,D as fetchFullFeature,C as findLayerInfo,U as getVisualVariableAttributes,ee as isTerminalUpdateEventType,$ as prepareAttachmentsForCreateWorkflow,R as setUpFeatureAdd,H as setUpGeometryUpdate,_ as shouldShowAttachmentsForCreateWorkflow,J as sizeDefaults,Y as sizeVariableUnitToLengthUnit,A as startCreatingNewFeature,Z as startUpdatingFeature,E as updateGraphicSymbolWhenRequired,W as visualVariableInteractiveUpdate,te as whenEditorLayerView};
