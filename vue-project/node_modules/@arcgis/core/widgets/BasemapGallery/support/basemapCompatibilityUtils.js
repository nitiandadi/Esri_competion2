/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{isSome as t,isNone as a}from"../../../core/maybe.js";import{throwIfAborted as i}from"../../../core/promiseUtils.js";import{isTiledLayer as r,isBasemapSupportedLayer as n}from"../../../layers/support/layerUtils.js";import{stringFromViewingMode as s,ViewingMode as o}from"../../../views/ViewingMode.js";import{getTileInfoAndExtentFromWMTSLayer as l,checkIfTileInfoSupportedForView as p}from"../../../views/3d/terrain/terrainUtils.js";import{TilingScheme as c}from"../../../views/3d/terrain/TilingScheme.js";import{isSpatialReferenceSupported as m}from"../../../views/support/spatialReferenceSupport.js";async function f(e,t={}){await y(e,t),i(t)}async function u(e,a={}){const{basemap:n,view:s}=e;if(i(a),"spatialReferenceLocked"in s&&!s.spatialReferenceLocked)return;if(await n.load(a),i(a),0===n.baseLayers.length)return;const o=n.baseLayers.getItemAt(0);if(!r(o))return;if(n.spatialReference){if(s.spatialReference.equals(n.spatialReference))return;w()}await o.load(a),i(a);const l=(("supportedSpatialReferences"in o?o.supportedSpatialReferences:null)||["tileInfo"in o?o.tileInfo?.spatialReference:null]).filter(t);0!==l.length&&l.every((e=>!s.spatialReference.equals(e)))&&w()}function w(){throw new e("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}async function y(t,a){const{basemap:i,view:r}=t;if(await i.load(a),0===i.baseLayers.length)return;const s=i.baseLayers.concat(i.referenceLayers).toArray().filter((e=>!n(e))).map((t=>new e("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:t,operationalLayerType:t.operationalLayerType||"unknown"})));if(s.length)throw s[0];const o=i.baseLayers.getItemAt(0);if(n(o)){try{await o.load(a)}catch(l){const t="basemap-compatibility:unknown-error",a="Unknown basemap compatibility error",{name:i=t,message:r=a,details:n}=l;throw new e(i,r,n)}b(o,r)}}function b(i,r){const n=r.state.viewingMode;if(!n)return;let f,u;if("wmts"===i?.type){const t=l(i,r.spatialReference,n);if(a(t.tileInfo))throw new e("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");f=t.tileInfo,u=t.fullExtent}else f=i.tileInfo,u=i.fullExtent;if(a(f))return;if(!m(f.spatialReference,n))throw new e(`basemapgalleryitem:spatial-reference-unsupported-${s(n)}`,`Basemap spatial reference is unsupported in ${s(n)} mode`);const w=f.spatialReference.isGeographic,y="vector-tile"===i?.type?f.getOrCreateCompatible(256,w?1:2):null;if(n===o.Global){let a=p(f,u,null,n);if(a&&"vector-tile"===i?.type&&t(u)&&y&&!p(y,u,null,n)&&(a=null),a){const t=f.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new e(`basemapgalleryitem:tiling-scheme-unsupported-${t}-global`,"Basemap tiling scheme is unsupported in global mode",{error:a})}}else if(c.checkUnsupported(f))throw new e("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const b=r.get("basemapTerrain.tilingScheme");if(b&&!b.compatibleWith(f)&&("vector-tile"!==i?.type||!y||!b.compatibleWith(y)))throw new e("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}export{u as default2DCompatibility,f as default3DCompatibility};
