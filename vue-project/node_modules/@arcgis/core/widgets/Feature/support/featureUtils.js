/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import"../../../intl.js";import e from"../../../core/Logger.js";import{isNone as t,isSome as r}from"../../../core/maybe.js";import{replace as n}from"../../../core/string.js";import{formatDate as i,convertDateFormatToIntlOptions as o}from"../../../intl/date.js";import{formatNumber as a,convertNumberFormatToIntlOptions as l}from"../../../intl/number.js";import{isRasterPixelValueField as u,featureHasFields as s}from"../../../layers/support/fieldUtils.js";import{getEffectiveLayerCapabilities as f}from"../../../layers/support/layerUtils.js";import c from"../../../popup/support/FieldInfoFormat.js";import{loadArcade as d}from"../../../support/arcadeOnDemand.js";const p="esri.widgets.Feature.support.featureUtils",m=e.getLogger(p),y=/href=(""|'')/gi,g=/(\{([^\{\r\n]+)\})/g,h=/\'/g,I=/^\s*expression\//i,b=/(\n)/gi,F=/[\u00A0-\u9999<>\&]/gim,w=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,N=/^(?:mailto:|tel:)/,E="relationships/",T=o("short-date-short-time");function j(e){if(!t(e))return e.get("sourceLayer")||e.get("layer")}async function x(e,t){return"function"==typeof e?e.call(null,t):e}function C(e=""){if(e)return!N.test(e.trim().toLowerCase())}function M(e){return!!e&&I.test(e)}function q(e,t){if(!M(t)||!e)return null;const r=t.replace(I,"").toLowerCase();let n=null;return e.some((e=>e.name.toLowerCase()===r&&(n=e,!0))),n}function R(e,t){const r=q(t,e?.fieldName);return r?r.title||null:e?e.label||e.fieldName:null}function v(e,t){const r=t.get(e.toLowerCase());return`{${r&&r.fieldName||e}}`}function D(e){return e.replace(y,"")}function L(e,t){const r=A(t,e);return r?r.name:e}function U(e,t){return e&&e.map((e=>L(e,t)))}function A(e,t){return e&&"function"==typeof e.getField&&t?e.getField(t)??null:null}function $(e){return`${e}`.trim()}function S({attributes:e,globalAttributes:t,layer:r,text:n,expressionAttributes:i,fieldInfoMap:o}){return n?G({formattedAttributes:t,template:z(n,{...t,...i,...e},r),fieldInfoMap:o}):""}function G({formattedAttributes:e,template:t,fieldInfoMap:r}){return $(D(n(n(t,(e=>v(e,r))),e)))}function k(e,t,r=!1){const n=t[e];if("string"==typeof n){const i="%27",o=(r?encodeURIComponent(n):n).replace(h,i);t[e]=o}}function O(e,t=!1){const r={...e};return Object.keys(r).forEach((e=>k(e,r,t))),r}function P(e,t,r){const i=(t=$(t))&&"{"!==t[0];return n(e,O(r,i||!1))}function _(e,t){return e.replace(g,((e,r,n)=>{const i=A(t,n);return i?`{${i.name}}`:r}))}function z(e,t,r){const n=_(e,r);return n?n.replace(w,((e,r,n)=>P(e,r||n,t))):n}function H(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}function Q(e){return"feature"===e?.type}function Z(e){return!!e?.layer}function V(e){return"map-image"===e?.type}function B(e,t){const r=t.fieldInfos,n=t.fieldName,i=J(r,n)?.clone(),o=t.preventPlacesFormatting,s=t.layer,f=A(s,n);if(i&&"date"===f?.type){const e=i.format||new c;e.dateFormat=e.dateFormat||"short-date-short-time",e.dateTimeFormatOptions=!Z(s)&&Q(s)&&s.datesInUnknownTimezone||Z(s)&&V(s.layer)&&s.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null,i.format=e}const d=i&&i.format;return"string"==typeof e&&u(n)&&d?d.formatRasterPixelValue(e):"string"==typeof(e=H(e,d))||null==e||null==d?re(e):o?a(e,{...l(d),minimumFractionDigits:0,maximumFractionDigits:20}):d.format(e)}function J(e,t){if(!e||!e.length||!t)return;const r=t.toLowerCase();let n;return e.some((e=>!(!e.fieldName||e.fieldName.toLowerCase()!==r)&&(n=e,!0))),n}function K({fieldName:e,graphic:t,layer:r}){if(ue(e))return null;if(!r||"function"!=typeof r.getFeatureType)return null;const{typeIdField:n}=r;if(!n||e!==n)return null;const i=r.getFeatureType(t);return i?i.name:null}function W({fieldName:e,value:t,graphic:r,layer:n}){if(ue(e))return null;if(!n||"function"!=typeof n.getFieldDomain)return null;const i=r&&n.getFieldDomain(e,{feature:r});return i&&"coded-value"===i.type?i.getName(t):null}function X(e,t){const{creatorField:r,creationDateField:n,editorField:o,editDateField:a}=e;if(!t)return;const l=t[a];if("number"==typeof l){const e=t[o];return{type:"edit",date:i(l,T),user:e}}const u=t[n];if("number"==typeof u){const e=t[r];return{type:"create",date:i(u,T),user:e}}return null}function Y(e,t){const r=new Map;return e?(e.forEach((e=>{const n=L(e.fieldName,t);e.fieldName=n,r.set(n.toLowerCase(),e)})),r):r}function ee(e){const t=[];if(!e)return t;const{fieldInfos:r,content:n}=e;return r&&t.push(...r),n&&Array.isArray(n)?(n.forEach((e=>{if("fields"===e.type){const r=e&&e.fieldInfos;r&&t.push(...r)}})),t):t}function te(e){return e.replace(F,(e=>`&#${e.charCodeAt(0)};`))}function re(e){return"string"==typeof e?e.replace(b,'<br class="esri-text-new-line" />'):e}function ne(e){const{value:t,fieldName:r,fieldInfos:n,fieldInfoMap:o,layer:a,graphic:l}=e;if(null==t)return"";const u=W({fieldName:r,value:t,graphic:l,layer:a});if(u)return u;const s=K({fieldName:r,graphic:l,layer:a});if(s)return s;if(o.get(r.toLowerCase()))return B(t,{fieldInfos:n||Array.from(o.values()),fieldName:r,layer:a});const f=a&&a.fieldsIndex;return f&&f.isDateField(r)?i(t,T):re(t)}function ie({fieldInfos:e,attributes:t,layer:r,graphic:n,fieldInfoMap:i,relatedInfos:o}){const a={};return o?.forEach((t=>ce({attributes:a,relatedInfo:t,fieldInfoMap:i,fieldInfos:e,layer:r}))),t&&Object.keys(t).forEach((o=>{const l=t[o];a[o]=ne({fieldName:o,fieldInfos:e,fieldInfoMap:i,layer:r,value:l,graphic:n})})),a}async function oe(e,t){const{layer:r,graphic:n,outFields:i,objectIds:o,returnGeometry:a,spatialReference:l}=e,u=o[0];if("number"!=typeof u&&"string"!=typeof u){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:r,graphic:n,objectId:u,requiredFields:i};return m.warn(e,t),null}if(!f(r)?.operations?.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:r,graphic:n,requiredFields:i,returnGeometry:a};return m.warn(e,t),null}const s=r.createQuery();s.objectIds=o,s.outFields=i?.length?i:[r.objectIdField],s.returnGeometry=!!a,s.returnZ=!!a,s.returnM=!!a,s.outSpatialReference=l;return(await r.queryFeatures(s,t)).features[0]}async function ae(e){if(!e.expressionInfos?.length)return!1;const t=await d(),{arcadeUtils:{hasGeometryFunctions:r}}=t;return r(e)}async function le({graphic:e,popupTemplate:t,layer:r,spatialReference:n},i){if(!r||!t)return;if("function"==typeof r.load&&await r.load(i),!e.attributes)return;const o=e.attributes[r.objectIdField];if(null==o)return;const a=[o],l=await t.getRequiredFields(r.fieldsIndex),u=s(l,e),f=u?[]:l,c=t.returnGeometry||await ae(t);if(u&&!c)return;const d=await oe({layer:r,graphic:e,outFields:f,objectIds:a,returnGeometry:c,spatialReference:n},i);d&&(d.geometry&&(e.geometry=d.geometry),d.attributes&&(e.attributes={...e.attributes,...d.attributes}))}function ue(e=""){return!!e&&e.includes(E)}function se(e){return e?`${E}${e.layerId}/${e.fieldName}`:""}function fe({attributes:e,graphic:t,relatedInfo:r,fieldInfos:n,fieldInfoMap:i,layer:o}){e&&t&&r&&Object.keys(t.attributes).forEach((a=>{const l=se({layerId:r.relation.id.toString(),fieldName:a}),u=t.attributes[a];e[l]=ne({fieldName:l,fieldInfos:n,fieldInfoMap:i,layer:o,value:u,graphic:t})}))}function ce({attributes:e,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:i}){e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach((o=>fe({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:i}))),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach((o=>fe({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:i}))))}const de=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},pe=({layer:e,method:t,query:n,definitionExpression:i})=>{if(!e.capabilities?.query?.supportsCacheHint||"attachments"===t)return;const o=r(n.where)?n.where:null,a=r(n.geometry)?n.geometry:null;de(i)||de(o)||"extent"===a?.type||"tile"===n.resultType||(n.cacheHint=!0)},me=({query:e,layer:t,method:r})=>{pe({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},ye=({queryPayload:e,layer:t,method:r})=>{pe({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})};function ge(e,t,r){return e&&t&&r?he(e.allLayers,t,r)||he(e.allTables,t,r):null}function he(e,t,r){return e.find((e=>e!==t&&"feature"===e.type&&e.url===t.url&&e.layerId===r.relatedTableId))}export{re as applyTextFormattingHTML,Y as createfieldInfoMap,ge as findRelatedLayer,_ as fixTokens,ie as formatAttributes,X as formatEditInfo,B as formatValueToFieldInfo,ee as getAllFieldInfos,J as getFieldInfo,R as getFieldInfoLabel,L as getFixedFieldName,U as getFixedFieldNames,j as getSourceLayer,x as graphicCallback,te as htmlEntities,M as isExpressionField,ue as isRelatedField,me as preLayerQueryCallback,ye as preRequestCallback,oe as querySourceLayer,le as queryUpdatedFeature,C as shouldOpenInNewTab,G as substituteAttributes,S as substituteFieldsInLinksAndAttributes};
