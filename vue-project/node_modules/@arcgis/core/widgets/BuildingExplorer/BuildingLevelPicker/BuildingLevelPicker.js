/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import{on as t}from"../../../core/events.js";import s from"../../../core/Handles.js";import{clamp as i}from"../../../core/mathUtils.js";import{isNone as o,isSome as l,unwrapOr as n}from"../../../core/maybe.js";import{watch as r,initial as h}from"../../../core/reactiveUtils.js";import{property as a}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/arrayUtils.js";import{subclass as v}from"../../../core/accessorSupport/decorators/subclass.js";import d from"../../Widget.js";import{L as _,a as p,A as g,b as c,c as u,d as m,e as L,f as y,g as P,h as b,i as f}from"../../../chunks/constants.js";import{CSS as w}from"./css.js";import{Label as C}from"./Label.js";import{LevelItem as W}from"./LevelItem.js";import{storeNode as x}from"../../support/widgetUtils.js";import{tsx as H}from"../../support/jsxFactory.js";const j={selectLevel:"selectLevel",clearLevel:"clearLevel",nextLevel:"nextLevel",previousLevel:"previousLevel",currentLevel:"{{value}}"};let E=class extends d{constructor(e,t){super(e,t),this._levelHandles=new s,this._levelEventHandles=new s,this._levelWidgets=[],this._labelWidget=new C({onClear:()=>this.vm.clear()}),this._hoveredLevel=null,this._expandedLevelsHeight=void 0,this._normalizedPointerPosition=0,this._hovering=!1,this._containerPosTop=null,this._levelsContainer=null,this._onPointerUp=()=>{if(window.getSelection()?.removeAllRanges(),o(this._hoveredLevel))return;const{vm:e}=this;e.enabled&&this._hoveredLevel===e.value?e.clear():e.select(this._hoveredLevel)},this._onPointerEnter=()=>{this._hovering||o(this._levelsContainer)||(this._hovering=!0,this._containerPosTop=this._levelsContainer.getBoundingClientRect().top??0)},this._onPointerLeave=()=>{this._hovering&&(this._normalizedPointerPosition=0,this._hoveredLevel=null,this._hovering=!1)},this._onPointerMove=e=>{if(!this._hovering)return!1;if(window.getSelection()?.removeAllRanges(),l(this._containerPosTop)){const t=this._containerPosTop,s=u*f,i=this._expandedLevelsMargin;let o=this._levelsHeight,l=t+s+i;const n=this._levelHeight/2;l+=n,o-=n;let r=(e.clientY-l)/o;r+=y,this._normalizedPointerPosition=r}return!1}}postInitialize(){this.addHandles([r((()=>this._levelsContainer),(()=>this._onContainerChange()),h),r((()=>this._levels),(()=>this._createLevelWidgets()),h),r((()=>this.messages),(()=>{this._labelWidget.messages=n(this.messages,j)}),h)])}destroy(){this._levelHandles.destroy(),this._levelEventHandles.destroy(),this._levelWidgets.forEach((e=>e.destroy())),this._labelWidget.destroy()}get _levels(){return this.vm.allowedValues}get _numLevels(){return this._levels.length}get _levelsHeight(){return Math.round(this._levelHeight*this._numLevels)}get _expandedLevelsMargin(){return Math.round(((this._expandedLevelsHeight??0)-this._levelsHeight)/2)}get _levelWidth(){const{LEVEL_WIDTH_NOMINATOR:e,LEVEL_WIDTH_CONSTANT:t}=P,s=e/Math.sqrt(this._numLevels)+t;return Math.round(i(s,p,_))}get _levelHeight(){const e=b,t=2*e/Math.sqrt(this._numLevels);return Math.round(i(t,2,e))}get _gaussianFactor(){const e=this._numLevels;return e/Math.log(g*e)*c}get _levelClosestToPointer(){if(!this._hovering)return null;const e=this._numLevels-1,t=this._normalizedPointerPosition;return e>=0&&l(t)?this._levels[Math.round((1-t)*e)]:null}render(){const e=this._levelWidgets.length,t=e>1?this._levelWidgets.map((e=>e.render())):null,s=u*f,i=-s/f,o=this._levelsHeight,l=o+2*s;return H("div",{bind:this,key:this,class:this.classes("esri-widget",w.container,{[w.animateLevel]:!this._hovering,[w.noLevel]:e<2}),onkeydown:this._onKeyDown},this._renderLabelContainer(),H("div",{bind:this,class:w.levelsContainer,styles:{height:`${l}px`,marginTop:`${i}px`,marginBottom:`${i}px`},onfocus:this._onFocus,afterCreate:x,"data-node-ref":"_levelsContainer"},H("div",{styles:{height:`${o}px`,margin:u-this._expandedLevelsMargin+"px 0 0 0"},class:w.innerLevelsContainer},t)))}_renderLabelContainer(){const e=n(this.messages,j),t=e.previousLevel,s=e.nextLevel;return H("div",{class:w.labelContainer,tabIndex:0},H("button",{bind:this,class:w.arrowUp,disabled:!this.vm.hasNext,onclick:this._onArrowUpClick,"aria-label":s,title:s,type:"button"}),this._labelWidget.render(),H("button",{bind:this,class:w.arrowDown,disabled:!this.vm.hasPrevious,onclick:this._onArrowDownClick,"aria-label":t,title:t,type:"button"}))}_updateComponents(){const e=n(this.messages,j),t=this.vm.enabled?this.vm.value:null,s=l(this._hoveredLevel)?this._hoveredLevel:t;this._levelWidgets.forEach((s=>{const i=this.vm.getValueLabel(s.level);s.label=l(i)?i:e.currentLevel?.replace("{{level}}",String(s.level)),s.active=s.level===t,s.hovering=s.level===this._hoveredLevel})),this._labelWidget.level=s,this._labelWidget.active=s===t,this._labelWidget.hovering=l(this._hoveredLevel)}_createLevelWidgets(){this._levelWidgets.forEach((e=>e.destroy())),this._levelWidgets=this._levels.map((e=>new W({level:e,onSelect:()=>this._onLevelToggle(e)}))),this._levelHandles.removeAll(),this._levelHandles.add([r((()=>{const{vm:e}=this;return[this.messages,e?.value,e?.enabled,this._hoveredLevel,this._hovering]}),(()=>this._updateComponents()),h),r((()=>[this._normalizedPointerPosition,this._hovering]),(()=>this._onPointerPositionChange()),h),r((()=>this._levelWidth),(e=>this._levelWidgets.forEach((t=>t.width=e))),h)])}_onContainerChange(){const e=this._levelsContainer;o(e)||(this._levelEventHandles.removeAll(),this._levelEventHandles.add([t(e,"pointerenter",this._onPointerEnter),t(e,"pointerover",this._onPointerEnter),t(e,"pointerleave",this._onPointerLeave),t(e,"pointerup",this._onPointerUp),t(e,"pointermove",this._onPointerMove)]))}_onKeyDown(e){switch(e.key){case"ArrowDown":case"ArrowLeft":e.preventDefault(),e.stopPropagation(),this.vm.previous(),this._focusCurrentLevel();break;case"ArrowUp":case"ArrowRight":e.preventDefault(),e.stopPropagation(),this.vm.next(),this._focusCurrentLevel()}}_focusCurrentLevel(){const e=this._levelWidgets.find((e=>e.level===this.vm.value));e&&e.focus()}_onFocus(){this._hoveredLevel=this._levels.length>0?this._levels[0]:null}_onLevelToggle(e){const{vm:t}=this;t.enabled&&t.value===e?t.clear():t.select(e)}_onArrowUpClick(){this.vm.next()}_onArrowDownClick(){this.vm.previous()}_onPointerPositionChange(){let e=0;this._levelWidgets.forEach(((t,s)=>{const{width:i,height:o}=this._getLevelWidgetSize(s);t.height=o,t.width=i,e+=o})),this._hoveredLevel=this._levelClosestToPointer;const t=this._expandedLevelsHeight;(null==t||Math.abs(t-e)>30)&&(this._expandedLevelsHeight=e)}_getLevelWidgetSize(e){const t={width:this._levelWidth,height:this._levelHeight};if(this._hovering){const s=this._getGaussianFactor(e,this._normalizedPointerPosition);t.width+=m*s,t.height+=L*s}return t}_getGaussianFactor(e,t){const s=this._numLevels-1,i=(s-e)/s,o=this._gaussianFactor*(i-t);return Math.exp(-(o**2))}};e([a()],E.prototype,"vm",void 0),e([a()],E.prototype,"messages",void 0),e([a()],E.prototype,"_levelWidgets",void 0),e([a()],E.prototype,"_labelWidget",void 0),e([a()],E.prototype,"_hoveredLevel",void 0),e([a()],E.prototype,"_levels",null),e([a()],E.prototype,"_numLevels",null),e([a({readOnly:!0})],E.prototype,"_levelsHeight",null),e([a()],E.prototype,"_expandedLevelsHeight",void 0),e([a({readOnly:!0})],E.prototype,"_expandedLevelsMargin",null),e([a({readOnly:!0})],E.prototype,"_levelWidth",null),e([a({readOnly:!0})],E.prototype,"_levelHeight",null),e([a({readOnly:!0})],E.prototype,"_gaussianFactor",null),e([a({readOnly:!0})],E.prototype,"_levelClosestToPointer",null),e([a({type:Number,range:{min:0,max:1}})],E.prototype,"_normalizedPointerPosition",void 0),e([a()],E.prototype,"_hovering",void 0),e([a()],E.prototype,"_containerPosTop",void 0),e([a()],E.prototype,"_levelsContainer",void 0),E=e([v("esri.widgets.BuildingExplorer.BuildingLevelPicker.BuildingLevelPicker")],E);const M=E;export{M as default};
