/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import e from"../../../../core/Accessor.js";import has from"../../../../core/has.js";import{destroyMaybe as s,isNone as i}from"../../../../core/maybe.js";import{property as r}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import{subclass as n}from"../../../../core/accessorSupport/decorators/subclass.js";import{PooledRBush as o}from"../../../../core/libs/rbush/PooledRBush.js";import{fromRect as a}from"../../../../geometry/support/aaBoundingBox.js";import{getObjectId as d}from"../../../../layers/graphics/dehydratedFeatures.js";let c=class extends e{constructor(t){super(t),this._index=new o(9,has("esri-csp-restrictions")?t=>({minX:t.extent[0],minY:t.extent[1],maxX:t.extent[2],maxY:t.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(t){this._addMany(t)}destroy(){this._missing.clear(),this._index=s(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(t,e,s){!i(e)&&e.equals(this.spatialReference)&&(u.minX=t[0],u.minY=t[1],u.maxX=t[2],u.maxY=t[3],this.update(),this._index.search(u,(t=>s(t.graphic.uid))))}add(t){this._missing.add(t),this.updating=!0}remove(t){if(this._missing.delete(t))return void(this.updating=this._missing.size>0);this._index.remove(t);const e=d(t.graphic,this._get("objectIdField"));null!=e&&this._boundsByFeature.delete(e)}_addMany(t){if(0===t.length)return;const e=this._get("objectIdField");for(const s of t){s.computeExtent(this.spatialReference);const t=d(s.graphic,e);null!=t&&this._boundsByFeature.set(t,s.extent)}this._index.load(t)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(t,e){u.minX=t[0],u.minY=t[1],u.maxX=t[2],u.maxY=t[3],this.update(),this._index.search(u,(t=>{e(t)}))}getBounds(t,e){this.update();const s=this._boundsByFeature.get(t);return s?a(e,s):null}};t([r({constructOnly:!0})],c.prototype,"spatialReference",void 0),t([r({constructOnly:!0})],c.prototype,"hasZ",void 0),t([r({constructOnly:!0})],c.prototype,"hasM",void 0),t([r({constructOnly:!0})],c.prototype,"objectIdField",void 0),t([r()],c.prototype,"updating",void 0),t([r({readOnly:!0})],c.prototype,"updatingRemaining",null),c=t([n("esri.views.3d.layers.graphics.SpatialIndex2D")],c);const u={minX:0,minY:0,maxX:0,maxY:0};export{c as SpatialIndex2D};
