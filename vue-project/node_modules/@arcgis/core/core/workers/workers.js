/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
import r from"../Error.js";import has from"../has.js";import{throwIfAborted as t}from"../promiseUtils.js";import e from"./Connection.js";import n from"./RemoteClient.js";import o from"./WorkerOwner.js";let i=has("esri-workers-debug")?1:has("esri-mobile")?Math.min(navigator.hardwareConcurrency-1,3):has("host-browser")?navigator.hardwareConcurrency-1:0;i||(i=has("safari")&&has("mac")?7:2);let a=0;const s=[];function c(){d()}function l(r,t){return m(r,{client:t})}async function m(r,t){const n=new e;return await n.open(r,t),n}async function u(e,o={}){if("string"!=typeof e)throw new r("workers:undefined-module","modulePath is missing");let c=o.strategy||"distributed";if(has("host-webworker")&&!has("esri-workers")&&(c="local"),"local"===c){let r=await n.loadWorker(e);r||(r=await import(/* @vite-ignore */ /* webpackIgnore: true */e)),t(o.signal);const i=o.client||r;return m([n.connect(r)],{...o,client:i})}if(await d(),t(o.signal),"dedicated"===c){const r=a++%i;return m([await s[r].open(e,o)],o)}if(o.maxNumWorkers&&o.maxNumWorkers>0){const r=Math.min(o.maxNumWorkers,i);if(r<i){const t=new Array(r);for(let n=0;n<r;++n){const r=a++%i;t[n]=s[r].open(e,o)}return m(t,o)}}return m(s.map((r=>r.open(e,o))),o)}function f(){p&&(w.abort(),p=null);for(let r=0;r<s.length;r++)s[r]&&s[r].terminate();s.length=0}let w,p=null;async function d(){if(p)return p;w=new AbortController;const r=[];for(let t=0;t<i;t++){const e=o.create(t).then((r=>(s[t]=r,r)));r.push(e)}return p=Promise.all(r),p}export{e as Connection,n as RemoteClient,c as initialize,u as open,l as openWithPorts,f as terminate};
