{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/mixins/PortalLayer.js"],
  "sourcesContent": ["/*\r\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\r\nSee https://js.arcgis.com/4.26/esri/copyright.txt for details.\r\n*/\r\nimport{_ as t}from\"../../chunks/tslib.es6.js\";import e from\"../../config.js\";import{id as r}from\"../../kernel.js\";import s from\"../../request.js\";import{result as i}from\"../../core/asyncUtils.js\";import o from\"../../core/Error.js\";import a from\"../../core/Logger.js\";import{destroyMaybe as l,isSome as p,isNone as n}from\"../../core/maybe.js\";import{throwIfAborted as u,isAbortError as c,throwIfAbortError as d}from\"../../core/promiseUtils.js\";import{hasSameCanonicalPortal as m,normalize as h,hasSamePortal as f}from\"../../core/urlUtils.js\";import{property as y}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/accessorSupport/ensureType.js\";import\"../../core/arrayUtils.js\";import{reader as g}from\"../../core/accessorSupport/decorators/reader.js\";import{subclass as I}from\"../../core/accessorSupport/decorators/subclass.js\";import{writer as v}from\"../../core/accessorSupport/decorators/writer.js\";import{getOwningPortalUrl as P}from\"../support/layerUtils.js\";import U from\"../../portal/Portal.js\";import w from\"../../portal/PortalItem.js\";import j from\"../../portal/PortalUser.js\";import{getUserPrivileges as E}from\"../../portal/support/portalItemUtils.js\";const _=_=>{let H=class extends _{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1}destroy(){this.portalItem=l(this.portalItem)}set portalItem(t){t!==this._get(\"portalItem\")&&(this.removeOrigin(\"portal-item\"),this._set(\"portalItem\",t))}readPortalItem(t,e,r){if(e.itemId)return new w({id:e.itemId,portal:r&&r.portal})}writePortalItem(t,e){t&&t.id&&(e.itemId=t.id)}async loadFromPortal(t,e){if(this.portalItem&&this.portalItem.id)try{const r=await import(\"../../portal/support/layersLoader.js\");return u(e),await r.load({instance:this,supportedTypes:t.supportedTypes,validateItem:t.validateItem,supportsData:t.supportsData,layerModuleTypeMap:t.layerModuleTypeMap},e)}catch(r){throw c(r)||a.getLogger(this.declaredClass).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\\n  ${r}`),r}}async finishLoadEditablePortalLayer(t){this._set(\"userHasEditingPrivileges\",await this._fetchUserHasEditingPrivileges(t).catch((t=>(d(t),!0))))}async _setUserPrivileges(t,r){if(!e.userPrivilegesApplied)return this.finishLoadEditablePortalLayer(r);if(this.url)try{const{features:{edit:e,fullEdit:s},content:{updateItem:i}}=await this._fetchUserPrivileges(t,r);this._set(\"userHasEditingPrivileges\",e),this._set(\"userHasFullEditingPrivileges\",s),this._set(\"userHasUpdateItemPrivileges\",i)}catch(s){d(s)}}async _fetchUserPrivileges(t,e){let s=this.portalItem;if(!t||!s||!s.loaded||s.sourceUrl)return this._fetchFallbackUserPrivileges(e);const i=t===s.id;if(i&&s.portal.user)return E(s);let o,a;if(i)o=s.portal.url;else try{o=await P(this.url,e)}catch(c){d(c)}if(!o||!m(o,s.portal.url))return this._fetchFallbackUserPrivileges(e);try{const t=p(e)?e.signal:null;a=await(r?.getCredential(`${o}/sharing`,{prompt:!1,signal:t}))}catch(c){d(c)}const l=!0,n=!1,u=!1;if(!a)return{features:{edit:l,fullEdit:n},content:{updateItem:u}};try{if(i?await s.reload():(s=new w({id:t,portal:{url:o}}),await s.load(e)),s.portal.user)return E(s)}catch(c){d(c)}return{features:{edit:l,fullEdit:n},content:{updateItem:u}}}async _fetchFallbackUserPrivileges(t){let e=!0;try{e=await this._fetchUserHasEditingPrivileges(t)}catch(r){d(r)}return{features:{edit:e,fullEdit:!1},content:{updateItem:!1}}}async _fetchUserHasEditingPrivileges(t){const e=this.url?r?.findCredential(this.url):null;if(!e)return!0;const s=b.credential===e?b.user:await this._fetchEditingUser(t);return b.credential=e,b.user=s,n(s)||null==s.privileges||s.privileges.includes(\"features:user:edit\")}async _fetchEditingUser(t){const e=this.portalItem?.portal?.user;if(e)return e;const o=r.findServerInfo(this.url??\"\");if(!o?.owningSystemUrl)return null;const a=`${o.owningSystemUrl}/sharing/rest`,l=U.getDefault();if(l&&l.loaded&&h(l.restUrl)===h(a))return l.user;const n=`${a}/community/self`,u=p(t)?t.signal:null,c=await i(s(n,{authMode:\"no-prompt\",query:{f:\"json\"},signal:u}));return c.ok?j.fromJSON(c.value.data):null}read(t,e){e&&(e.layer=this),super.read(t,e)}write(t,e){const r=e&&e.portal,s=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||U.getDefault());return r&&s&&!f(s.restUrl,r.restUrl)?(e.messages&&e.messages.push(new o(\"layer:cross-portal\",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(t,{...e,layer:this})}};return t([y({type:w})],H.prototype,\"portalItem\",null),t([g(\"web-document\",\"portalItem\",[\"itemId\"])],H.prototype,\"readPortalItem\",null),t([v(\"web-document\",\"portalItem\",{itemId:{type:String}})],H.prototype,\"writePortalItem\",null),t([y({clonable:!1})],H.prototype,\"resourceReferences\",void 0),t([y({type:Boolean,readOnly:!0})],H.prototype,\"userHasEditingPrivileges\",void 0),t([y({type:Boolean,readOnly:!0})],H.prototype,\"userHasFullEditingPrivileges\",void 0),t([y({type:Boolean,readOnly:!0})],H.prototype,\"userHasUpdateItemPrivileges\",void 0),H=t([I(\"esri.layers.mixins.PortalLayer\")],H),H},b={credential:null,user:null};export{_ as PortalLayer};\r\n"],
  "mappings": "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",
  "names": ["_", "t", "e", "r", "s", "o", "a", "b", "l"]
}
